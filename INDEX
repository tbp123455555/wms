<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alternative Brewing - Warehouse Management</title> <script src="/js/html5-qrcode.min.js"></script>

<!-- ALL STYLES HERE -->
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f6f3; }
.header { 
    background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); 
    padding: 20px 40px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    border-bottom: 3px solid #c62828; 
}
h1 { 
    color: #ffffff; 
    font-size: 24px; 
    margin-bottom: 15px; 
    font-weight: 700;
}
.stats { display: flex; gap: 16px; flex-wrap: wrap; }
.stat-box { background: rgba(255, 255, 255, 0.1); padding: 10px 18px; border-radius: 8px; font-size: 13px; color: #ffffff; }
.container { max-width: 1600px; margin: 0 auto; padding: 24px 40px; }
.tabs { 
    display: flex; 
    gap: 12px; 
    margin-bottom: 24px; 
    flex-wrap: wrap; 
    border-bottom: 2px solid #e0d8cc;
    overflow-x: visible;
}

#holdBaySuggestions div:hover {
  background: #f0f0f0;
}


@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
        gap: 0;
        border-bottom: none;
    }
    
    .tab {
        width: 100%;
        border-radius: 0;
        border: 2px solid #e0d8cc;
        border-bottom: none;
        margin-bottom: 0;
        padding: 16px 20px;
        font-size: 16px;
        min-height: 52px; /* Better touch target */
    }
    
    .dropdown {
        display: block;
        width: 100%;
        margin-bottom: 0;
    }
    
    .dropdown-toggle {
        width: 100%;
        justify-content: space-between;
        border-radius: 0;
        border: 2px solid #e0d8cc;
        border-bottom: none;
        margin-bottom: 0;
        padding: 16px 20px;
        font-size: 16px;
        display: flex !important;
        min-height: 52px; /* Better touch target */
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
    }
    
    /* Make the arrow rotate when open */
    .dropdown.open .dropdown-toggle span {
        transform: rotate(180deg);
        display: inline-block;
        transition: transform 0.2s;
    }
    
    .tabs > *:last-child .dropdown-toggle,
    .tabs > .tab:last-of-type {
        border-bottom: 2px solid #e0d8cc;
    }
    
    .dropdown-content {
        display: none; /* HIDDEN BY DEFAULT */
        position: relative;
        box-shadow: none;
        border: 2px solid #e0d8cc;
        border-top: none;
        border-radius: 0;
        margin-top: 0;
        width: 100%;
        min-width: 100%;
        background: #f9f9f9;
        flex-direction: column;
    }
    
    .dropdown-content button {
        width: 100%;
        padding: 16px 30px;
        font-size: 15px;
        background: #f9f9f9;
        border-left: 4px solid transparent;
        text-align: left;
        display: block;
        white-space: normal;
        min-height: 52px; /* Better touch target */
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    .dropdown-content button:hover,
    .dropdown-content button:active {
        background: #f5f0e8;
        border-left: 4px solid #c62828;
    }
    
    /* SHOW DROPDOWN WHEN OPEN CLASS IS ADDED */
    .dropdown.open .dropdown-content {
        display: flex !important;
        flex-direction: column;
    }
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(198, 40, 40, 0.7);
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 0 10px rgba(198, 40, 40, 0);
    }
}

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
.tab { padding: 12px 24px; background: #ffffff; border: 2px solid #e0d8cc; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; color: #2c2c2c; border-bottom: none; }
.tab:hover { background: #f5f0e8; }
.tab.active { background: #c62828; color: white; transform: translateY(2px); }
.content { background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.view { display: none; }
.view.active { display: block; }
.btn { padding: 12px 24px; background: #c62828; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
.btn:hover { background: #a82222; }
.btn-secondary { background: #6b7280; }
.btn-danger { background: #dc2626; }
.btn-small { padding: 8px 16px; font-size: 13px; }
.search-box { width: 100%; padding: 14px; font-size: 15px; border: 2px solid #e0d8cc; border-radius: 8px; margin-bottom: 24px; }
.result-item { padding: 16px; background: #fefdfb; border-radius: 10px; margin-bottom: 12px; border: 2px solid #e0d8cc; border-left: 4px solid #c62828; cursor: pointer; }
.aisle-card { background: #fefdfb; border: 2px solid #e0d8cc; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; display: inline-block; margin: 10px; min-width: 150px; }
.aisle-card:hover { border-color: #c62828; transform: translateY(-2px); }
.aisle-card.selected { border-color: #c62828; background: #fff5f5; }
.bay-cell { display: inline-block; padding: 12px 8px; margin: 4px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 11px; min-width: 70px; }
.bay-cell.empty { background: #e5e7eb; color: #4b5563; border: 2px solid #d1d5db; }
.bay-cell.occupied { background: #d1fae5; color: #065f46; border: 2px solid #10b981; font-weight: 600; }
.bay-cell.on_hold { 
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b; 
    border: 2px solid #ef4444; 
    cursor: pointer;
    font-weight: 700;
    position: relative;
}

.bay-cell.on_hold::after {
    content: 'ğŸ”’';
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 16px;
}

.bay-cell.on_hold:hover { 
    background: linear-gradient(135deg, #fecaca 0%, #fee2e2 100%);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); 
    transform: translateY(-2px); 
}
.bay-cell:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-1px); }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: white; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; }
.modal-close { 
    position: absolute; 
    top: 15px; 
    right: 15px; 
    background: #c62828; 
    color: white; 
    border: none; 
    border-radius: 50%; 
    width: 50px;
    height: 50px;
    font-size: 28px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: all 0.2s;
    z-index: 1001;
}

.modal-close:hover {
    background: #a82222;
    transform: scale(1.1);
}

.modal-close:active {
    transform: scale(0.95);
}

.location-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin: 4px; }
.location-badge.pallet { background: #dbeafe; color: #1e40af; }
.location-badge.shelf { background: #d1fae5; color: #065f46; }
.location-badge.hold { background: #fef3c7; color: #92400e; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; }
table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0d8cc; }
table th { background: #f5f0e8; font-weight: 600; }
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 8px; font-weight: 600; }
input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0d8cc; border-radius: 8px; }
.autocomplete-suggestion {
    transition: all 0.2s ease;
}
.autocomplete-suggestion:hover {
    background: #f5f0e8 !important;
    transform: translateX(5px);
}
.autocomplete-suggestion.active {
    background: #f5f0e8 !important;
}

/* Highlight matching text */
mark {
    background: #fef3c7;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}
/* Search suggestions container */
#searchSuggestions {
    animation: slideDown 0.2s ease;
}
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.products-mobile-list { display: block; }
.bay-cell.selecting { cursor: pointer; }
.bay-cell.selected { background: #fef3c7 !important; border: 3px solid #f59e0b !important; }

/* Mobile & Tablet Optimization */
@media (max-width: 1024px) {
    .header { padding: 16px 20px; }
    h1 { font-size: 22px; }
    .subtitle { font-size: 12px; }
    .stat-box { font-size: 11px; padding: 8px 12px; }
    .container { padding: 16px 20px; }
    .tabs { gap: 8px; overflow-x: auto; white-space: nowrap; }
    .tab { padding: 14px 18px; font-size: 15px; }
    .hide-mobile { display: none !important; }
    
    .content { padding: 20px; }
    .search-box { padding: 16px; font-size: 16px; }
    .btn { padding: 14px 20px; font-size: 15px; min-height: 48px; }
    .btn-small { padding: 10px 16px; font-size: 14px; min-height: 44px; }
    input, select, textarea { padding: 14px; font-size: 16px; }
    table { font-size: 12px; display: none; }
    table th, table td { padding: 8px 6px; }
    .result-item { padding: 16px; font-size: 15px; }
    .bay-cell { min-width: 80px; padding: 14px 10px; font-size: 13px; margin: 6px; }
    .modal-content { padding: 20px; width: 95%; max-height: 85vh; }
table { font-size: 12px; display: table !important; }
.modal table { display: table !important; width: 100%; }
.modal table th, .modal table td { font-size: 13px; padding: 10px 6px; }
.modal .btn-small { font-size: 13px; padding: 10px 12px; min-height: 40px; }
.modal input, .modal textarea { font-size: 15px; padding: 12px; }
.modal h2 { font-size: 20px; margin-bottom: 10px; }
.modal h3, .modal h4 { font-size: 16px; margin-top: 15px; }
    .aisle-card { min-width: 140px; padding: 16px; }
}

@media (max-width: 768px) {
    h1 { font-size: 20px; }
    .stats { flex-direction: column; }
    .stat-box { width: 100%; }
    .tabs { flex-direction: column; }
    .tab { width: 100%; text-align: center; }
    .bay-cell { min-width: 70px; padding: 12px 8px; font-size: 12px; }
    .result-item { font-size: 16px !important; }
    .search-box { font-size: 18px; }
}

/* Larger touch targets for mobile */
@media (hover: none) and (pointer: coarse) {
    .btn { min-height: 50px; }
    .bay-cell { padding: 16px 12px; }
    .tab { padding: 16px 20px; }
}
/* Print styles for labels */
@media print {
    body * { visibility: hidden; }
    #labelPreview, #labelPreview * { visibility: visible; }
    #labelPreview { 
        position: absolute; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    #labelPreview > div {
        width: 80% !important;
        height: 80% !important;
        max-width: none !important;
        page-break-after: avoid;
    }
    button { display: none !important; }
}
/* Dropdown Menu Styles */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-toggle {
    padding: 12px 24px;
    background: #ffffff;
    border: 2px solid #e0d8cc;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 14px;
    color: #2c2c2c;
    border-bottom: none;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dropdown-toggle:hover {
    background: #f5f0e8;
}

.dropdown-toggle.active {
    background: #c62828;
    color: white;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 1000;
    border-radius: 0 8px 8px 8px;
    border: 2px solid #e0d8cc;
    margin-top: -2px;
}

.dropdown-content button {
    width: 100%;
    padding: 12px 20px;
    text-align: left;
    border: none;
    background: white;
    cursor: pointer;
    font-size: 14px;
    color: #2c2c2c;
    border-bottom: 1px solid #f0f0f0;
}

.dropdown-content button:hover {
    background: #f5f0e8;
}

.dropdown-content button:last-child {
    border-bottom: none;
    border-radius: 0 0 8px 8px;
}

/* Visual separation between operational and admin dropdowns */
.dropdown:last-of-type {
    border-left: 2px solid rgba(255,255,255,0.2);
    padding-left: 12px;
    margin-left: 8px;
}

@media (max-width: 768px) {
    .dropdown:last-of-type {
        border-left: none;
        border-top: 3px solid #e0d8cc;
        padding-left: 0;
        margin-left: 0;
        padding-top: 0;
    }
}

/* Desktop - hover to show */
@media (min-width: 769px) {
    .dropdown:hover .dropdown-content {
        display: block;
    }
}

@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
        gap: 0;
        border-bottom: none;
    }
    
    .tab {
        width: 100%;
        border-radius: 0;
        border: 2px solid #e0d8cc;
        border-bottom: none;
        margin-bottom: 0;
        padding: 16px 20px;
        font-size: 16px;
    }
    
    .dropdown {
        display: block;
        width: 100%;
        margin-bottom: 0;
    }
    
    .dropdown-toggle {
        width: 100%;
        justify-content: space-between;
        border-radius: 0;
        border: 2px solid #e0d8cc;
        border-bottom: none;
        margin-bottom: 0;
        padding: 16px 20px;
        font-size: 16px;
        display: flex !important;
    }
    
    .tabs > *:last-child .dropdown-toggle,
    .tabs > .tab:last-of-type {
        border-bottom: 2px solid #e0d8cc;
    }
    
    .dropdown-content {
        display: none; /* HIDDEN BY DEFAULT */
        position: relative;
        box-shadow: none;
        border: 2px solid #e0d8cc;
        border-top: none;
        border-radius: 0;
        margin-top: 0;
        width: 100%;
        min-width: 100%;
        background: #f9f9f9;
        flex-direction: column;
    }
    
    .dropdown-content button {
        width: 100%;
        padding: 16px 30px;
        font-size: 15px;
        background: #f9f9f9;
        border-left: 4px solid transparent;
        text-align: left;
        display: block;
        white-space: normal;
    }

@media (max-width: 768px) {
    /* Make dropdown items easier to read on mobile */
    .dropdown-content button {
        padding-left: 40px; /* More indent for clearer hierarchy */
        position: relative;
    }
    
    .dropdown-content button:before {
        content: 'â””';
        position: absolute;
        left: 20px;
        color: #999;
        font-size: 18px;
    }
    
    .dropdown-content button:hover,
    .dropdown-content button:active {
        background: #f5f0e8;
        border-left: 4px solid #c62828;
    }
    
    /* SHOW DROPDOWN WHEN OPEN CLASS IS ADDED */
    .dropdown.open .dropdown-content {
        display: flex;
        flex-direction: column;
    }
}
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

/* Print styles for labels */
@media print {
    body * { visibility: hidden; }
    .label-container, .label-container * { 
        visibility: visible !important; 
    }
    .label-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .no-print {
        display: none !important;
        visibility: hidden !important;
    }
    button {
        display: none !important;
    }
}

/* Your existing styles above... */

/* Allocation Queue Styling */
.allocation-item {
    transition: all 0.3s ease;
}

.allocation-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.location-suggestions {
    position: relative;
}

.autocomplete-suggestion:hover {
    background: #f5f0e8 !important;
}

/* Tab badge animation */
.tab span {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>
</head>
<body>
<div class="header">
    <h1>Alternative Brewing - Warehouse Management</h1>
    <div class="stats" id="stats">Loading...</div>
</div>
<div id="offlineStatus" style="display:none;background:#fef3c7;border-left:4px solid #f59e0b;padding:10px;margin:10px 40px;border-radius:5px">
    <strong>âš ï¸ ShipStation Offline Mode</strong><br>
    <span style="font-size:13px">Changes are being queued. <span id="queueCount">0</span> updates pending sync.</span>
    <button onclick="syncQueue()" style="margin-left:10px;padding:5px 10px;background:#059669;color:white;border:none;border-radius:5px;cursor:pointer">ğŸ”„ Try Sync Now</button>
</div>

</div>
<div class="tabs">
    <!-- MAIN OPERATIONAL TABS -->
    <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
    <button class="tab" onclick="switchTab('search')">ğŸ” Search</button>
    <button class="tab" onclick="switchTab('map')">ğŸ—ºï¸ Map</button>
    <button class="tab" onclick="switchTab('build-pallet')">ğŸ”¨ Build Pallets</button>
    
    <!-- WAREHOUSE DROPDOWN -->
    <div class="dropdown">
        <div class="dropdown-toggle" id="warehouse-toggle">
            ğŸ“¦ Warehouse <span>â–¼</span>
        </div>
        <div class="dropdown-content">
            <button onclick="switchTab('products')">ğŸ“¦ Products</button>
            <button onclick="switchTab('bundles')">ğŸ“š Bundles</button>
            <button onclick="switchTab('allocate')" id="allocate-tab-btn">ğŸ“ Allocate</button>
            <button onclick="switchTab('receiving')">ğŸ“¥ Receiving</button>
            <button onclick="switchTab('cyclecount')">ğŸ“Š Cycle Count</button>
        </div>
    </div>
    
    <!-- ADMIN DROPDOWN -->
    <div class="dropdown">
        <div class="dropdown-toggle" id="admin-toggle">
            âš™ï¸ Admin <span>â–¼</span>
        </div>
        <div class="dropdown-content">
            <button onclick="switchTab('reports')">ğŸ“Š Reports</button>
            <button onclick="switchTab('analytics')">ğŸ“ˆ Analytics</button>
            <button onclick="switchTab('labels')">ğŸ·ï¸ Labels</button>
            <button onclick="switchTab('admin')">ğŸ”§ Settings</button>
        </div>
    </div>
</div>

<button id="scrollTopBtn" onclick="scrollToTop()" style="display:none;position:fixed;bottom:20px;right:20px;background:#c62828;color:white;border:none;border-radius:50%;width:56px;height:56px;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:999">â†‘</button>
<div id="bay-modal" class="modal">
<div class="modal-content">
<button class="modal-close" onclick="closeModal('bay-modal')">Ã—</button>
<div id="bay-details"></div>
</div>
</div>
<div id="quick-edit-modal" class="modal">
    <div class="modal-content" style="max-width:700px">
        <button class="modal-close" onclick="closeModal('quick-edit-modal')">Ã—</button>
        <div id="quick-edit-content"></div>
    </div>
</div>
<div class="content">
<div id="dashboard" class="view active">
<h2>Dashboard</h2>
<div id="dashboard-content">Loading...</div>
</div>
<div id="products" class="view">
    <h2>Products - Shelf Locations</h2>
    <p style="background:#d1fae5;padding:15px;border-radius:8px;margin-bottom:20px;font-size:14px">
        <strong>ğŸ“š Shelf Home Locations:</strong> Primary picking locations for each product. Pallet overflow is shown in product details.
    </p>
    
    <input type="text" 
           id="productsSearch" 
           class="search-box" 
           placeholder="ğŸ” Search by SKU or product name..." 
           oninput="searchProducts()"
           style="margin-bottom:20px">
    
    <div id="productsResults"></div>
</div>

<div id="allocate" class="view">
    <h2>ğŸ“¦ Stock Allocation Queue</h2>
    <p style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:20px">
        <strong>â„¹ï¸ These products were imported from ShipStation but don't have warehouse locations yet.</strong><br>
        Assign them to pallet bays or shelf locations, or archive items you don't stock.
    </p>

    <div style="display:flex;gap:15px;margin-bottom:20px;align-items:center">
        <input type="text" id="allocateSearch" placeholder="ğŸ” Search SKU or product name..." 
            style="flex:1;padding:12px;font-size:15px" oninput="filterAllocationQueue()">
        <button class="btn" onclick="loadAllocationQueue()" style="padding:12px 20px">ğŸ”„ Refresh</button>
    </div>

    <div id="allocationStats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px"></div>

    <div id="allocationQueue"></div>
</div>

<div id="search" class="view">
<h2>Quick Lookup</h2>
<p style="background:#dbeafe;padding:15px;border-radius:8px;margin-bottom:20px;font-size:15px">
<strong>ğŸ“¦ Scan or Search:</strong> Enter SKU or location code
</p>

<!-- SEARCH INPUT WITH AUTOCOMPLETE -->
<div style="position:relative;margin-bottom:20px">
    <input type="text" 
           id="searchInput" 
           class="search-box" 
           placeholder="Type SKU, Product Name, or Location..." 
           oninput="handleSearchInput()" 
           onkeypress="if(event.key==='Enter'){performSearch();event.preventDefault();}" 
           style="font-size:20px;padding:18px" 
           autocomplete="off"
           autofocus>
    
    <!-- AUTOCOMPLETE DROPDOWN -->
    <div id="searchSuggestions" 
         style="display:none;
                position:absolute;
                background:white;
                border:2px solid #e0d8cc;
                border-radius:8px;
                max-height:400px;
                overflow-y:auto;
                width:100%;
                z-index:1000;
                box-shadow:0 8px 24px rgba(0,0,0,0.15);
                margin-top:5px">
    </div>
</div>

<button class="btn" onclick="performSearch()" style="width:100%;margin-top:10px;font-size:18px">Search</button>

<div id="searchResults"></div>
</div>

<div id="map" class="view">
    <h2>Visual Bay Map</h2>
    
    <!-- Search & Filter Bar -->
    <div style="background:#f9fafb;padding:20px;border-radius:10px;margin-bottom:20px">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:15px;margin-bottom:15px">
            <!-- Search Box -->
            <div style="position:relative">
                <input type="text" 
                       id="mapSearchInput" 
                       placeholder="ğŸ” Search SKU, Product, or Bay location..." 
                       style="width:100%;padding:12px;font-size:15px;border:2px solid #e5e7eb;border-radius:8px"
                       oninput="searchMap()">
            </div>
            
            <!-- Bay Number Filter -->
            <input type="number" 
                   id="bayNumberFilter"
                   placeholder="Filter by bay #" 
                   onchange="filterByBay(this.value)" 
                   style="padding:12px;border:2px solid #e5e7eb;border-radius:8px">
            
            <!-- Status Filter -->
            <select id="statusFilter" 
                    onchange="filterByStatus(this.value)"
                    style="padding:12px;border:2px solid #e5e7eb;border-radius:8px">
                <option value="">All Bays</option>
                <option value="empty">Empty Only</option>
                <option value="occupied">Occupied Only</option>
                <option value="on_hold">On Hold Only</option>
            </select>
        </div>
        
        <!-- Bulk Actions -->
        <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="startBulkAdd()">
                ğŸ“¦ Bulk Add SKU
            </button>
            <button class="btn btn-secondary" onclick="clearBulkSelection()" style="display:none" id="clearBulkBtn">
                âœ• Clear Selection
            </button>
            <button class="btn btn-secondary" onclick="clearMapFilters()">
                ğŸ”„ Reset Filters
            </button>
        </div>
    </div>
    
    <!-- Search Results -->
    <div id="mapSearchResults" style="display:none;background:#fffbeb;padding:15px;border-radius:8px;margin-bottom:15px"></div>
    
    <!-- Bulk Add Status -->
    <div id="bulkAddStatus" style="background:#dbeafe;padding:15px;border-radius:8px;margin-bottom:15px;display:none"></div>
    
    <!-- Aisle Selection -->
    <div id="aisle-cards"></div>
    
    <!-- Bay Grid -->
    <div id="bay-grid" style="margin-top:20px"></div>
</div>

<div id="bundles" class="view">
    <h2>Bundles</h2>
    <p style="background:#dbeafe;padding:15px;border-radius:8px;margin-bottom:20px;font-size:14px">
        <strong>ğŸ“š Product Bundles:</strong> View bundle components and their warehouse locations
    </p>
    
    <input type="text" 
           class="search-box" 
           placeholder="ğŸ” Search bundles by code or name..." 
           oninput="searchBundles(this.value)"
           style="margin-bottom:20px">
    
    <div id="bundlesList"></div>
</div><div id="build-pallet" class="view">
    <div class="content-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2>ğŸ”¨ Build Pallet - Staging Area</h2>
        <button class="btn" onclick="createNewPallet()">+ New Pallet</button>
    </div>
    
    <div id="staging-pallets-list" style="margin-top:20px">
        <p style="text-align:center;padding:40px;color:#666">Loading pallets...</p>
    </div>
    
    <div style="margin-top:30px;padding:20px;background:#f5f0e8;border-radius:8px">
        <h3>ğŸ’¡ How it works:</h3>
        <ol style="margin:10px 0 0 20px;line-height:1.8">
            <li><strong>Create a pallet</strong> - Start building without choosing a bay</li>
            <li><strong>Add SKUs</strong> - Search and add items with quantities</li>
            <li><strong>Get smart suggestions</strong> - System suggests best bay based on shelf locations</li>
            <li><strong>Assign to bay</strong> - All items move to the bay at once</li>
        </ol>
    </div>
</div>

<div id="labels" class="view"><h2>Print Labels</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div style="background:#f5f0e8;padding:20px;border-radius:10px"><h3>Bay Label</h3><div class="form-group"><label>Aisle</label><select id="labelAisle"><option>AA</option><option>BB</option><option>CC</option><option>DD</option><option>EE</option><option>FF</option></select></div><div class="form-group"><label>Bay</label><input type="number" id="labelBay" min="1" max="48"></div><div class="form-group"><label>Height</label><select id="labelHeight"><option>2</option><option>3</option><option>4</option></select></div><button class="btn" onclick="printBayLabel()">Generate</button></div><div style="background:#fef3c7;padding:20px;border-radius:10px"><h3>Custom Label</h3><div class="form-group"><label>Location</label><input type="text" id="customLabel" placeholder="HOLD-001"></div><button class="btn" onclick="printCustomLabel()">Generate</button></div><div style="background:#e0f2fe;padding:20px;border-radius:10px;grid-column:1/-1"><h3>Pallet Contents Label</h3><div class="form-group"><label>Bay Location</label><input type="text" id="palletLocation" placeholder="AA-05-4"></div><button class="btn" onclick="printPalletLabel()">Generate Pallet Label</button></div></div></div>

<div id="admin" class="view">
<h2>Admin & Imports</h2>

  <!-- ============================================ -->
    <!-- DATABASE BACKUP SYSTEM -->
    <!-- ============================================ -->
    <div style="background:#e0f2fe;padding:20px;border-radius:10px;margin:10px 0;border:3px solid #0284c7">
        <h3>ğŸ’¾ Database Backup & Restore</h3>
        <p style="font-size:13px;color:#666;margin-bottom:15px">Protect your data! Create backups before major operations.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
            <button class="btn" onclick="createBackup()" style="background:#0284c7">
                ğŸ“¥ Create Backup Now
            </button>
            <button class="btn btn-secondary" onclick="loadBackupList()">
                ğŸ“‹ View All Backups
            </button>
        </div>

        <div id="backupStatus" style="margin-top:10px"></div>
        <div id="backupList" style="display:none;background:white;padding:15px;margin-top:15px;border-radius:8px;max-height:400px;overflow-y:auto"></div>

        <div style="background:#fef3c7;padding:15px;margin-top:15px;border-radius:8px;border-left:4px solid #f59e0b">
            <strong>âš ï¸ Backup Tips:</strong>
            <ul style="font-size:13px;margin:10px 0 0 20px">
                <li>Create a backup before bulk imports or major changes</li>
                <li>Keep at least 7 daily backups</li>
                <li>Download important backups to external storage</li>
                <li>Backups are stored in: <code>C:\WarehouseWMS\backups\</code></li>
            </ul>
        </div>
    </div>

 <!-- ============================================ -->
    <!-- SHIPSTATION INTEGRATION -->
    <!-- ============================================ -->
    <div style="background:#e0f2fe;padding:20px;border-radius:10px;margin:10px 0;border:3px solid #0284c7">
        <h3>ğŸ“¦ ShipStation Integration</h3>
        <p style="font-size:13px;color:#666;margin-bottom:15px">Sync products and locations with ShipStation</p>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
            <button class="btn" onclick="testShipStation()" style="background:#0284c7">
                ğŸ§ª Test Connection
            </button>
            <button class="btn" onclick="syncFromShipStation()" style="background:#059669">
                ğŸ“¥ Import Products from ShipStation
            </button>
        </div>
        
        <div style="background:#fffbeb;padding:15px;margin-top:15px;border-radius:8px;border-left:4px solid #f59e0b">
            <strong>â„¹ï¸ How it works:</strong>
            <ul style="font-size:13px;margin:10px 0 0 20px">
                <li>Test connection verifies API credentials</li>
                <li>Import syncs all products from ShipStation</li>
                <li>Products with warehouse locations are auto-imported</li>
                <li>SKU format AA-01-2 = pallet, anything else = shelf</li>
            </ul>
        </div>
        
        <div id="shipstationStatus" style="margin-top:15px"></div>
    </div>

 <!-- ============================================ -->
    <!-- ARCHIVED SKUs -->
    <!-- ============================================ -->
<div style="background:#f5f5f5;padding:20px;border-radius:10px;margin:10px 0;border:2px solid #dc2626">
    <h3>ğŸ—„ï¸ Archived SKUs</h3>
    <p style="font-size:13px;color:#666;margin-bottom:15px">
        <strong>SKUs blocked from ShipStation imports.</strong><br>
        Archive unwanted SKUs (shipping fees, custom orders) to prevent them from appearing in the allocation queue.
    </p>
    
    <button class="btn" onclick="viewArchivedSKUs()" style="background:#dc2626">
        ğŸ“‹ View Archived SKUs
    </button>
    
    <div style="background:#fef3c7;padding:12px;margin-top:15px;border-radius:5px;border-left:4px solid #f59e0b">
        <strong style="font-size:13px">ğŸ’¡ How it works:</strong>
        <ul style="font-size:12px;margin:8px 0 0 20px;line-height:1.6">
            <li>Archive SKUs from the Allocation Queue to block future imports</li>
            <li>Archived SKUs can be restored if needed</li>
            <li>Permanently blocked SKUs will never import from ShipStation</li>
        </ul>
    </div>
</div>

    <!-- ============================================ -->
    <!-- IMPORT TOOLS -->
    <!-- ============================================ -->
    <div style="background:#f5f0e8;padding:20px;border-radius:10px;margin:10px 0">
        <h3>ğŸ“¥ Import Data</h3>
        
        <!-- Import Shelf Stock -->
        <div style="background:white;padding:15px;margin:10px 0;border-radius:8px">
            <h4>Import Shelf Stock</h4>
            <p style="font-size:13px;color:#666;margin-bottom:10px">
                Format: Location [TAB] SKU [TAB] Product Name [TAB] Quantity
            </p>
            <input type="file" id="shelfFile" accept=".txt,.tsv,.csv" style="margin:10px 0">
            <button class="btn" onclick="importShelf()">Import Shelf Data</button>
        </div>

        <!-- Import Bundles -->
        <div style="background:white;padding:15px;margin:10px 0;border-radius:8px">
            <h4>Import Bundles</h4>
            <p style="font-size:13px;color:#666;margin-bottom:10px">
                Format: Bundle Code [TAB] Bundle Name [TAB] Component SKU [TAB] Quantity Needed
            </p>
            <input type="file" id="bundleFile" accept=".txt,.tsv,.csv" style="margin:10px 0">
            <button class="btn" onclick="importBundles()">Import Bundles</button>
        </div>

        <div id="importStatus" style="margin-top:15px"></div>
    </div>

    <!-- ============================================ -->
    <!-- SYSTEM DIAGNOSTICS -->
    <!-- ============================================ -->
    <div style="background:#fee2e2;padding:20px;border-radius:10px;margin:10px 0">
        <h3>ğŸ”§ System Diagnostics</h3>
        <p style="font-size:13px;color:#666;margin-bottom:15px">
            Find and repair system issues automatically
        </p>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="findStuckHolds()">
                ğŸ” Scan for Issues
            </button>
            <button class="btn btn-danger" onclick="fixStuckHolds()">
                ğŸ”§ Auto-Fix All Issues
            </button>
        </div>
        
        <div id="stuckHoldsResults" style="margin-top:15px"></div>
        
        <div style="background:#fef3c7;padding:15px;margin-top:15px;border-radius:8px;border-left:4px solid #f59e0b">
            <strong>âš ï¸ What this fixes:</strong>
            <ul style="font-size:13px;margin:10px 0 0 20px">
                <li>Orphaned bays stuck in "on_hold" status</li>
                <li>Empty hold locations with no stock</li>
                <li>Stock in wrong database tables</li>
            </ul>
        </div>
    </div>

</div> <!-- Close #admin view -->

<div id="reports" class="view">
<h2>Reports & Exports</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px">
<div style="background:#f5f0e8;padding:20px;border-radius:10px">
<h3>ğŸ“Š Export Full Inventory</h3>
<p style="font-size:13px;color:#666;margin:10px 0">Download complete inventory as CSV file</p>
<button class="btn" onclick="exportInventory()">Export to CSV</button>
</div>
<div style="background:#e0f2fe;padding:20px;border-radius:10px">
<h3>ğŸ“ Stock by Aisle</h3>
<p style="font-size:13px;color:#666;margin:10px 0">View stock breakdown by aisle</p>
<button class="btn" onclick="generateAisleReport()">Generate Report</button>
</div>
<div style="background:#fef3c7;padding:20px;border-radius:10px">
<h3>ğŸ“ˆ Capacity Overview</h3>
<p style="font-size:13px;color:#666;margin:10px 0">Current warehouse utilization</p>
<button class="btn" onclick="generateCapacityReport()">View Capacity</button>
</div>
<div style="background:#fee2e2;padding:20px;border-radius:10px">
<h3>ğŸ” Empty Bays List</h3>
<p style="font-size:13px;color:#666;margin:10px 0">Find available storage locations</p>
<button class="btn" onclick="generateEmptyBaysReport()">Show Empty Bays</button>
</div>
</div>
<div id="reportResults" style="background:white;padding:20px;border-radius:10px;min-height:200px"></div>
</div>

<div id="receiving" class="view">
<h2>ğŸ“¦ Receiving Workflow</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
<div style="background:#d1fae5;padding:20px;border-radius:10px">
<h3>ğŸ“„ Upload PO CSV</h3>
<p style="font-size:13px;color:#666;margin-bottom:10px">Upload CSV with columns: SKU, Quantity</p>
<input type="file" id="receivingCSV" accept=".csv,.txt" style="margin:10px 0">
<button class="btn" onclick="uploadReceivingCSV()">Process CSV</button>
</div>
<div style="background:#dbeafe;padding:20px;border-radius:10px">
<h3>âœï¸ Paste SKUs Manually</h3>
<p style="font-size:13px;color:#666;margin-bottom:10px">One per line: SKU x Quantity</p>
<textarea id="receivingInput" rows="6" placeholder="AP01A x 50
Normcore-WDT-Tool-V3 x 30
RHMJ12OZ x 25" style="width:100%;padding:12px;font-family:monospace"></textarea>
<button class="btn" onclick="processReceiving()">Generate Plan</button>
</div>
</div>
<div id="receivingResults"></div>
</div>
<div id="cyclecount" class="view">
<h2>ğŸ“Š Cycle Count Manager</h2>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">

<!-- Search by SKU -->
<div style="background:#dbeafe;padding:20px;border-radius:10px">
<h3>ğŸ” Count by SKU</h3>
<p style="font-size:13px;color:#666;margin-bottom:10px">Search for a product to count all its locations</p>
<input type="text" id="countSearchSKU" placeholder="Enter SKU or product name..." style="width:100%;padding:12px;margin:10px 0" oninput="searchSKUForCount()">
<div id="skuCountSuggestions" style="background:white;border:2px solid #e0d8cc;border-radius:8px;max-height:200px;overflow-y:auto;margin:10px 0"></div>
<button class="btn" onclick="startSKUCount()">Start Count</button>
</div>

<!-- Count by Aisle -->
<div style="background:#d1fae5;padding:20px;border-radius:10px">
<h3>ğŸ“ Count by Aisle</h3>
<p style="font-size:13px;color:#666;margin-bottom:10px">Count all stock in a specific aisle</p>
<select id="countAisleSelect" style="width:100%;padding:12px;margin:10px 0">
<option value="">Select Aisle...</option>
<option value="AA">Aisle AA</option>
<option value="BB">Aisle BB</option>
<option value="CC">Aisle CC</option>
<option value="DD">Aisle DD</option>
<option value="EE">Aisle EE</option>
<option value="FF">Aisle FF</option>
</select>
<button class="btn" onclick="startAisleCount()">Start Aisle Count</button>
<p style="font-size:12px;color:#666;margin-top:10px">Last counted: <span id="aisleLastCount">Never</span></p>
</div>

</div>

<!-- Count Sheet Area -->
<div id="countSheetArea"></div>

<!-- Accuracy Stats -->
<div id="countStats" style="display:none;background:#f5f0e8;padding:20px;border-radius:10px;margin-top:20px">
<h3>ğŸ“ˆ Accuracy Statistics</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px">
<div style="text-align:center">
<div style="font-size:36px;font-weight:900;color:#059669">--</div>
<div style="font-size:13px;color:#666">Overall Accuracy</div>
</div>
<div style="text-align:center">
<div style="font-size:36px;font-weight:900;color:#2563eb">--</div>
<div style="font-size:13px;color:#666">Items Counted</div>
</div>
<div style="text-align:center">
<div style="font-size:36px;font-weight:900;color:#dc2626">--</div>
<div style="font-size:13px;color:#666">Discrepancies</div>
</div>
</div>
</div>

</div>

</div>
</div>
</div>
<div id="analytics" class="view">
<h2>ğŸ“ˆ Analytics Dashboard</h2>

<!-- Quick Stats Overview -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px">
<div style="background:#dbeafe;padding:25px;border-radius:10px;text-align:center">
<div style="font-size:48px;font-weight:900;color:#1e40af" id="utilizationRate">--</div>
<div style="font-size:14px;color:#666;margin-top:5px">Warehouse Utilization</div>
</div>
<div style="background:#d1fae5;padding:25px;border-radius:10px;text-align:center">
<div style="font-size:48px;font-weight:900;color:#059669" id="totalMovements">--</div>
<div style="font-size:14px;color:#666;margin-top:5px">Movements (30 Days)</div>
</div>
<div style="background:#fef3c7;padding:25px;border-radius:10px;text-align:center">
<div style="font-size:48px;font-weight:900;color:#92400e" id="uniqueSKUs">--</div>
<div style="font-size:14px;color:#666;margin-top:5px">Active SKUs</div>
</div>
<div style="background:#fee2e2;padding:25px;border-radius:10px;text-align:center">
<div style="font-size:48px;font-weight:900;color:#dc2626" id="slowMovers">--</div>
<div style="font-size:14px;color:#666;margin-top:5px">Slow Movers (90+ Days)</div>
</div>
</div>

<!-- Capacity Trend Chart -->
<div style="background:white;padding:25px;border-radius:10px;margin-bottom:30px">
<h3>ğŸ“Š Capacity Trend</h3>
<p style="font-size:13px;color:#666;margin-bottom:15px">Weekly warehouse utilization over time</p>
<div id="capacityTrendChart" style="height:300px;display:flex;align-items:center;justify-content:center;color:#666">
Loading trend data...
</div>
</div>

<!-- Aisle Activity -->
<div style="background:white;padding:25px;border-radius:10px;margin-bottom:30px">
<h3>ğŸ”¥ Aisle Activity (Last 30 Days)</h3>
<p style="font-size:13px;color:#666;margin-bottom:15px">Number of movements per aisle</p>
<div id="aisleActivityChart"></div>
</div>

<!-- Slow Moving Items -->
<div style="background:white;padding:25px;border-radius:10px;margin-bottom:30px">
<h3>ğŸŒ Slow Moving Items</h3>
<p style="font-size:13px;color:#666;margin-bottom:15px">Items not moved in 90+ days - consider relocating</p>
<button class="btn btn-small" onclick="loadSlowMovers()">Refresh Data</button>
<div id="slowMoversTable" style="margin-top:15px"></div>
</div>

<!-- Relocation Suggestions -->
<div style="background:#fff3cd;padding:25px;border-radius:10px">
<h3>ğŸ’¡ Relocation Suggestions</h3>
<p style="font-size:13px;color:#666;margin-bottom:15px">Optimize warehouse layout based on activity</p>
<button class="btn btn-small" onclick="generateRelocationSuggestions()">Generate Suggestions</button>
<div id="relocationSuggestions" style="margin-top:15px"></div>
</div>

</div>
</div>
</div>
<script>
// ============================================
// GLOBAL ERROR HANDLING
// ============================================


// small client fix: accept button element instead of relying on global 'event'
function syncQueue(btnEl) {
  const btn = btnEl;
  btn.disabled = true;
  btn.innerHTML = 'â³ Syncing...';
  fetch(API + '/api/shipstation/queue/process', { method: 'POST' })
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('âœ… Queue processed: ' + (result.processed || 0));
        checkShipStationStatus();
      } else {
        showToast('âŒ Sync failed');
      }
    }).catch(err => {
      showToast('âŒ Error: ' + err.message);
    }).finally(() => {
      btn.disabled = false;
      btn.innerHTML = 'ğŸ”„ Sync Now';
    });
}

// Global error handler
window.addEventListener('error', function(e) {
    console.error('ğŸ”´ JavaScript Error:', {
        message: e.message,
        filename: e.filename,
        line: e.lineno,
        column: e.colno
    });
    
    // Don't show alerts for minor errors
    if (e.message.includes('ResizeObserver') || e.message.includes('fetch')) {
        return;
    }
    
    // Critical errors - show user-friendly message
    if (e.message.includes('Cannot read') || e.message.includes('undefined')) {
        showToast('âš ï¸ Something went wrong. Please refresh the page.', 3000);
    }
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(e) {
    console.error('ğŸ”´ Unhandled Promise Rejection:', e.reason);
    
    // Show user-friendly message for API failures
    if (e.reason && e.reason.message && e.reason.message.includes('fetch')) {
        showToast('âš ï¸ Network error. Please check your connection.', 3000);
    }
});

// Console welcome message
console.log('%cğŸ­ Alternative Brewing WMS', 'font-size:20px;font-weight:bold;color:#c62828');
console.log('%cSystem loaded successfully', 'color:#059669');
console.log('%cVersion: 2.0.0 - Phase 0 Complete', 'color:#666');

// ============================================
// GLOBAL VARIABLES
// ============================================

const API = window.location.origin;
let allBays=[];
let selectedAisle=null;
let allBundles=[];
let allProducts=[];
let bulkAddMode = false;
let selectedBays = [];
let isOnline = true;
let queueCheckInterval = null;

// ============================================
// HELPER FUNCTIONS FOR ESCAPING
// ============================================

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeJs(text) {
  if (!text) return '';
  return String(text)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/"/g, '\\"')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r');
}



function checkShipStationStatus() {
    fetch(API + '/api/shipstation/queue/status')
        .then(r => r.json())
        .then(status => {
            isOnline = status.online;
            const pending = status.queue.pending;
            
            if (!isOnline || pending > 0) {
                document.getElementById('offlineStatus').style.display = 'block';
                document.getElementById('queueCount').textContent = pending;
                
                if (!isOnline) {
                    document.getElementById('offlineStatus').innerHTML = `
                        <strong>âš ï¸ ShipStation Offline</strong><br>
                        <span style="font-size:13px">No internet connection. ${pending} updates queued for sync.</span>
                        <button onclick="syncQueue()" style="margin-left:10px;padding:5px 10px;background:#6b7280;color:white;border:none;border-radius:5px;cursor:pointer">ğŸ”„ Retry</button>`;
                } else {
                    document.getElementById('offlineStatus').innerHTML = `
                        <strong>ğŸ“‹ ShipStation Queue Active</strong><br>
                        <span style="font-size:13px">${pending} updates pending sync.</span>
                        <button onclick="syncQueue()" style="margin-left:10px;padding:5px 10px;background:#059669;color:white;border:none;border-radius:5px;cursor:pointer">ğŸ”„ Sync Now</button>`;
                }
            } else {
                document.getElementById('offlineStatus').style.display = 'none';
            }
        })
        .catch(err => {
            console.error('Status check failed:', err);
        });
}

function syncQueue() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'â³ Syncing...';
    
    fetch(API + '/api/shipstation/queue/process', { method: 'POST' })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (result.processed > 0) {
                    showToast(`âœ… Synced ${result.processed} updates to ShipStation`);
                } else if (result.reason === 'offline') {
                    showToast('âš ï¸ Still offline - will retry automatically');
                } else {
                    showToast('âœ… Queue is empty');
                }
                
                checkShipStationStatus();
            } else {
                showToast('âŒ Sync failed: ' + result.error);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ Sync Now';
        })
        .catch(err => {
            showToast('âŒ Error: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ Sync Now';
        });
}

// Check status every 30 seconds
setInterval(checkShipStationStatus, 30000);

// Check on page load
checkShipStationStatus();

// ============================================
// PALLET BUILDER FUNCTIONS
// ============================================

let currentPalletCode = null;

// Load all staging pallets
function loadStagingPallets() {
    fetch(API + '/api/staging-pallets')
        .then(r => r.json())
        .then(pallets => {
            displayStagingPallets(pallets);
        })
        .catch(err => {
            console.error('Error loading staging pallets:', err);
            document.getElementById('staging-pallets-list').innerHTML = 
                '<p style="color:#dc2626;text-align:center;padding:20px">Error loading pallets</p>';
        });
}

// Display staging pallets list
function displayStagingPallets(pallets) {
    const container = document.getElementById('staging-pallets-list');
    
    if (pallets.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px;color:#666">
                <h3>No active pallets</h3>
                <p>Create a new pallet to start building</p>
                <button class="btn" onclick="createNewPallet()" style="margin-top:20px">+ Create First Pallet</button>
            </div>`;
        return;
    }
    
    let html = `<h3>Active Pallets (${pallets.length})</h3>`;
    
    pallets.forEach(pallet => {
        const itemText = pallet.item_count === 1 ? '1 SKU' : `${pallet.item_count} SKUs`;
        const unitsText = pallet.total_units ? ` â€¢ ${pallet.total_units} units` : '';
        const timeAgo = getTimeAgo(pallet.created_at);
        
        html += `
        <div style="background:white;border:2px solid #e0d8cc;border-radius:8px;padding:20px;margin:10px 0">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
                <div>
                    <h3 style="margin:0;color:#2c5f2d">${pallet.pallet_code}</h3>
                    <p style="color:#666;margin:5px 0;font-size:14px">
                        ğŸ“¦ ${itemText}${unitsText} â€¢ Created ${timeAgo}
                    </p>
                </div>
                <button class="btn-icon" onclick="deleteStagingPallet('${pallet.pallet_code}')" 
                        title="Delete pallet">
                    ğŸ—‘ï¸
                </button>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap">
                <button class="btn btn-secondary" onclick="viewPalletDetails('${pallet.pallet_code}')">
                    ğŸ“‹ View Details
                </button>
                <button class="btn btn-secondary" onclick="addSKUToPallet('${pallet.pallet_code}')">
                    â• Add SKU
                </button>
                ${pallet.item_count > 0 ? `
                <button class="btn" onclick="suggestBay('${pallet.pallet_code}')" style="background:#059669">
                    âœ¨ Suggest Bay
                </button>
                <button class="btn" onclick="manualAssignBay('${pallet.pallet_code}')">
                    ğŸ“ Assign to Bay
                </button>
                ` : ''}
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

async function createNewPallet() {
    // Generate STG-YYYYMMDD-### format
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const dateStr = `${year}${month}${day}`;
    
    // Get existing pallets for today to find next number
    try {
        const response = await fetch(API + '/api/staging-pallets');
        const pallets = await response.json();
        
        // Find pallets from today
        const todayPrefix = `STG-${dateStr}-`;
        const todayPallets = pallets.filter(p => p.pallet_code.startsWith(todayPrefix));
        
        // Find highest number
        let maxNum = 0;
        todayPallets.forEach(p => {
            const match = p.pallet_code.match(/STG-\d{8}-(\d{3})/);
            if (match) {
                const num = parseInt(match[1]);
                if (num > maxNum) maxNum = num;
            }
        });
        
        // Generate next number
        const nextNum = String(maxNum + 1).padStart(3, '0');
        const palletCode = `STG-${dateStr}-${nextNum}`;
        
        console.log('Generated pallet code:', palletCode);
        
        // Show modal with generated code
        const modal = document.getElementById('create-pallet-modal');
        const input = document.getElementById('new-pallet-code');
        
        if (!modal || !input) {
            console.error('Modal elements not found');
            // Fallback: create directly
            createPalletDirectly(palletCode);
            return;
        }
        
        input.value = palletCode;
        modal.classList.add('active');
        
        setTimeout(() => {
            input.select();
        }, 100);
        
    } catch (err) {
        console.error('Error generating pallet code:', err);
        // Fallback to simple timestamp
        const fallbackCode = `STG-${dateStr}-${String(Date.now()).slice(-3)}`;
        document.getElementById('new-pallet-code').value = fallbackCode;
        document.getElementById('create-pallet-modal').classList.add('active');
    }
}

// Helper function to create pallet directly (if modal not found)
function createPalletDirectly(palletCode) {
    fetch(API + '/api/staging-pallets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pallet_code: palletCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… Pallet created: ' + palletCode);
            loadStagingPallets();
            setTimeout(() => addSKUToPallet(palletCode), 300);
        } else {
            alert('âŒ Failed to create pallet: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error creating pallet:', err);
        alert('âŒ Error: ' + err.message);
    });
}

// Save new pallet
function saveNewPallet() {
    const palletCode = document.getElementById('new-pallet-code').value.trim().toUpperCase();
    
    if (!palletCode) {
        alert('âš ï¸ Please enter a pallet code');
        return;
    }
    
    fetch(API + '/api/staging-pallets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pallet_code: palletCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… Pallet created: ' + palletCode);
            closeModal('create-pallet-modal');
            loadStagingPallets();
            
            // Auto-open add SKU modal
            setTimeout(() => addSKUToPallet(palletCode), 300);
        } else {
            alert('âŒ Failed to create pallet: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error creating pallet:', err);
        alert('âŒ Error: ' + err.message);
    });
}

function addSKUToPallet(palletCode) {
    currentPalletCode = palletCode;
    
    // Close other modals first
    closeModal('pallet-details-modal');
    closeModal('bay-suggestions-modal');
    
    const html = `
        <h2>â• Add SKU to ${palletCode}</h2>
        
        <div style="margin:20px 0">
            <label style="display:block;margin-bottom:5px;font-weight:600">Search SKU:</label>
            <input type="text" id="pallet-sku-search" placeholder="Type SKU code or product name..." 
                   style="width:100%;padding:12px;font-size:16px"
                   oninput="searchSKUForPallet()">
            
            <div id="pallet-sku-results" style="margin-top:10px;max-height:300px;overflow-y:auto"></div>
        </div>
        
        <button class="btn btn-secondary" onclick="closeModal('add-sku-modal')">Done</button>
    `;
    
    document.getElementById('add-sku-content').innerHTML = html;
    document.getElementById('add-sku-modal').classList.add('active');
    
    setTimeout(() => {
        document.getElementById('pallet-sku-search').focus();
    }, 100);
}

// Search SKU for adding to pallet
function searchSKUForPallet() {
    const query = document.getElementById('pallet-sku-search').value.trim();
    
    if (query.length < 2) {
        document.getElementById('pallet-sku-results').innerHTML = '';
        return;
    }
    
    // Search all products, not just existing stock
    fetch(API + '/api/products/search?q=' + encodeURIComponent(query))
        .then(r => r.json())
        .then(results => {
            displaySKUResultsForPallet(results);
        })
        .catch(err => {
            console.error('Search error:', err);
        });
}

function displaySKUResultsForPallet(results) {
    const container = document.getElementById('pallet-sku-results');
    
    if (!container) {
        console.error('Pallet SKU results container not found');
        return;
    }
    
    if (results.length === 0) {
        container.innerHTML = '<p style="color:#666;padding:10px">No products found</p>';
        return;
    }
    
    // Clear previous content
    container.innerHTML = '';
    
    results.forEach(product => {
        const safeSku = escapeHtml(product.sku_code);
        const safeName = escapeHtml(product.product_name || 'N/A');
        const uniqueId = 'qty-' + product.sku_code.replace(/[^a-zA-Z0-9]/g, '_');
        
        // Create wrapper div
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'border:1px solid #e0d8cc;border-radius:5px;padding:12px;margin:5px 0;background:white';
        
        itemDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start">
                <div style="flex:1">
                    <strong>${safeSku}</strong><br>
                    <small style="color:#666">${safeName}</small>
                </div>
                <div style="display:flex;gap:10px;align-items:center">
                    <input type="number" 
                           id="${uniqueId}" 
                           value="1" 
                           min="1" 
                           style="width:60px;padding:5px;text-align:center">
                    <button class="btn btn-small add-to-pallet-btn">
                        Add
                    </button>
                </div>
            </div>
        `;
        
        // Get the button and add click handler with closure
        const addBtn = itemDiv.querySelector('.add-to-pallet-btn');
        addBtn.addEventListener('click', function() {
            const qtyInput = document.getElementById(uniqueId);
            const quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
            
            if (quantity <= 0) {
                alert('âš ï¸ Enter a valid quantity');
                return;
            }
            
            // Add to pallet
            fetch(API + '/api/staging-pallets/' + encodeURIComponent(currentPalletCode) + '/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sku_code: product.sku_code,  // Use original product object
                    product_name: product.product_name || '',
                    quantity: quantity
                })
            })
            .then(r => {
                if (!r.ok) throw new Error('Server returned ' + r.status);
                return r.json();
            })
            .then(result => {
                if (result.success) {
                    showToast('âœ… Added ' + quantity + 'x ' + product.sku_code + ' to pallet');
                    document.getElementById('pallet-sku-search').value = '';
                    container.innerHTML = '';
                    loadStagingPallets();
                } else {
                    alert('âŒ Failed: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('âŒ Error: ' + err.message);
            });
        });
        
        container.appendChild(itemDiv);
    });
}


function confirmAddSKUToPallet(skuCode, productName, uniqueId) {
    const qtyInput = document.getElementById(uniqueId);
    const quantity = parseInt(qtyInput.value) || 1;
    
    if (quantity <= 0) {
        alert('âš ï¸ Enter a valid quantity');
        return;
    }
    
    // Add to pallet
    fetch(API + '/api/staging-pallets/' + encodeURIComponent(currentPalletCode) + '/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sku_code: skuCode,
            product_name: productName,
            quantity: quantity
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(result => {
        if (result.success) {
            showToast('âœ… Added ' + quantity + 'x ' + skuCode + ' to pallet');
            document.getElementById('pallet-sku-search').value = '';
            document.getElementById('pallet-sku-results').innerHTML = '';
            loadStagingPallets();
        } else {
            alert('âŒ Failed to add SKU: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error adding SKU:', err);
        alert('âŒ Error: ' + err.message);
    });
}

// New function to handle the click safely
function handleAddSKUClick(button) {
    const sku = button.getAttribute('data-sku');
    const name = button.getAttribute('data-name');
    const uniqueId = 'qty-' + sku.replace(/[^a-zA-Z0-9]/g, '_');
    const qtyInput = document.getElementById(uniqueId);
    
    if (!qtyInput) {
        console.error('Quantity input not found for', sku);
        return;
    }
    
    const quantity = parseInt(qtyInput.value) || 1;
    
    if (quantity <= 0) {
        alert('âš ï¸ Enter a valid quantity');
        return;
    }
    
    // Add to pallet
    fetch(API + '/api/staging-pallets/' + encodeURIComponent(currentPalletCode) + '/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sku_code: sku,
            product_name: name,
            quantity: quantity
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(result => {
        if (result.success) {
            showToast('âœ… Added ' + quantity + 'x ' + sku + ' to pallet');
            document.getElementById('pallet-sku-search').value = '';
            document.getElementById('pallet-sku-results').innerHTML = '';
            loadStagingPallets();
        } else {
            alert('âŒ Failed to add SKU: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error adding SKU:', err);
        alert('âŒ Error: ' + err.message);
    });
}

// Fallback: Add SKU without source location
function addWithoutLocation(skuCode, productName, quantity) {
    fetch(API + '/api/staging-pallets/' + currentPalletCode + '/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sku_code: skuCode,
            product_name: productName,
            quantity: quantity,
            source_location: null
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… Added ' + skuCode + ' (Ã—' + quantity + ')');
            document.getElementById('pallet-sku-search').value = '';
            document.getElementById('pallet-sku-results').innerHTML = '';
            loadStagingPallets();
        } else {
            alert('âŒ Failed to add SKU: ' + (result.error || 'Unknown error'));
        }
    });
}
// View pallet details
function viewPalletDetails(palletCode) {
    fetch(API + '/api/staging-pallets/' + palletCode)
        .then(r => r.json())
        .then(data => {
            displayPalletDetails(data);
        })
        .catch(err => {
            console.error('Error loading pallet details:', err);
            alert('âŒ Error loading pallet details');
        });
}

// Display pallet details
function displayPalletDetails(data) {
    const { pallet, items } = data;
    
    let html = `
        <h2>ğŸ“¦ ${escapeHtml(pallet.pallet_code)}</h2>
        <p style="color:#666">Created: ${new Date(pallet.created_at).toLocaleString()}</p>
        
        <h3 style="margin-top:20px">Contents (${items.length} SKUs):</h3>`;
    
    if (items.length === 0) {
        html += '<p style="color:#666;padding:20px;text-align:center">No items yet</p>';
    } else {
        html += '<div style="max-height:400px;overflow-y:auto">';
        items.forEach(item => {
            html += `
            <div style="border:1px solid #e0d8cc;border-radius:5px;padding:12px;margin:5px 0;background:#f9f9f9">
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div style="flex:1">
                        <strong>${escapeHtml(item.sku_code)}</strong> (Ã—${item.quantity})<br>
                        <small style="color:#666">${escapeHtml(item.product_name || 'N/A')}</small><br>
                        <small style="color:#666">Added: ${new Date(item.created_at || Date.now()).toLocaleString()}</small>
                    </div>
                    <button class="btn-icon" onclick="removeSKUFromPallet('${escapeJs(pallet.pallet_code)}', ${item.id})" 
                            title="Remove">
                        âŒ
                    </button>
                </div>
            </div>`;
        });
        html += '</div>';
    }
    
    html += `
        <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="addSKUToPallet('${escapeJs(pallet.pallet_code)}')">
                â• Add More SKUs
            </button>
            ${items.length > 0 ? `
            <button class="btn" onclick="suggestBay('${escapeJs(pallet.pallet_code)}')" style="background:#059669">
                âœ¨ Suggest Bay
            </button>
            <button class="btn" onclick="manualAssignBay('${escapeJs(pallet.pallet_code)}')">
                ğŸ“ Assign to Bay
            </button>
            ` : ''}
            <button class="btn btn-secondary" onclick="closeModal('pallet-details-modal')">Close</button>
        </div>
    `;
    
    const modalContent = document.getElementById('pallet-details-content');
    if (modalContent) {
        modalContent.innerHTML = html;
        document.getElementById('pallet-details-modal').classList.add('active');
    } else {
        console.error('Modal content element not found');
    }
}
// Remove SKU from pallet
function removeSKUFromPallet(palletCode, itemId) {
    if (!confirm('Remove this SKU from the pallet?')) return;
    
    fetch(API + '/api/staging-pallets/' + palletCode + '/items/' + itemId, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… SKU removed');
            viewPalletDetails(palletCode);
            loadStagingPallets();
        } else {
            alert('âŒ Failed to remove SKU');
        }
    })
    .catch(err => {
        console.error('Error removing SKU:', err);
        alert('âŒ Error: ' + err.message);
    });
}

// Delete staging pallet
function deleteStagingPallet(palletCode) {
    if (!confirm('Delete pallet ' + palletCode + '?\n\nThis will remove the pallet and all its items.')) return;
    
    fetch(API + '/api/staging-pallets/' + palletCode, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… Pallet deleted');
            loadStagingPallets();
        } else {
            alert('âŒ Failed to delete pallet');
        }
    })
    .catch(err => {
        console.error('Error deleting pallet:', err);
        alert('âŒ Error: ' + err.message);
    });
}

// Suggest bay (SMART ALGORITHM)
function suggestBay(palletCode) {
    document.getElementById('bay-suggestions-content').innerHTML = 
        '<h2>âœ¨ Analyzing...</h2><p style="text-align:center;padding:40px">Calculating best bay locations...</p>';
    document.getElementById('bay-suggestions-modal').classList.add('active');
    
    fetch(API + '/api/staging-pallets/' + palletCode + '/suggest-bay', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(result => {
        displayBaySuggestions(palletCode, result);
    })
    .catch(err => {
        console.error('Error getting suggestions:', err);
        document.getElementById('bay-suggestions-content').innerHTML = 
            '<h2>âŒ Error</h2><p>Failed to calculate suggestions</p>';
    });
}

function assignPalletToBay(palletCode, bayLocation) {
    if (!palletCode || !bayLocation) {
        alert('âŒ Missing pallet code or bay location');
        return;
    }
    
    // Validate bay exists
    const bayExists = allBays.find(b => b.location === bayLocation);
    if (!bayExists) {
        alert('âŒ Bay ' + bayLocation + ' does not exist');
        return;
    }
    
    if (!confirm('Assign pallet ' + palletCode + ' to bay ' + bayLocation + '?')) {
        return;
    }
    
    // Show loading state
    document.getElementById('bay-suggestions-content').innerHTML = 
        '<h2>ğŸ“¦ Assigning Pallet...</h2><p style="text-align:center;padding:40px">Please wait...</p>';
    
       fetch(API + '/api/staging-pallets/' + palletCode + '/assign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bay_location: bayLocation })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            document.getElementById('bay-suggestions-content').innerHTML = `
                <div style="text-align:center;padding:40px">
                    <h2 style="color:#059669">âœ… Pallet Assigned!</h2>
                    <p style="font-size:18px;margin:20px 0">
                        <strong>${palletCode}</strong> â†’ <strong>${bayLocation}</strong>
                    </p>
                    <p style="color:#666">All items have been moved to the bay</p>
                    <div style="display:flex;gap:10px;justify-content:center;margin-top:20px">
                        <button class="btn" onclick="viewBay('${bayLocation}')">View Bay</button>
                        <button class="btn btn-secondary" onclick="closeModal('bay-suggestions-modal')">Close</button>
                    </div>
                </div>`;
            
            // Refresh lists
            loadStagingPallets();
            loadBaysData();
            loadStats();
        } else {
            alert('âŒ Assignment failed: ' + (result.error || 'Unknown error'));
            closeModal('bay-suggestions-modal');
        }
    })
    .catch(err => {
        console.error('Assignment error:', err);
        alert('âŒ Error: ' + err.message);
        closeModal('bay-suggestions-modal');
    });
}

// Display bay suggestions
function displayBaySuggestions(palletCode, result) {
    const { suggestions, weightedCenter, dominantAisle, sourceCount } = result;
    
    if (!suggestions || suggestions.length === 0) {
        document.getElementById('bay-suggestions-content').innerHTML = `
            <h2>ğŸ¯ Bay Suggestions</h2>
            <p style="color:#666;padding:20px;text-align:center">
                ${result.message || 'No empty bays available in the optimal area.'}<br>
                Try manual assignment to see all available bays.
            </p>
            <button class="btn" onclick="manualAssignBay('${palletCode}')">ğŸ“ Search Available Bays</button>
            <button class="btn btn-secondary" onclick="closeModal('bay-suggestions-modal')">Cancel</button>
        `;
        return;
    }
    
    let html = `
        <h2>ğŸ¯ Recommended Bay Locations</h2>
        <p style="background:#dbeafe;padding:12px;border-radius:5px;margin:10px 0">
            Based on ${sourceCount} shelf location(s) â€¢ Optimal aisle: <strong>${dominantAisle}</strong>
        </p>
    `;
    
    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
    const labels = ['BEST MATCH', 'Great Match', 'Good Match', 'Alternative', 'Alternative'];
    
    suggestions.forEach((suggestion, idx) => {
        const medal = medals[idx] || 'â€¢';
        const label = labels[idx] || 'Option';
        const isOptimal = suggestion.isOptimalAisle;
        const nearbyNote = !isOptimal ? '<br><small style="color:#f59e0b">âš ï¸ Nearby aisle (optimal aisle full)</small>' : '';
        
        html += `
        <div style="border:2px solid ${idx === 0 ? '#059669' : '#e0d8cc'};border-radius:8px;padding:15px;margin:10px 0;background:${idx === 0 ? '#f0fdf4' : 'white'}">
            <h3 style="margin:0 0 10px 0">${medal} ${label}: ${suggestion.location}</h3>
            <div style="font-size:14px;color:#666;line-height:1.6">
                âœ“ Aisle: ${suggestion.aisle}${isOptimal ? ' (Optimal âœ¨)' : ''} â€¢ Level: ${suggestion.level}${nearbyNote}<br>
                âœ“ Distance from source: ${suggestion.distance !== 'N/A' ? Math.round(suggestion.distance) + ' bays' : 'N/A'}<br>
                âœ“ Match score: ${Math.round(suggestion.score)}/100
            </div>
            <button class="btn" onclick="assignPalletToBay('${palletCode}', '${suggestion.location}')" 
                    style="margin-top:10px;${idx === 0 ? 'background:#059669' : ''}">
                ğŸ“ Assign to ${suggestion.location}
            </button>
        </div>`;
    });
    
    html += `
        <div style="margin-top:20px;display:flex;gap:10px">
            <button class="btn btn-secondary" onclick="manualAssignBay('${palletCode}')">ğŸ” Search Different Bay</button>
            <button class="btn btn-secondary" onclick="closeModal('bay-suggestions-modal')">Cancel</button>
        </div>
    `;
    
    document.getElementById('bay-suggestions-content').innerHTML = html;
}

// Manual assign bay with autocomplete
function manualAssignBay(palletCode) {
    currentPalletCode = palletCode;
    
    const html = `
        <h2>ğŸ“ Assign ${palletCode} to Bay</h2>
        <p style="color:#666;margin:10px 0">Search for an available bay location</p>
        
        <div style="position:relative;margin:20px 0">
            <label style="display:block;margin-bottom:5px;font-weight:600">Bay Location:</label>
            <input type="text" id="bay-search-input" placeholder="Type bay location (e.g., AA-12-2)" 
                   style="width:100%;padding:12px;font-size:16px;text-transform:uppercase"
                   oninput="searchAvailableBays()"
                   autocomplete="off">
            
            <div id="bay-search-results" style="display:none;position:absolute;width:100%;background:white;border:2px solid #e0d8cc;border-radius:5px;max-height:300px;overflow-y:auto;z-index:100;margin-top:5px"></div>
        </div>
        
        <div style="margin-top:20px;display:flex;gap:10px">
            <button class="btn" onclick="confirmManualBayAssignment()">Assign to Bay</button>
            <button class="btn btn-secondary" onclick="closeModal('bay-suggestions-modal')">Cancel</button>
        </div>
        
        <div class="note" style="margin-top:20px">
            ğŸ’¡ Only empty, available bays will appear in search results
        </div>
    `;
    
    document.getElementById('bay-suggestions-content').innerHTML = html;
    document.getElementById('bay-suggestions-modal').classList.add('active');
    
    setTimeout(() => {
        document.getElementById('bay-search-input').focus();
    }, 100);
}

// Search for available bays
function searchAvailableBays() {
    const query = document.getElementById('bay-search-input').value.trim().toUpperCase();
    const resultsDiv = document.getElementById('bay-search-results');
    
    if (query.length < 1) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Search for available bays matching query
    fetch(API + '/api/bays/search-available?q=' + encodeURIComponent(query))
        .then(r => r.json())
        .then(bays => {
            if (bays.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:15px;color:#666">No available bays found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            bays.forEach(bay => {
                html += `
                <div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer;transition:background 0.2s"
                     onmouseover="this.style.background='#f5f0e8'"
                     onmouseout="this.style.background='white'"
                     onclick="selectBayForAssignment('${bay.location}')">
                    <strong style="font-size:16px">${bay.location}</strong>
                    <span style="color:#666;margin-left:10px;font-size:14px">Aisle ${bay.aisle} â€¢ Level ${bay.level}</span>
                    <span style="float:right;color:#059669;font-weight:600">âœ“ Available</span>
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        })
        .catch(err => {
            console.error('Error searching bays:', err);
        });
}

// Select bay from search results
function selectBayForAssignment(location) {
    document.getElementById('bay-search-input').value = location;
    document.getElementById('bay-search-results').style.display = 'none';
}

// Confirm manual bay assignment
function confirmManualBayAssignment() {
    const bayLocation = document.getElementById('bay-search-input').value.trim().toUpperCase();
    
    if (!bayLocation) {
        alert('âš ï¸ Please enter or select a bay location');
        return;
    }
    
    assignPalletToBay(currentPalletCode, bayLocation);
}

// Helper: Get time ago
function getTimeAgo(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diff = Math.floor((now - then) / 1000); // seconds
    
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
    if (diff < 86400) return Math.floor(diff / 3600) + ' hrs ago';
    return Math.floor(diff / 86400) + ' days ago';
}


function loadStats() {
  fetch(API + '/api/stats')
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(stats => {
      console.log('ğŸ“Š Stats loaded:', stats);
      
      // Calculate percentage available
      const percentAvailable = stats.total_bays > 0 
        ? Math.round((stats.empty_bays / stats.total_bays) * 100) 
        : 0;
      
      // Build stats HTML with original styling
      let html = '';
      
      // Empty bays with percentage
      html += `<div class="stat-box">
        <strong>Empty Bays:</strong> ${stats.empty_bays} (${percentAvailable}% available)
      </div>`;
      
      // Pallets on hold
      html += `<div class="stat-box">
        <strong>Pallets on Hold:</strong> ${stats.active_holds}
      </div>`;
      
      document.getElementById('stats').innerHTML = html;
    })
    .catch(err => {
      console.error('Error loading stats:', err);
      document.getElementById('stats').innerHTML = 
        '<div class="stat-box" style="color:#dc2626">Error loading stats</div>';
    });
}

function loadBaysData() {
    fetch(API + '/api/bays')
        .then(r => r.json())
        .then(bays => {
            allBays = bays;
            
            // Only render if on map tab
            const mapView = document.getElementById('map');
            if(mapView && mapView.classList.contains('active')) {
                renderAisles();
                
                // Auto-select first aisle if none selected
                if(!selectedAisle && allBays.length > 0) {
                    const firstAisle = allBays[0].aisle;
                    selectAisle(firstAisle);
                }
            }
        })
        .catch(err => {
            console.error('Error loading bays:', err);
        });
}

function loadDashboard() {
    // Load stats first
    loadStats();
    
    // Then load recent activity
    fetch(API + '/api/dashboard/recent-activity')
        .then(r => r.json())
        .then(activity => {
            let html = '<h3 style="margin-top:30px;margin-bottom:15px">ğŸ“‹ Recent Activity</h3>';
            
            if (activity.length === 0) {
                html += `
                    <div style="text-align:center;padding:60px;background:#f9fafb;border-radius:10px">
                        <div style="font-size:48px;margin-bottom:15px">ğŸ“¦</div>
                        <h3 style="color:#666">No Recent Activity</h3>
                        <p style="color:#999;font-size:14px">Stock movements will appear here</p>
                    </div>`;
            } else {
                html += '<div style="background:white;border-radius:10px;overflow:hidden;border:2px solid #e5e7eb">';
                html += '<table style="width:100%">';
                html += `<thead>
                    <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
                        <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">Type</th>
                        <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">SKU</th>
                        <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">From</th>
                        <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">To</th>
                        <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">When</th>
                    </tr>
                </thead>`;
                html += '<tbody>';
                
                activity.forEach((a, idx) => {
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    const actionType = a.to_location ? 'ğŸ“¦ Move' : 
                                      a.quantity_change ? 'ğŸ“Š Adjust' : 
                                      'â• Add';
                    
                    html += `<tr style="background:${bgColor};border-bottom:1px solid #e5e7eb">
                        <td style="padding:12px;font-size:14px">${actionType}</td>
                        <td style="padding:12px;font-weight:600;color:#c62828;font-size:14px">${a.sku_code || 'N/A'}</td>
                        <td style="padding:12px;font-size:13px;color:#666">${a.from_location || 'â€”'}</td>
                        <td style="padding:12px;font-size:13px;color:#666">${a.to_location || 'â€”'}</td>
                        <td style="padding:12px;font-size:12px;color:#999">${formatTimeAgo(a.moved_at)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            }
            
            document.getElementById('dashboard-content').innerHTML = html;
        })
        .catch(err => {
            console.error('Error loading dashboard:', err);
            document.getElementById('dashboard-content').innerHTML = 
                '<p style="color:#dc2626;padding:20px">âš ï¸ Error loading activity</p>';
        });
}

function formatTimeAgo(timestamp) {
    if (!timestamp) return 'Unknown';
    
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + ' hr' + (diffHours > 1 ? 's' : '') + ' ago';
    if (diffDays < 7) return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
    
    return then.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Keyboard shortcut: Press 'S' to go to Search tab
document.addEventListener('keydown', function(e){
if(e.key === 's' && !e.target.matches('input, textarea')){
switchTab('search');
document.getElementById('searchInput').focus();
}
});


function searchProducts() {
    const term = document.getElementById('productsSearch').value.trim();
    
    if (term.length < 2) {
        displayProducts(allProducts);
        return;
    }
    
    // Use the correct search endpoint
    const matches = allProducts.filter(p => 
        p.sku_code.toLowerCase().includes(term.toLowerCase()) || 
        (p.product_name && p.product_name.toLowerCase().includes(term.toLowerCase()))
    );
    
    displayProducts(matches);
}

function renderAisles(){
const aisles=['AA','BB','CC','DD','EE'];
let html='';
aisles.forEach(aisle=>{
const aisleBays=allBays.filter(b=>b.aisle===aisle);
const empty=aisleBays.filter(b=>b.display_status==='empty').length;
const occupied=aisleBays.filter(b=>b.display_status==='occupied').length;
const onHold=aisleBays.filter(b=>b.display_status==='on_hold').length;
html+='<div class="aisle-card '+(selectedAisle===aisle?'selected':'')+'" onclick="selectAisle(\''+aisle+'\')"><h3>'+aisle+'</h3><p style="font-size:12px;margin-top:8px"><span style="color:#10b981;font-size:16px">â—</span> '+occupied+' Stock<br><span style="color:#6b7280;font-size:16px">â—</span> '+empty+' Empty<br><span style="color:#ef4444;font-size:16px">â—</span> '+onHold+' Hold</p></div>';
});
document.getElementById('aisle-cards').innerHTML=html;
}

function selectAisle(aisle){
selectedAisle=aisle;
renderAisles();
const aisleBays=allBays.filter(b=>b.aisle===aisle);
const levels=[5,4,3,2];
let html='<h3>Aisle '+aisle+'</h3>';
levels.forEach(level=>{
const levelBays=aisleBays.filter(b=>b.level===level);
if(levelBays.length>0){
html+='<h4 style="margin-top:20px">Height '+level+'</h4>';
levelBays.forEach(bay=>{
html+='<div class="bay-cell '+bay.display_status+'" onclick="handleBayClick(\'' + escapeForAttribute(bay.location) + '\',event)">'+escapeHtml(bay.location)+(bay.display_status==='on_hold'?'<br>ğŸ”’':'')+'</div>';

});
}
});
document.getElementById('bay-grid').innerHTML=html;

// Enable bulk selection mode if active
if(bulkAddMode){
document.querySelectorAll('.bay-cell').forEach(cell => {
cell.classList.add('selecting');
const cellLocation = cell.textContent.split('\n')[0].trim();
if(selectedBays.includes(cellLocation)){
cell.classList.add('selected');
}
});
}
}

function filterByBay(bayNum){
if(!bayNum){
renderAisles();
document.getElementById('bay-grid').innerHTML='';
return;
}
const filtered=allBays.filter(b=>b.bay_number==bayNum);
let html='<h3>All Bay '+bayNum+'\'s</h3>';
filtered.forEach(bay=>{
html+='<div class="bay-cell '+bay.display_status+'" onclick="handleBayClick(\''+bay.location+'\',event)">'+bay.location+'</div>';
});
document.getElementById('bay-grid').innerHTML=html;
}

function viewBay(location) {
    console.log('viewBay called with location:', location);
    
    fetch(API + '/api/bays/' + location)
        .then(r => r.json())
        .then(data => {
            console.log('Bay data received:', data);
            
            // Check if bay not found or error
            if (!data || !data.bay || data.error) {
                showToast('âš ï¸ Bay ' + location + ' not found or no longer exists');
                return;
            }
            
            // Check if bay is on hold and redirect to hold view
            if (data.bay.status === 'on_hold') {
                fetch(API + '/api/holds')
                    .then(r => r.json())
                    .then(holds => {
                        const hold = holds.find(h => h.original_bay === location);
                        if (hold) {
                            viewHoldStock(hold.location, location);
                        } else {
                            displayBayView(data, location);
                        }
                    })
                    .catch(err => {
                        console.error('Error loading holds:', err);
                        displayBayView(data, location);
                    });
            } else {
                displayBayView(data, location);
            }
        })
        .catch(err => {
            console.error('Error loading bay:', err);
            showToast('âŒ Error loading bay: ' + location);
        });
}

function displayBayView(data, location) {
    let html = '<h2>' + data.bay.location + '</h2>';
    html += '<p><span class="location-badge pallet">' + data.bay.status.toUpperCase() + '</span></p>';
    
    if (data.bay.notes) {
        html += '<p style="background:#fffbeb;padding:10px;margin:10px 0;border-radius:5px">' + escapeHtml(data.bay.notes) + '</p>';
    }
    
    html += '<h3>Stock in Bay:</h3>';
    
    if (data.stock.length > 0) {
        html += '<table style="width:100%"><tr><th>SKU</th><th>Product</th><th>Quantity</th><th>Actions</th></tr>';
        
        data.stock.forEach((s, idx) => {
            html += '<tr>';
            html += '<td><strong style="font-size:15px">' + escapeHtml(s.sku_code) + '</strong></td>';
            html += '<td style="font-size:13px">' + escapeHtml(s.product_name || 'N/A') + '</td>';
            
            // INLINE QUANTITY EDITOR
            html += '<td>';
            html += '<div style="display:flex;align-items:center;gap:8px">';
            html += '<span id="qty_display_' + idx + '" style="font-weight:700;font-size:18px;color:#059669;min-width:40px">' + (s.quantity || 'â€”') + '</span>';
            html += '<button class="btn-small" onclick="showQtyEditor(' + idx + ',' + (s.quantity || 0) + ',\'' + escapeJs(s.sku_code) + '\',\'' + escapeJs(location) + '\')" style="padding:5px 10px;font-size:12px;background:#6b7280">âœ Edit</button>';
            html += '</div>';
            
            // Hidden inline editor
            html += '<div id="qty_editor_' + idx + '" style="display:none;margin-top:8px">';
            html += '<div style="display:flex;gap:5px;align-items:center">';
            html += '<input type="number" id="qty_input_' + idx + '" value="' + (s.quantity || 0) + '" min="0" style="width:90px;padding:8px;font-size:16px;font-weight:600;border:2px solid #059669;border-radius:5px">';
            html += '<button class="btn-small" onclick="saveInlineQty(' + idx + ',\'' + escapeJs(s.sku_code) + '\',\'' + escapeJs(location) + '\')" style="padding:6px 12px;background:#059669;font-size:13px">âœ“ Save</button>';
            html += '<button class="btn-small btn-secondary" onclick="cancelQtyEdit(' + idx + ',' + (s.quantity || 0) + ')" style="padding:6px 12px;font-size:13px">âœ•</button>';
            html += '</div>';
            html += '<div style="font-size:11px;color:#666;margin-top:4px">Enter 0 to remove item</div>';
            html += '</div>';
            html += '</td>';
            
            html += '<td>';
            html += '<button class="btn-danger btn-small" onclick="deleteSKU(\'' + escapeJs(location) + '\',\'' + escapeJs(s.sku_code) + '\')">Delete</button>';
            html += '</td>';
            html += '</tr>';
        });
        
        html += '</table>';
        
        // Action buttons
        html += '<div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">';
        html += '<button class="btn btn-small" onclick="pickAll(\'' + escapeJs(location) + '\')">ğŸ”’ Pick All â†’ Hold</button>';
        html += '<button class="btn btn-small" onclick="transferStock(\'' + escapeJs(location) + '\')">ğŸ“¦ Transfer Out</button>';
        html += '<button class="btn btn-small" style="background:#f59e0b" onclick="mergeStockIntoBay(\'' + escapeJs(location) + '\')">ğŸ“¦ Merge From Bay</button>';
        html += '<button class="btn btn-small" style="background:#6366f1" onclick="printBayLabelFromModal(\'' + escapeJs(location) + '\')">ğŸ–¨ï¸ Print Label</button>';
        html += '</div>';
    } else {
        html += '<p style="padding:30px;text-align:center;background:#f5f5f5;border-radius:8px;color:#666">No stock in this bay</p>';
    }
    
    // Add SKU section
    html += '<div style="background:#f5f5f5;padding:15px;margin:15px 0;border-radius:8px;position:relative">';
    html += '<h4>Add SKU to Bay</h4>';
    html += '<input type="text" id="newSKU" placeholder="Type SKU or Product Name..." style="margin:5px 0" oninput="searchSKUAutocomplete()" autocomplete="off">';
    html += '<div id="skuSuggestions" style="display:none;background:white;border:2px solid #e0d8cc;border-radius:5px;max-height:200px;overflow-y:auto;position:absolute;width:calc(100% - 30px);z-index:100"></div>';
    html += '<input type="text" id="newProduct" placeholder="Product Name (optional)" style="margin:5px 0">';
    html += '<input type="number" id="newQty" placeholder="Quantity (optional)" style="margin:5px 0">';
    html += '<button class="btn btn-small" onclick="addSKUToBay(\'' + escapeJs(location) + '\')">Add SKU</button>';
    html += '</div>';
    
    // Notes section
    html += '<div style="margin-top:20px">';
    html += '<label style="font-weight:600">Bay Notes:</label>';
    html += '<textarea id="bayNotes" rows="3" style="width:100%;margin-top:5px">' + escapeHtml(data.bay.notes || '') + '</textarea>';
    html += '<button class="btn btn-small" style="margin-top:10px" onclick="saveNotes(\'' + escapeJs(location) + '\')">Save Notes</button>';
    html += '</div>';
    
    // Hold button
    if (data.bay.status !== 'on_hold') {
        html += '<button class="btn btn-danger" style="margin-top:15px;width:100%" onclick="placeHoldFromBayModal(\'' + escapeJs(location) + '\')">ğŸ”’ Place Bay on Hold</button>';
    }
    
    document.getElementById('bay-details').innerHTML = html;
    document.getElementById('bay-modal').classList.add('active');
}

function viewHoldBay(location){    
    // Get the hold location for this bay
    fetch(API+'/api/holds').then(r=>r.json()).then(holds=>{
        const hold = holds.find(h => h.original_bay === location);
        
        if(!hold){
            alert('Hold data not found for this bay');
            return;
        }
        
        // Now fetch the hold details
        fetch(API+'/api/holds/'+hold.location).then(r=>r.json()).then(data=>{            
            let html='<h2>'+location+' (ON HOLD)</h2>';
            html+='<p><span class="location-badge hold">ON HOLD</span></p>';
            html+='<p><strong>Hold Location:</strong> '+hold.location+'</p>';
            html+='<p><strong>Reason:</strong> '+(data.hold.reason||'N/A')+'</p>';
            
            html+='<h3>Stock in Hold:</h3>';
            if(data.stock.length>0){
                html+='<table><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Action</th></tr>';
                data.stock.forEach(s=>{
                    html+='<tr><td>'+s.sku_code+'</td><td>'+(s.product_name||'N/A')+'</td><td>'+(s.quantity||'N/A')+'</td><td><button class="btn-danger btn-small" onclick="deleteHoldSKU(\''+hold.location+'\',\''+s.sku_code+'\')">Delete</button></td></tr>';
                });
                html+='</table>';
            }else{
                html+='<p>No stock in this hold</p>';
            }
            
            // Add SKU section
            html+='<div style="background:#f5f5f5;padding:15px;margin:15px 0;border-radius:8px;position:relative">';
            html+='<h4>Add SKU to Hold</h4>';
            html+='<input type="text" id="newHoldSKU" placeholder="Type SKU or Product Name..." style="margin:5px 0" oninput="searchSKUAutocompleteHold()" autocomplete="off">';
            html+='<div id="skuSuggestionsHold" style="display:none;background:white;border:2px solid #e0d8cc;border-radius:5px;max-height:200px;overflow-y:auto;position:absolute;width:calc(100% - 30px);z-index:100"></div>';
            html+='<input type="text" id="newHoldProduct" placeholder="Product Name (optional)" style="margin:5px 0">';
            html+='<input type="number" id="newHoldQty" placeholder="Quantity (optional)" style="margin:5px 0">';
            html+='<button class="btn btn-small" onclick="addSKUToHold(\''+hold.location+'\')">Add SKU</button>';
            html+='</div>';
            
            // Notes section
            html+='<div style="margin-top:20px"><label>Reason/Notes:</label><textarea id="holdNotes" rows="3">'+(data.hold.reason||'')+'</textarea><button class="btn btn-small" style="margin-top:10px" onclick="saveHoldNotes(\''+hold.location+'\')">Save Notes</button></div>';
            
            // Action buttons
            html+='<div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">';
            html+='<button class="btn btn-small" onclick="returnHoldFromModal(\''+hold.location+'\')">Return to Bay</button>';
            html+='<button class="btn btn-small" onclick="moveHoldFromModal(\''+hold.location+'\')">Move to New Bay</button>';
            html+='</div>';
            
            document.getElementById('bay-details').innerHTML=html;
            document.getElementById('bay-modal').classList.add('active');
        });
    });
}

function viewHoldStock(holdLocation, originalBay) {
    console.log('Viewing hold stock:', holdLocation, 'for bay:', originalBay);
    
    fetch(API + '/api/holds/' + holdLocation)
        .then(r => r.json())
        .then(data => {
            let html = '<h2>' + originalBay + ' (ON HOLD)</h2>';
            html += '<div style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef4444">';
            html += '<strong>ğŸ”’ This bay is currently on hold</strong><br>';
            html += '<span style="font-size:13px;color:#666">Hold Location: <strong>' + holdLocation + '</strong></span>';
            if (data.hold && data.hold.reason) {
                html += '<br><span style="font-size:13px;color:#666">Reason: ' + escapeHtml(data.hold.reason) + '</span>';
            }
            html += '</div>';
            
            html += '<h3>Stock in Hold:</h3>';
            
            if (data.stock && data.stock.length > 0) {
                html += '<table style="width:100%"><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Actions</th></tr>';
                
                data.stock.forEach((s, idx) => {
                    html += '<tr>';
                    html += '<td><strong style="font-size:15px">' + escapeHtml(s.sku_code) + '</strong></td>';
                    html += '<td style="font-size:13px">' + escapeHtml(s.product_name || 'N/A') + '</td>';
                    
                    // Inline quantity editor
                    html += '<td>';
                    html += '<div style="display:flex;align-items:center;gap:8px">';
                    html += '<span id="hold_qty_display_' + idx + '" style="font-weight:700;font-size:18px;color:#059669;min-width:40px">' + (s.quantity || 'â€”') + '</span>';
                    html += '<button class="btn-small" onclick="showHoldQtyEditor(' + idx + ',' + (s.quantity || 0) + ',\'' + escapeJs(s.sku_code) + '\',\'' + escapeJs(holdLocation) + '\')" style="padding:5px 10px;font-size:12px;background:#6b7280">âœ Edit</button>';
                    html += '</div>';
                    
                    // Hidden inline editor
                    html += '<div id="hold_qty_editor_' + idx + '" style="display:none;margin-top:8px">';
                    html += '<div style="display:flex;gap:5px;align-items:center">';
                    html += '<input type="number" id="hold_qty_input_' + idx + '" value="' + (s.quantity || 0) + '" min="0" style="width:90px;padding:8px;font-size:16px;font-weight:600;border:2px solid #059669;border-radius:5px">';
                    html += '<button class="btn-small" onclick="saveHoldQty(' + idx + ',\'' + escapeJs(s.sku_code) + '\',\'' + escapeJs(holdLocation) + '\')" style="padding:6px 12px;background:#059669;font-size:13px">âœ“ Save</button>';
                    html += '<button class="btn-small btn-secondary" onclick="cancelHoldQtyEdit(' + idx + ',' + (s.quantity || 0) + ')" style="padding:6px 12px;font-size:13px">âœ•</button>';
                    html += '</div>';
                    html += '<div style="font-size:11px;color:#666;margin-top:4px">Enter 0 to remove item</div>';
                    html += '</div>';
                    html += '</td>';
                    
                    html += '<td>';
                    html += '<button class="btn-danger btn-small" onclick="deleteHoldSKU(\'' + escapeJs(holdLocation) + '\',\'' + escapeJs(s.sku_code) + '\')">Delete</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                
                html += '</table>';
            } else {
                html += '<p style="text-align:center;padding:40px;background:#f9fafb;border-radius:8px;color:#666">No stock in hold</p>';
            }
            
            // Action buttons
            html += '<div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">';
            html += '<button class="btn" onclick="returnHoldFromModal(\'' + holdLocation + '\')" style="background:#059669">âœ… Return to ' + originalBay + '</button>';
            html += '<button class="btn btn-secondary" onclick="moveHoldFromModal(\'' + holdLocation + '\')">ğŸ“¦ Move to Different Bay</button>';
            html += '<button class="btn btn-secondary" onclick="closeModal(\'bay-modal\')">Close</button>';
            html += '</div>';
            
            document.getElementById('bay-details').innerHTML = html;
            document.getElementById('bay-modal').classList.add('active');
        })
        .catch(err => {
            console.error('Error loading hold:', err);
            alert('âŒ Error loading hold stock');
        });
}

function showHoldQtyEditor(idx, currentQty, sku, holdLocation) {
    document.getElementById('hold_qty_display_' + idx).style.display = 'none';
    document.getElementById('hold_qty_editor_' + idx).style.display = 'block';
    document.getElementById('hold_qty_input_' + idx).focus();
    document.getElementById('hold_qty_input_' + idx).select();
}

function cancelHoldQtyEdit(idx, originalQty) {
    document.getElementById('hold_qty_display_' + idx).style.display = 'flex';
    document.getElementById('hold_qty_editor_' + idx).style.display = 'none';
    document.getElementById('hold_qty_input_' + idx).value = originalQty;
}

function saveHoldQty(idx, sku, holdLocation) {
    const newQty = parseInt(document.getElementById('hold_qty_input_' + idx).value);
    
    if (isNaN(newQty) || newQty < 0) {
        alert('âš ï¸ Enter a valid quantity');
        return;
    }
    
    if (newQty === 0) {
        if (!confirm('Set quantity to 0? This will remove ' + sku + ' from the hold.')) {
            return;
        }
    }
    
    const saveBtn = event.target;
    saveBtn.disabled = true;
    saveBtn.innerHTML = 'â³';
    
    fetch(API + '/api/holds/' + encodeURIComponent(holdLocation) + '/update-qty', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sku_code: sku,
            quantity: newQty
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(result => {
        if (result.success) {
            if (result.deleted) {
                showToast('âœ… ' + sku + ' removed from hold');
                // Reload the view
                const bayMatch = document.querySelector('h2').textContent.match(/^([A-Z]{2}-\d{2}-\d)/);
                if (bayMatch) {
                    viewBay(bayMatch[1]);
                }
            } else {
                document.getElementById('hold_qty_display_' + idx).innerHTML = newQty;
                document.getElementById('hold_qty_display_' + idx).style.display = 'flex';
                document.getElementById('hold_qty_editor_' + idx).style.display = 'none';
                showToast('âœ… Quantity updated to ' + newQty);
            }
            loadStats();
        } else {
            alert('âŒ Update failed: ' + (result.error || 'Unknown error'));
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'âœ“ Save';
        }
    })
    .catch(err => {
        console.error('Update error:', err);
        alert('âŒ Error: ' + err.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'âœ“ Save';
    });
}

function searchSKUAutocomplete() {
    const term = document.getElementById('newSKU').value.trim();
    const suggestionsDiv = document.getElementById('skuSuggestions');
    
    if (term.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    fetch(API + '/api/skus/search?q=' + encodeURIComponent(term))
        .then(r => r.json())
        .then(results => {
            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Clear previous content
            suggestionsDiv.innerHTML = '';
            
            results.forEach(sku => {
                // Create suggestion div
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'autocomplete-suggestion';
                suggestionDiv.style.cssText = 'padding:10px;cursor:pointer;border-bottom:1px solid #e0d8cc';
                
                // Safely set content
                const skuCode = escapeHtml(sku.sku_code);
                const productName = escapeHtml(sku.product_name || '');
                
                suggestionDiv.innerHTML = '<strong>' + skuCode + '</strong>';
                if (sku.product_name) {
                    suggestionDiv.innerHTML += '<br><small style="color:#666">' + productName + '</small>';
                }
                
                // Add click handler with closure (captures actual data, not strings)
                suggestionDiv.addEventListener('click', function() {
                    selectSKU(sku.sku_code, sku.product_name || '');
                });
                
                // Hover effect
                suggestionDiv.addEventListener('mouseenter', function() {
                    this.style.background = '#f5f0e8';
                });
                suggestionDiv.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
                
                suggestionsDiv.appendChild(suggestionDiv);
            });
            
            suggestionsDiv.style.display = 'block';
        })
        .catch(err => {
            console.error('Autocomplete error:', err);
            suggestionsDiv.style.display = 'none';
        });
}

function selectSKU(code,name){
document.getElementById('newSKU').value=code;
document.getElementById('newProduct').value=name;
document.getElementById('skuSuggestions').style.display='none';
document.getElementById('newQty').focus();
}

function addSKUToBay(location){
const sku=document.getElementById('newSKU').value.trim();
const product=document.getElementById('newProduct').value.trim();
const qty=document.getElementById('newQty').value;
if(!sku){alert('Enter SKU code');return;}
fetch(API+'/api/bays/'+location+'/add-sku',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sku_code:sku,product_name:product,quantity:qty?parseInt(qty):null})}).then(()=>{
alert('SKU added!');
loadBaysData();
loadStats();
viewBay(location);
});
}

function deleteSKU(location, sku) {
    if (!confirm('Delete ' + sku + ' from this bay?')) return;
    
    const encodedSKU = encodeURIComponent(sku);
    
    fetch(API + '/api/bays/' + location + '/sku/' + encodedSKU, {
        method: 'DELETE'
    })
    .then(r => r.json())  // â† Make sure this line is here
    .then(result => {
        if (result.success) {
            alert('âœ… SKU deleted: ' + sku);
            loadBaysData();
            loadStats();
            viewBay(location);
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Delete error:', err);  // â† Check browser console
        alert('âŒ Error: ' + err.message);
    });
}

function saveNotes(loc){
const notes=document.getElementById('bayNotes').value;
fetch(API+'/api/bays/'+loc+'/notes',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({notes})}).then(()=>{
alert('Notes saved!');
closeModal('bay-modal');
});
}

function pickAll(loc){
const reason=prompt('Reason for picking:');
if(!reason)return;
fetch(API+'/api/bays/'+loc+'/pick-all',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reason})}).then(()=>{
alert('Picked and moved to hold!');
closeModal('bay-modal');
loadBaysData();
loadStats();
});
}

function transferStock(loc){
// Show modal with autocomplete
const modalHtml='<h2>Transfer Stock from '+loc+'</h2><p>Type or select destination bay:</p><input type="text" id="transferLocation" placeholder="Type bay location..." style="width:100%;padding:14px;font-size:16px;margin:10px 0" oninput="suggestBays()" autocomplete="off"><div id="baySuggestions" style="background:white;border:2px solid #e0d8cc;border-radius:8px;max-height:300px;overflow-y:auto;margin:10px 0"></div><button class="btn" onclick="confirmTransfer(\''+loc+'\')">Confirm Transfer</button><button class="btn btn-secondary" onclick="closeModal(\'bay-modal\')">Cancel</button>';
document.getElementById('bay-details').innerHTML=modalHtml;
document.getElementById('bay-modal').classList.add('active');
document.getElementById('transferLocation').focus();

// Pre-load bay suggestions
suggestBays();
}
function mergeStockIntoBay(toBay){
    // Show modal to select source bay
    const modalHtml=`<h2>Merge Stock INTO ${toBay}</h2>
<p style="background:#fef3c7;padding:12px;border-radius:8px;border-left:4px solid #f59e0b;margin:10px 0">
    <strong>âš ï¸ Controlled Merge:</strong> This will move stock FROM another bay INTO ${toBay}.<br>
    <small>Both bays will be combined. The source bay will become empty.</small>
</p>
<p>Select source bay (must have stock):</p>
<input type="text" id="mergeSourceBay" placeholder="Type source bay location..." 
       style="width:100%;padding:14px;font-size:16px;margin:10px 0" 
       oninput="suggestMergeBays()" autocomplete="off">
<div id="mergeBaySuggestions" 
     style="background:white;border:2px solid #e0d8cc;border-radius:8px;max-height:300px;overflow-y:auto;margin:10px 0">
</div>
<button class="btn" onclick="previewMerge('${toBay}')">Preview Merge</button>
<button class="btn btn-secondary" onclick="closeModal('bay-modal')">Cancel</button>`;
    
    document.getElementById('bay-details').innerHTML=modalHtml;
    document.getElementById('bay-modal').classList.add('active');
    
    // Focus and show suggestions
    setTimeout(() => {
        const input = document.getElementById('mergeSourceBay');
        if(input){
            input.focus();
            suggestMergeBays();
        }
    }, 100);
}
function suggestMergeBays(){
    const input = document.getElementById('mergeSourceBay');
    const list = document.getElementById('mergeBaySuggestions');
    if(!input || !list) return;

    const query = input.value.toUpperCase().trim();
    
    // Filter for OCCUPIED bays only (bays with stock)
    const occupiedBays = (allBays || []).filter(b =>
        b.display_status === 'occupied' &&
        (!query || b.location.includes(query))
    ).slice(0, 30);

    if(occupiedBays.length === 0){
        list.innerHTML = '<div style="padding:15px;color:#666">No occupied bays found. Only bays with stock can be merged.</div>';
        return;
    }

    let html = '<div style="padding:10px;background:#f5f0e8;font-weight:600">Available Bays With Stock</div>';
    occupiedBays.forEach(bay => {
        html += `<div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer;font-size:15px" 
                      onclick="selectMergeSourceBay('${bay.location}')">
                    ${bay.location} <span style="color:#059669;font-size:12px">â— Has Stock</span>
                 </div>`;
    });
    list.innerHTML = html;
}

function selectMergeSourceBay(location){
    const input = document.getElementById('mergeSourceBay');
    const list = document.getElementById('mergeBaySuggestions');
    if(input) input.value = location;
    if(list) list.innerHTML = '';
}
function previewMerge(toBay){
    const fromBay = document.getElementById('mergeSourceBay').value.trim().toUpperCase();
    
    if(!fromBay){
        alert('Enter source bay location');
        return;
    }
    
    if(fromBay === toBay){
        alert('Cannot merge a bay into itself!');
        return;
    }
    
    // Validate source bay exists and has stock
    const sourceBayData = allBays.find(b => b.location === fromBay);
    if(!sourceBayData){
        alert('Source bay '+fromBay+' does not exist');
        return;
    }
    if(sourceBayData.display_status !== 'occupied'){
        alert('Source bay '+fromBay+' has no stock to merge');
        return;
    }
    
    // Fetch stock from both bays
    Promise.all([
        fetch(API+'/api/bays/'+fromBay).then(r=>r.json()),
        fetch(API+'/api/bays/'+toBay).then(r=>r.json())
    ]).then(([sourceData, destData]) => {
        
        if(sourceData.stock.length === 0){
            alert('Source bay '+fromBay+' is empty');
            return;
        }
        
        // Show preview with SKU selection checkboxes AND quantity inputs
        let html = `<h2>ğŸ“¦ Select SKUs & Quantities to Merge</h2>
<div style="background:#dbeafe;padding:15px;border-radius:8px;margin:10px 0;border-left:4px solid #0284c7">
    <strong>Move stock:</strong> FROM <strong>${fromBay}</strong> â†’ INTO <strong>${toBay}</strong><br>
    <small>Select SKUs and specify quantities. Enter partial quantities to split stock.</small>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0">
    <div>
        <h3 style="color:#dc2626">FROM: ${fromBay}</h3>
        <div style="background:#fee2e2;padding:15px;border-radius:8px">
            <p style="margin-bottom:10px;font-weight:600">Select items & quantities:</p>
            <div style="max-height:400px;overflow-y:auto">`;
        
        sourceData.stock.forEach((s, idx) => {
            const maxQty = s.quantity || 999999;
            html += `
            <div style="background:white;padding:12px;margin:5px 0;border-radius:5px;border:2px solid #e0d8cc" id="sku_container_${idx}">
                <label style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                    <input type="checkbox" id="sku_${idx}" value="${s.sku_code}" 
                           data-max-qty="${maxQty}"
                           style="width:20px;height:20px;cursor:pointer" 
                           onchange="toggleSKUSelection(${idx})">
                    <div style="flex:1">
                        <strong>${s.sku_code}</strong><br>
                        <small style="color:#666">${s.product_name||'N/A'}</small>
                    </div>
                    <div style="font-weight:600;color:#059669">
                        Available: ${maxQty}
                    </div>
                </label>
                
                <div id="qty_input_${idx}" style="display:none;margin-top:8px;padding-top:8px;border-top:1px solid #e0d8cc">
                    <label style="font-size:12px;color:#666;display:block;margin-bottom:5px">
                        Quantity to transfer:
                    </label>
                    <div style="display:flex;gap:10px;align-items:center">
                        <input type="number" id="qty_${idx}" 
                               min="1" 
                               max="${maxQty}" 
                               value="${maxQty}"
                               style="width:100px;padding:8px;font-size:14px;font-weight:600"
                               oninput="validateQuantity(${idx}, ${maxQty})">
                        <button class="btn-small btn-secondary" onclick="setMaxQty(${idx}, ${maxQty})" style="padding:6px 12px">Max (${maxQty})</button>
                        <span id="remaining_${idx}" style="font-size:12px;color:#666"></span>
                    </div>
                    <div id="qty_error_${idx}" style="color:#dc2626;font-size:11px;margin-top:5px;display:none"></div>
                </div>
            </div>`;
        });
        
        html += `</div>
            <div style="margin-top:10px;padding:10px;background:#fffbeb;border-radius:5px">
                <label style="cursor:pointer">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" style="width:18px;height:18px">
                    <strong> Select All (${sourceData.stock.length} items)</strong>
                </label>
            </div>
        </div>
    </div>
    
    <div>
        <h3 style="color:#059669">TO: ${toBay}</h3>
        <div style="background:#d1fae5;padding:15px;border-radius:8px">`;
        
        if(destData.stock.length > 0){
            html += `<p style="margin-bottom:10px"><strong>Current stock:</strong></p>
            <div style="max-height:400px;overflow-y:auto">`;
            destData.stock.forEach(s => {
                html += `<div style="background:white;padding:8px;margin:5px 0;border-radius:5px">
                    <strong>${s.sku_code}</strong> ${s.quantity ? '(Qty: '+s.quantity+')' : ''}<br>
                    <small style="color:#666">${s.product_name||'N/A'}</small>
                </div>`;
            });
            html += `</div>
            <p style="margin-top:10px;color:#059669;font-weight:600;padding:10px;background:#fffbeb;border-radius:5px">
                + Selected items from ${fromBay}
            </p>`;
        }else{
            html += '<p style="text-align:center;padding:20px;color:#666">Currently empty<br>Will receive selected items</p>';
        }
        
        html += `</div>
    </div>
</div>

<div id="mergeSelectionSummary" style="background:#fffbeb;padding:15px;border-radius:8px;margin:15px 0">
    <strong>ğŸ“‹ Selection:</strong> <span id="selectedCount">0 items selected</span>
</div>

<div style="display:flex;gap:10px;margin-top:20px">
    <button class="btn" id="confirmMergeBtn" onclick="confirmSelectedMerge('${fromBay}','${toBay}')" disabled style="opacity:0.5">
        âœ“ Merge Selected Items
    </button>
    <button class="btn btn-secondary" onclick="mergeStockIntoBay('${toBay}')">â† Back</button>
    <button class="btn btn-secondary" onclick="closeModal('bay-modal')">Cancel</button>
</div>`;
        
        document.getElementById('bay-details').innerHTML = html;
    });
}
function toggleSKUSelection(idx){
    const checkbox = document.getElementById('sku_'+idx);
    const qtyInput = document.getElementById('qty_input_'+idx);
    const container = document.getElementById('sku_container_'+idx);
    
    if(checkbox.checked){
        qtyInput.style.display = 'block';
        container.style.borderColor = '#059669';
        container.style.backgroundColor = '#f0fdf4';
        
        // Set default to max quantity
        const maxQty = parseInt(checkbox.dataset.maxQty);
        document.getElementById('qty_'+idx).value = maxQty;
        validateQuantity(idx, maxQty);
    }else{
        qtyInput.style.display = 'none';
        container.style.borderColor = '#e0d8cc';
        container.style.backgroundColor = 'white';
    }
    
    updateMergeSelection();
}

function validateQuantity(idx, maxQty){
    const input = document.getElementById('qty_'+idx);
    const error = document.getElementById('qty_error_'+idx);
    const remaining = document.getElementById('remaining_'+idx);
    const value = parseInt(input.value) || 0;
    
    if(value <= 0){
        error.textContent = 'Quantity must be greater than 0';
        error.style.display = 'block';
        input.style.borderColor = '#dc2626';
        return false;
    }
    
    if(value > maxQty){
        error.textContent = `Cannot exceed available quantity (${maxQty})`;
        error.style.display = 'block';
        input.style.borderColor = '#dc2626';
        return false;
    }
    
    error.style.display = 'none';
    input.style.borderColor = '#059669';
    
    // Show remaining quantity
    const remainingQty = maxQty - value;
    if(remainingQty > 0){
        remaining.textContent = `(${remainingQty} will remain in source bay)`;
        remaining.style.color = '#f59e0b';
    }else{
        remaining.textContent = '(All units will be transferred)';
        remaining.style.color = '#059669';
    }
    
    return true;
}

function setMaxQty(idx, maxQty){
    document.getElementById('qty_'+idx).value = maxQty;
    validateQuantity(idx, maxQty);
}

function updateMergeSelection(){
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="sku_"]');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    document.getElementById('selectedCount').innerHTML = selectedCount + ' item(s) selected';
    
    const confirmBtn = document.getElementById('confirmMergeBtn');
    
    // Validate all quantities are valid
    let allValid = true;
    checkboxes.forEach((cb, idx) => {
        if(cb.checked){
            const maxQty = parseInt(cb.dataset.maxQty);
            const qtyInput = document.getElementById('qty_'+idx);
            const value = parseInt(qtyInput?.value) || 0;
            if(value <= 0 || value > maxQty){
                allValid = false;
            }
        }
    });
    
    if(selectedCount > 0 && allValid){
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
    }else{
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
    }
    
    // Update select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    if(selectAllCheckbox){
        selectAllCheckbox.checked = selectedCount === checkboxes.length;
    }
}

function toggleSelectAll(){
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="sku_"]');
    
    checkboxes.forEach((cb, idx) => {
        cb.checked = selectAllCheckbox.checked;
        toggleSKUSelection(idx);
    });
}

function confirmSelectedMerge(fromBay, toBay){
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="sku_"]:checked');
    
    if(checkboxes.length === 0){
        alert('No items selected');
        return;
    }
    
    // Collect selected SKUs with quantities
    const transferData = [];
    let hasErrors = false;
    
    checkboxes.forEach((cb, idx) => {
        const skuCode = cb.value;
        const maxQty = parseInt(cb.dataset.maxQty);
        const qtyInput = document.getElementById('qty_'+Array.from(document.querySelectorAll('input[type="checkbox"][id^="sku_"]')).indexOf(cb));
        const transferQty = parseInt(qtyInput.value) || 0;
        
        if(transferQty <= 0 || transferQty > maxQty){
            hasErrors = true;
        }else{
            transferData.push({
                sku: skuCode,
                quantity: transferQty,
                max: maxQty
            });
        }
    });
    
    if(hasErrors){
        alert('Please fix quantity errors before continuing');
        return;
    }
    
    // Show confirmation with quantities
    let confirmMsg = `Confirm merge from ${fromBay} to ${toBay}?\n\n`;
    transferData.forEach(item => {
        confirmMsg += `â€¢ ${item.sku}: ${item.quantity} units`;
        if(item.quantity < item.max){
            confirmMsg += ` (${item.max - item.quantity} will remain)`;
        }
        confirmMsg += '\n';
    });
    
    if(!confirm(confirmMsg)){
        return;
    }
    
     executeMergeWithQuantities(fromBay, toBay, transferData);
}
function executeMergeWithQuantities(fromBay, toBay, transferData) {
    document.getElementById('bay-details').innerHTML = '<h2>Merging stock...</h2><p>Please wait...</p>';
    
    console.log('Executing merge with quantities:', { fromBay, toBay, items: transferData });
    
    // Convert to API format
    const transfers = transferData.map(item => ({
        sku_code: item.sku,
        quantity: item.quantity
    }));
    
    // Use the transfer endpoint (which handles quantities properly)
    fetch(API + '/api/bays/' + toBay + '/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            fromLocation: fromBay,
            to_location: toBay,
            transfers: transfers
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            // Success message
            document.getElementById('bay-details').innerHTML = `
            <div style="text-align:center;padding:40px">
                <h2 style="color:#059669">âœ… Merge Complete!</h2>
                <p style="font-size:18px;margin:20px 0">
                    Merged <strong>${result.moved || transfers.length} item(s)</strong><br>
                    FROM <strong>${fromBay}</strong><br>
                    INTO <strong>${toBay}</strong>
                </p>
                <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin:20px auto;max-width:400px;text-align:left">
                    <strong>Transferred:</strong>
                    <ul style="margin:10px 0 0 20px;font-size:14px">
                        ${transferData.map(item => {
                            const partial = item.quantity < item.max ? ` (${item.max - item.quantity} remain in ${fromBay})` : '';
                            return `<li><strong>${item.sku}</strong>: ${item.quantity} units${partial}</li>`;
                        }).join('')}
                    </ul>
                </div>
                ${result.errors && result.errors.length > 0 ? `
                <div style="background:#fee2e2;padding:15px;border-radius:8px;margin:20px auto;max-width:400px;text-align:left">
                    <strong>âš ï¸ Errors:</strong>
                    <ul style="margin:10px 0 0 20px;font-size:12px;color:#dc2626">
                        ${result.errors.map(err => '<li>' + err + '</li>').join('')}
                    </ul>
                </div>` : ''}
                <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap">
                    <button class="btn" onclick="viewBay('${toBay}')">View ${toBay}</button>
                    <button class="btn btn-secondary" onclick="viewBay('${fromBay}')">View ${fromBay}</button>
                    <button class="btn btn-secondary" onclick="closeModal('bay-modal')">Close</button>
                </div>
            </div>`;
            
            loadBaysData();
            loadStats();
        } else {
            alert('âŒ Merge failed: ' + (result.error || 'Unknown error'));
            if (result.errors) {
                console.error('Merge errors:', result.errors);
            }
            closeModal('bay-modal');
        }
    })
    .catch(err => {
        console.error('Merge error:', err);
        alert('âŒ Merge failed: ' + err.message);
        closeModal('bay-modal');
    });
}
    
    
function toggleSelectAll(){
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="sku_"]');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
    
    updateMergeSelection();
}

function confirmSelectedMerge(fromBay, toBay) {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="sku_"]:checked');
    
    if (checkboxes.length === 0) {
        alert('No items selected');
        return;
    }
    
    // Collect selected SKUs with quantities
    const transferData = [];
    let hasErrors = false;
    
    checkboxes.forEach(cb => {
        const skuCode = cb.value;
        const maxQty = parseInt(cb.dataset.maxQty);
        const index = Array.from(document.querySelectorAll('input[type="checkbox"][id^="sku_"]')).indexOf(cb);
        const qtyInput = document.getElementById('qty_' + index);
        const transferQty = parseInt(qtyInput ? qtyInput.value : maxQty) || maxQty;
        
        if (transferQty <= 0 || transferQty > maxQty) {
            hasErrors = true;
            console.error('Invalid quantity for', skuCode, ':', transferQty, '(max:', maxQty + ')');
        } else {
            transferData.push({
                sku: skuCode,
                quantity: transferQty,
                max: maxQty
            });
        }
    });
    
    if (hasErrors) {
        alert('âš ï¸ Please fix quantity errors before continuing');
        return;
    }
    
    // Show confirmation with quantities
    let confirmMsg = `Confirm merge from ${fromBay} to ${toBay}?\n\n`;
    transferData.forEach(item => {
        confirmMsg += `â€¢ ${item.sku}: ${item.quantity} units`;
        if (item.quantity < item.max) {
            confirmMsg += ` (${item.max - item.quantity} will remain in ${fromBay})`;
        }
        confirmMsg += '\n';
    });
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    executeMergeWithQuantities(fromBay, toBay, transferData);
}

function executeMerge(fromBay, toBay, selectedSKUs){
    document.getElementById('bay-details').innerHTML = '<h2>Merging stock...</h2><p>Please wait...</p>';
    
    // If no selectedSKUs provided, transfer all (backwards compatible)
    if(!selectedSKUs){
        fetch(API+'/api/bays/'+fromBay).then(r=>r.json()).then(data=>{
            selectedSKUs = data.stock.map(s=>s.sku_code);
            performTransfer(fromBay, toBay, selectedSKUs);
        });
    }else{
        performTransfer(fromBay, toBay, selectedSKUs);
    }
}

function performTransfer(fromBay, toBay, skus){
    if(skus.length === 0){
        alert('No items to transfer');
        closeModal('bay-modal');
        return;
    }
    
    console.log('Transferring:', { from: fromBay, to: toBay, skus: skus });
    
    // Use the transfer endpoint with correct URL (toBay, not fromBay!)
    fetch(API + '/api/bays/' + toBay + '/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            fromLocation: fromBay,
            to_location: toBay,
            skus: skus
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            document.getElementById('bay-details').innerHTML = `
            <div style="text-align:center;padding:40px">
                <h2 style="color:#059669">âœ… Merge Complete!</h2>
                <p style="font-size:18px;margin:20px 0">
                    Merged <strong>${result.moved || skus.length} SKU(s)</strong><br>
                    FROM <strong>${fromBay}</strong><br>
                    INTO <strong>${toBay}</strong>
                </p>
                <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin:20px auto;max-width:300px;text-align:left">
                    <strong>Transferred:</strong>
                    <ul style="margin:10px 0 0 20px;font-size:14px">
                        ${skus.map(sku => '<li>' + sku + '</li>').join('')}
                    </ul>
                </div>
                ${result.errors && result.errors.length > 0 ? `
                <div style="background:#fee2e2;padding:15px;border-radius:8px;margin:20px auto;max-width:300px;text-align:left">
                    <strong>âš ï¸ Errors:</strong>
                    <ul style="margin:10px 0 0 20px;font-size:12px">
                        ${result.errors.map(err => '<li>' + err + '</li>').join('')}
                    </ul>
                </div>` : ''}
                <div style="display:flex;gap:10px;justify-content:center;margin-top:20px">
                    <button class="btn" onclick="viewBay('${toBay}')">View ${toBay}</button>
                    <button class="btn btn-secondary" onclick="viewBay('${fromBay}')">View ${fromBay}</button>
                    <button class="btn btn-secondary" onclick="closeModal('bay-modal')">Close</button>
                </div>
            </div>`;
            
            loadBaysData();
            loadStats();
        } else {
            alert('âŒ Merge failed: ' + (result.error || 'Unknown error'));
            closeModal('bay-modal');
        }
    })
    .catch(err => {
        console.error('Transfer error:', err);
        alert('âŒ Merge failed: ' + err.message);
        closeModal('bay-modal');
    });
}
function suggestBays(){
const input=document.getElementById('transferLocation').value.toUpperCase().trim();
const suggestionsDiv=document.getElementById('baySuggestions');

// Filter existing bays
const filtered = allBays.filter(b => 
b.location.includes(input) && b.display_status === 'empty'
).slice(0, 20);

if(filtered.length === 0 && input.length > 0){
suggestionsDiv.innerHTML='<div style="padding:15px;color:#dc2626">No empty bays match "'+input+'"</div>';
return;
}

let html='<div style="padding:10px;background:#f5f0e8;font-weight:600">Available Empty Bays:</div>';
filtered.forEach(bay=>{
html+='<div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer;font-size:15px" onclick="selectTransferBay(\''+bay.location+'\')">'+bay.location+' <span style="color:#10b981;font-size:12px">â— Empty</span></div>';
});
suggestionsDiv.innerHTML=html;
}

function suggestBaysForHold(){
  const inputEl = document.getElementById('holdMoveLocation');
  const suggestionsEl = document.getElementById('holdBaySuggestions');
  if(!inputEl || !suggestionsEl) return;

  const q = inputEl.value.toUpperCase().trim();

  // Filter to EMPTY bays from the already-loaded allBays cache
  // (If your server tags empties with display_status === 'empty', this matches your Visual Map.)
  const empties = (allBays || []).filter(b => 
    (!q || b.location.includes(q)) &&
    b.display_status === 'empty'
  ).slice(0, 30);

  if(empties.length === 0){
    if(q.length === 0){
      // With no input, still show a small hint list of empties (up to 10)
      const some = (allBays || []).filter(b => b.display_status === 'empty').slice(0, 10);
      if(some.length === 0){
        suggestionsEl.innerHTML = '<div style="padding:12px;color:#666">No empty bays available</div>';
        suggestionsEl.style.display = 'block';
        return;
      }
      let html = '<div style="padding:10px;background:#f5f0e8;font-weight:600">Empty Bays</div>';
      some.forEach(b => {
        html += `<div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer" onclick="selectHoldTransferBay('${b.location}')">${b.location} <span style="color:#10b981;font-size:12px">â— Empty</span></div>`;
      });
      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = 'block';
      return;
    } else {
      suggestionsEl.innerHTML = `<div style="padding:12px;color:#dc2626">No empty bays match "${q}"</div>`;
      suggestionsEl.style.display = 'block';
      return;
    }
  }

  let html = '<div style="padding:10px;background:#f5f0e8;font-weight:600">Available Empty Bays</div>';
  empties.forEach(b => {
    html += `<div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer" onclick="selectHoldTransferBay('${b.location}')">${b.location} <span style="color:#10b981;font-size:12px">â— Empty</span></div>`;
  });
  suggestionsEl.innerHTML = html;
  suggestionsEl.style.display = 'block';
}

function selectHoldTransferBay(location){
  const inputEl = document.getElementById('holdMoveLocation');
  const suggestionsEl = document.getElementById('holdBaySuggestions');
  if(inputEl){ inputEl.value = location; }
  if(suggestionsEl){ suggestionsEl.style.display = 'none'; }
}

function confirmHoldMove(holdLoc){
  const toLoc = (document.getElementById('holdMoveLocation')?.value || '').toUpperCase().trim();
  if(!toLoc){
    alert('Enter a destination bay');
    return;
  }

  // Validate the bay exists in cache and is empty
  const bay = (allBays || []).find(b => b.location === toLoc);
  if(!bay){
    alert(`Bay ${toLoc} does not exist. Please select a valid bay.`);
    return;
  }
  if(bay.display_status !== 'empty'){
    alert(`Bay ${toLoc} is not empty.`);
    return;
  }

  fetch(API + '/api/holds/' + holdLoc + '/move', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ new_bay: toLoc })
  }).then(() => {
    alert(`Moved hold ${holdLoc} to ${toLoc}!`);
    closeModal('bay-modal');
    loadHolds();     // refresh Hold list
    loadBaysData();  // refresh bay grid cache
    loadStats();     // refresh headline stats
  }).catch(err => {
    alert('Move failed: ' + err.message);
  });
}

function selectTransferBay(location){
document.getElementById('transferLocation').value=location;
document.getElementById('baySuggestions').innerHTML='';
}

function confirmTransfer(fromLoc) {
    const toLoc = document.getElementById('transferLocation').value.trim().toUpperCase();
    
    if (!toLoc) {
        alert('Enter destination bay');
        return;
    }
    
    if (fromLoc === toLoc) {
        alert('Cannot transfer to the same bay!');
        return;
    }
    
    // Validate bay exists
    const bayExists = allBays.find(b => b.location === toLoc);
    if (!bayExists) {
        alert('Bay ' + toLoc + ' does not exist. Please select a valid bay.');
        return;
    }
    
    // Get stock from source bay
    fetch(API + '/api/bays/' + fromLoc)
        .then(r => r.json())
        .then(data => {
            const skus = data.stock.map(s => s.sku_code);
            
            if (skus.length === 0) {
                alert('No stock to transfer');
                closeModal('bay-modal');
                return;
            }
            
            // Confirm transfer
            if (!confirm(`Transfer ${skus.length} SKU(s) from ${fromLoc} to ${toLoc}?`)) {
                return;
            }
            
            // FIXED: Use toLoc in URL, not fromLoc!
            fetch(API + '/api/bays/' + toLoc + '/transfer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fromLocation: fromLoc,
                    to_location: toLoc,
                    skus: skus
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert('âœ… Transferred ' + (result.moved || skus.length) + ' SKU(s) to ' + toLoc + '!');
                    closeModal('bay-modal');
                    loadBaysData();
                    loadStats();
                } else {
                    alert('âŒ Transfer failed: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Transfer error:', err);
                alert('âŒ Transfer failed: ' + err.message);
            });
        })
        .catch(err => {
            console.error('Error loading source bay:', err);
            alert('âŒ Error: ' + err.message);
        });
}

function placeHold(loc){
const reason=prompt('Reason for hold:');
if(!reason)return;
fetch(API+'/api/holds/create',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({bay_location:loc,reason:reason})
}).then(r=>r.json()).then(result=>{
if(result.success){
alert('Placed on hold! Hold location: '+result.hold_location);
closeModal('bay-modal');
loadBaysData();
loadStats();
}else{
alert('Error: '+(result.error||'Unknown error'));
}
}).catch(err=>{
console.error('Hold error:',err);
alert('Failed to create hold');
});
}

function placeHoldFromBayModal(location) {
    const reason = prompt('Reason for placing this bay on hold:', '');
    
    if (reason === null) return; // User cancelled
    
    if (!reason.trim()) {
        alert('âš ï¸ Please provide a reason for the hold');
        return;
    }
    
    fetch(API + '/api/holds/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            bay_location: location,
            reason: reason.trim()
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('ğŸ”’ Bay placed on hold: ' + result.hold_location);
            closeModal('bay-modal');
            loadBaysData();
            loadStats();
        } else {
            alert('âŒ Failed to place hold: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Hold error:', err);
        alert('âŒ Error: ' + err.message);
    });
}

function returnHoldFromBayModal(location) {
    // Find the hold for this bay
    fetch(API + '/api/holds')
        .then(r => r.json())
        .then(holds => {
            const hold = holds.find(h => h.original_bay === location);
            
            if (!hold) {
                alert('âŒ Hold not found for this bay');
                return;
            }
            
            if (!confirm('Return hold ' + hold.location + ' back to bay ' + location + '?')) {
                return;
            }
            
            fetch(API + '/api/holds/' + hold.location + '/return', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showToast('âœ… Hold returned to ' + location);
                    closeModal('bay-modal');
                    loadBaysData();
                    loadStats();
                } else {
                    alert('âŒ Failed to return hold: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Return error:', err);
                alert('âŒ Error: ' + err.message);
            });
        })
        .catch(err => {
            console.error('Error loading holds:', err);
            alert('âŒ Error loading hold info');
        });
}

function moveHoldFromModal(holdLocation) {
    console.log('Moving hold:', holdLocation);
    
    // Check if bay-details element exists before proceeding
    const modalContent = document.getElementById('bay-details');
    if (!modalContent) {
        console.error('Modal content not found, using moveHold instead');
        moveHold(holdLocation);
        return;
    }
    
    // Show the move interface using moveHold
    moveHold(holdLocation);
}
function searchSKUs(){
    const term=document.getElementById('searchInput').value.trim().toLowerCase();
    if(term.length<2){
        document.getElementById('searchResults').innerHTML='';
        return;
    }
    
    fetch(API+'/api/search/'+encodeURIComponent(term))
        .then(r=>r.json())
        .then(results=>{
            if(results.length===0){
                document.getElementById('searchResults').innerHTML='<div style="background:#fee2e2;padding:20px;border-radius:10px;margin-top:10px"><h3>âŒ Not Found</h3><p>No results for <strong>'+term+'</strong></p></div>';
                setTimeout(()=>{
                    document.getElementById('searchInput').value='';
                    document.getElementById('searchInput').focus();
                },1500);
                return;
            }
            
            // Check if it's a location search (has dash or starts with letters like AA, BB, etc)
            const isLocationSearch = term.includes('-') || /^(aa|bb|cc|dd|ee|ff|gg|hh)/.test(term);
            console.log('Search term:', term, 'Is location search:', isLocationSearch);
            
            let html='<div style="background:#d1fae5;padding:20px;border-radius:10px;margin-bottom:15px"><h3>âœ… Found Results</h3></div>';
            
            results.forEach(loc=>{
                // Filter SKUs based on search type
                let filteredSkus = loc.skus;
                if(!isLocationSearch){
                    // Product/SKU search - only show matching items
                    filteredSkus = loc.skus.filter(sku => 
                        sku.code.toLowerCase().includes(term) || 
                        (sku.name && sku.name.toLowerCase().includes(term))
                    );
                }
                
                // Only show location if it has matching SKUs
                if(filteredSkus.length > 0){
                    html+='<div class="result-item" style="font-size:16px;padding:20px;background:white;border:2px solid #e5e7eb;border-radius:10px;margin-bottom:15px">';
                    
                    // Location header with buttons
                    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
                    html+='<div>';
                    html+='<strong style="font-size:20px;color:#c62828">'+loc.location+'</strong> ';
                    html+='<span class="location-badge '+loc.locationType+'">'+loc.locationType.toUpperCase()+'</span>';
                    html+='</div>';
                    
                    // Add action buttons for pallet bays
                    if(loc.locationType === 'pallet'){
                        html+='<div style="display:flex;gap:10px">';
                        html+='<button class="btn-small" onclick="viewBay(\''+loc.location+'\')" style="background:#6366f1;padding:10px 15px">ğŸ‘ï¸ View Bay</button>';
                        html+='<button class="btn-small" onclick="quickEditFromSearch(\''+loc.location+'\')" style="background:#059669;padding:10px 15px">âœï¸ Quick Edit</button>';
                        html+='</div>';
                    } else if(loc.locationType === 'hold'){
                        html+='<button class="btn-small" onclick="viewHold(\''+loc.location+'\')" style="background:#f59e0b;padding:10px 15px">ğŸ‘ï¸ View Hold</button>';
                    }
                    
                    html+='</div>';
                    
                    // SKU list
                    html+='<div style="background:#f9fafb;border-radius:8px;padding:15px;margin-top:10px">';
                    filteredSkus.forEach(sku=>{
                        html+='<div style="margin:10px 0;font-size:16px;padding:8px;border-bottom:1px solid #e5e7eb">';
                        html+='<strong style="font-size:18px;color:#c62828">'+sku.code+'</strong>';
                        html+=(sku.name?' <span style="color:#666">- '+sku.name+'</span>':'');
                        html+=(sku.quantity?' <span style="color:#059669;font-weight:700;float:right">Ã—'+sku.quantity+'</span>':'');
                        html+='</div>';
                    });
                    html+='</div>';
                    
                    html+='</div>';
                }
            });
            
            document.getElementById('searchResults').innerHTML=html;
            
            // Clear search box and refocus for next scan
            setTimeout(()=>{
                document.getElementById('searchInput').value='';
                document.getElementById('searchInput').focus();
            },2000);
        });
}

function loadBundles() {
    fetch(API + '/api/bundles')
        .then(r => r.json())
        .then(bundles => {
            allBundles = bundles;
            displayBundles(bundles);
        })
        .catch(err => {
            console.error('Error loading bundles:', err);
            document.getElementById('bundlesList').innerHTML = 
                '<p style="color:#dc2626;padding:20px">âš ï¸ Error loading bundles</p>';
        });
}

function displayBundles(bundles) {
    const container = document.getElementById('bundlesList');
    
    if (bundles.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px;background:#f9fafb;border-radius:10px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ“š</div>
                <h3 style="color:#666">No Bundles Found</h3>
                <p style="color:#999;font-size:14px;margin-top:10px">Import bundles from the Admin tab</p>
            </div>`;
        return;
    }
    
    let html = '<h3 style="margin-bottom:20px">All Bundles (' + bundles.length + ')</h3>';
    html += '<div style="display:grid;gap:15px">';
    
    bundles.forEach(bundle => {
        html += `
            <div class="result-item" onclick="viewBundleDetail('${escapeJs(bundle.bundle_code)}')" 
                 style="cursor:pointer;transition:all 0.2s;background:white;border:2px solid #e5e7eb;padding:20px;border-radius:10px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="flex:1">
                        <div style="font-size:18px;font-weight:700;color:#c62828;margin-bottom:5px">
                            ${escapeHtml(bundle.bundle_code)}
                        </div>
                        <div style="font-size:14px;color:#666">
                            ${escapeHtml(bundle.bundle_name)}
                        </div>
                    </div>
                    <div style="color:#059669;font-size:24px">â†’</div>
                </div>
            </div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function viewBundleDetail(bundleCode) {
    console.log('Loading bundle:', bundleCode);
    
    fetch(API + '/api/bundle/' + encodeURIComponent(bundleCode))
        .then(r => r.json())
        .then(data => {
            displayBundleDetailModal(data, bundleCode);
        })
        .catch(err => {
            console.error('Error loading bundle:', err);
            alert('âŒ Error loading bundle: ' + err.message);
        });
}

function displayBundleDetailModal(data, bundleCode) {
    const bundle = data.bundle || { bundle_code: bundleCode, bundle_name: 'Unknown' };
    const components = data.components || [];
    
    let html = `
        <h2>ğŸ“š ${escapeHtml(bundle.bundle_code)}</h2>
        <p style="font-size:16px;color:#666;margin:10px 0 20px 0">
            ${escapeHtml(bundle.bundle_name)}
        </p>
        
        <h3 style="margin-top:20px;margin-bottom:15px">ğŸ“¦ Components (${components.length})</h3>`;
    
    if (components.length === 0) {
        html += '<p style="text-align:center;padding:40px;background:#f9fafb;border-radius:8px;color:#666">No components defined</p>';
    } else {
        html += '<div style="background:white;border-radius:10px;overflow:hidden;border:2px solid #e5e7eb">';
        html += '<table style="width:100%">';
        html += `<thead>
            <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">SKU</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">Product</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#666">Qty Needed</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#666">Locations</th>
            </tr>
        </thead>`;
        html += '<tbody>';
        
        components.forEach((comp, idx) => {
            const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            html += `<tr style="background:${bgColor};border-bottom:1px solid #e5e7eb">
                <td style="padding:12px;font-weight:700;color:#c62828;font-size:14px">${escapeHtml(comp.sku)}</td>
                <td style="padding:12px;font-size:13px;color:#333">${escapeHtml(comp.productName || 'N/A')}</td>
                <td style="padding:12px;text-align:center;font-weight:700;font-size:16px;color:#059669">Ã—${comp.quantityNeeded}</td>
                <td style="padding:12px">`;
            
            if (comp.locations && comp.locations.length > 0) {
                comp.locations.forEach(loc => {
                    html += `<span class="location-badge ${loc.location_type}" style="margin:2px">${escapeHtml(loc.location)}`;
                    if (loc.quantity) html += ' (' + loc.quantity + ')';
                    html += '</span> ';
                });
            } else {
                html += '<span style="color:#dc2626;font-size:12px">âš ï¸ Not in inventory</span>';
            }
            
            html += `</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    html += `
        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-secondary" onclick="closeModal('bay-modal')">Close</button>
        </div>`;
    
    document.getElementById('bay-details').innerHTML = html;
    document.getElementById('bay-modal').classList.add('active');
}

function searchBundles(term) {
    if (!term || term.length < 2) {
        displayBundles(allBundles);
        return;
    }
    
    const matches = allBundles.filter(b => 
        b.bundle_code.toLowerCase().includes(term.toLowerCase()) || 
        b.bundle_name.toLowerCase().includes(term.toLowerCase())
    );
    
    displayBundles(matches);
}

function loadHolds(){
fetch(API+'/api/holds').then(r=>r.json()).then(holds=>{
let html='';
holds.forEach(h=>{
html+='<div class="result-item" onclick="viewHold(\''+h.location+'\')"><h3>'+h.location+'</h3><span class="location-badge hold">ON HOLD</span><p>Original Bay: '+(h.original_bay||'N/A')+'</p><p>Reason: '+(h.reason||'N/A')+'</p><p><strong>SKUs: '+(h.sku_count||0)+'</strong></p>';
if(h.sku_list){
html+='<p style="font-size:12px;color:#666;margin-top:5px">'+h.sku_list+'</p>';
}
html+='<div style="margin-top:10px"><button class="btn btn-small" onclick="event.stopPropagation();returnHold(\''+h.location+'\')">Return to Bay</button><button class="btn btn-small" onclick="event.stopPropagation();moveHold(\''+h.location+'\')">Move to New Bay</button></div></div>';
});
document.getElementById('holdsList').innerHTML=html||'<p>No active holds</p>';
});
}

function returnHold(loc){
if(!confirm('Return to original bay?'))return;
fetch(API+'/api/holds/'+loc+'/return',{method:'POST'}).then(()=>{
alert('Returned!');
loadHolds();
loadBaysData();
loadStats();
});
}

function moveHold(loc){
    // Show modal with autocomplete
    const modalHtml = `
        <h2>Move Hold ${escapeHtml(loc)} to New Bay</h2>
        <p>Type or select destination bay:</p>
        <input type="text" id="holdMoveLocation" placeholder="Type bay location..." 
               style="width:100%;padding:14px;font-size:16px;margin:10px 0" 
               oninput="suggestBaysForHold()" autocomplete="off">
        <div id="holdBaySuggestions" 
             style="background:white;border:2px solid #e0d8cc;border-radius:8px;max-height:300px;overflow-y:auto;margin:10px 0">
        </div>
        <button class="btn" onclick="confirmHoldMove('${escapeJs(loc)}')">Confirm Move</button>
        <button class="btn btn-secondary" onclick="closeModal('bay-modal')">Cancel</button>
    `;
    
    const modalContent = document.getElementById('bay-details');
    if (modalContent) {
        modalContent.innerHTML = modalHtml;
        document.getElementById('bay-modal').classList.add('active');
        
        // Focus input and show suggestions
        setTimeout(() => {
            const input = document.getElementById('holdMoveLocation');
            if (input) {
                input.focus();
                suggestBaysForHold(); // Show initial list
            }
        }, 100);
    } else {
        console.error('Modal content element not found');
    }
}

function suggestBaysForHold() {
    const input = document.getElementById('holdMoveLocation');
    const list = document.getElementById('holdBaySuggestions');
    
    if (!input || !list) return;

    const query = input.value.toUpperCase().trim();
    
    // Filter for empty bays
    const emptyBays = (allBays || []).filter(b =>
        b.display_status === 'empty' &&
        (!query || b.location.includes(query))
    ).slice(0, 30);

    if (emptyBays.length === 0) {
        list.innerHTML = '<div style="padding:15px;color:#dc2626">No empty bays available</div>';
        list.style.display = 'block';
        return;
    }

    let html = '<div style="padding:10px;background:#f5f0e8;font-weight:600">Available Empty Bays</div>';
    emptyBays.forEach(bay => {
        html += `
            <div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer;font-size:15px" 
                 onclick="selectHoldTransferBay('${escapeJs(bay.location)}')"
                 onmouseenter="this.style.background='#f5f0e8'"
                 onmouseleave="this.style.background='white'">
                ${escapeHtml(bay.location)} <span style="color:#10b981;font-size:12px">â— Empty</span>
            </div>
        `;
    });
    
    list.innerHTML = html;
    list.style.display = 'block';
}

function selectHoldTransferBay(location) {
    const input = document.getElementById('holdMoveLocation');
    const list = document.getElementById('holdBaySuggestions');
    
    if (input) input.value = location;
    if (list) list.style.display = 'none';
}

function confirmHoldMove(holdLoc) {
    const input = document.getElementById('holdMoveLocation');
    const dest = (input?.value || '').trim().toUpperCase();
    
    if (!dest) {
        alert('âš ï¸ Enter a destination bay');
        return;
    }

    // Validate destination bay
    const destBay = (allBays || []).find(b => b.location === dest);
    if (!destBay) {
        alert(`âŒ Bay ${dest} not found`);
        return;
    }
    
    if (destBay.display_status !== 'empty') {
        alert(`âŒ Bay ${dest} is not empty. Please choose an empty bay.`);
        return;
    }

    // Show loading state
    const modalContent = document.getElementById('bay-details');
    if (modalContent) {
        modalContent.innerHTML = `
            <h2>ğŸšš Moving Hold...</h2>
            <p style="text-align:center;padding:40px;font-size:16px">
                Moving ${escapeHtml(holdLoc)} to ${escapeHtml(dest)}<br>
                <span style="color:#666">Please wait...</span>
            </p>
        `;
    }

    // Perform the move
    fetch(API + '/api/holds/' + encodeURIComponent(holdLoc) + '/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_bay: dest })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Server returned ' + res.status);
        }
        return res.json();
    })
    .then(result => {
        if (result.success) {
            // Show success message in modal
            const modalContent = document.getElementById('bay-details');
            if (modalContent) {
                modalContent.innerHTML = `
                    <div style="text-align:center;padding:40px">
                        <h2 style="color:#059669">âœ… Hold Moved Successfully!</h2>
                        <p style="font-size:18px;margin:20px 0">
                            <strong>${escapeHtml(holdLoc)}</strong> â†’ <strong>${escapeHtml(dest)}</strong>
                        </p>
                        <button class="btn" onclick="closeModal('bay-modal');loadStats();loadBaysData();">Done</button>
                    </div>
                `;
            } else {
                // Fallback if modal is somehow closed
                showToast('âœ… Hold moved to ' + dest);
                closeModal('bay-modal');
                loadStats();
                loadBaysData();
            }
        } else {
            alert('âŒ Move failed: ' + (result.error || 'Unknown error'));
            closeModal('bay-modal');
        }
    })
    .catch(err => {
        console.error('Move error:', err);
        alert('âŒ Error moving hold: ' + err.message);
        closeModal('bay-modal');
    });
}

// ============================================
// ARCHIVED SKUs MANAGEMENT
// ============================================

function archiveSKU(sku) {
    if (!confirm(`Archive ${sku}?\n\nThis will:\nâ€¢ Keep it in your WMS\nâ€¢ Prevent it from syncing from ShipStation\nâ€¢ Mark it as discontinued/old`)) {
        return;
    }
    
    fetch(API + '/api/sku/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: sku })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… ' + result.message);
            if (typeof searchProducts === 'function') searchProducts();
            if (typeof loadAllocationQueue === 'function') loadAllocationQueue();
        } else {
            alert('âŒ Failed to archive: ' + result.error);
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}
function unarchiveSKU(sku) {
    if (!confirm(`Unarchive ${sku}?\n\nThis will allow it to sync from ShipStation again.`)) {
        return;
    }
    
    fetch(API + '/api/sku/unarchive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: sku })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('âœ… ' + result.message);
            viewArchivedSKUs();
        } else {
            alert('âŒ Failed to unarchive: ' + result.error);
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// View all archived SKUs
function viewArchivedSKUs() {
  document.getElementById('archived-skus-content').innerHTML = '<h2>ğŸ—„ï¸ Archived SKUs</h2><p style="text-align:center;padding:40px">Loading...</p>';
  document.getElementById('archived-skus-modal').classList.add('active');
  
  fetch(API + '/api/sku/archived')
    .then(r => r.json())
    .then(skus => {
      displayArchivedSKUs(skus);
    })
    .catch(err => {
      console.error('Error loading archived SKUs:', err);
      document.getElementById('archived-skus-content').innerHTML = 
        '<h2>âŒ Error</h2><p>Failed to load archived SKUs</p>';
    });
}

function displayArchivedSKUs(skus) {
  let html = `
    <h2>ğŸ—„ï¸ Archived SKUs (${skus.length})</h2>
    <p style="color:#666;margin-bottom:20px">
      These SKUs are blocked from ShipStation imports. You can restore or permanently delete them.
    </p>
  `;
  
  if (skus.length === 0) {
    html += '<p style="text-align:center;padding:40px;color:#666">No archived SKUs</p>';
  } else {
    html += '<div style="max-height:500px;overflow-y:auto">';
    
    skus.forEach(sku => {
      html += `
        <div style="border:2px solid #e0d8cc;border-radius:8px;padding:15px;margin:10px 0;background:#f9f9f9">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div style="flex:1">
              <strong style="font-size:16px">${escapeHtml(sku.sku_code)}</strong><br>
              <span style="color:#666;font-size:14px">${escapeHtml(sku.product_name || 'N/A')}</span><br>
              <small style="color:#999">
                Last location: ${escapeHtml(sku.location || 'Unknown')} â€¢ 
                Archived: ${new Date(sku.created_at || Date.now()).toLocaleDateString()}
              </small>
            </div>
            <div style="display:flex;gap:10px">
              <button class="btn btn-small" onclick="restoreArchivedSKU('${escapeJs(sku.sku_code)}')" 
                style="background:#059669">
                â†©ï¸ Restore
              </button>
              <button class="btn btn-small btn-danger" onclick="deleteArchivedSKU('${escapeJs(sku.sku_code)}')">
                ğŸ—‘ï¸ Delete
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
  }
  
  html += '<button class="btn btn-secondary" onclick="closeModal(\'archived-skus-modal\')" style="margin-top:20px">Close</button>';
  
  document.getElementById('archived-skus-content').innerHTML = html;
}


// Unarchive SKU
function unarchiveSKU(skuCode) {
    if (!confirm(`Unarchive ${skuCode}?\n\nThis will:\n- Make it searchable again\n- Allow it to import from ShipStation`)) {
        return;
    }
    
    fetch(API + '/api/admin/unarchive-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: skuCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Unarchived ${skuCode}`);
            viewArchivedSKUs(); // Refresh list
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// Restore an archived SKU
function restoreArchivedSKU(skuCode) {
  if (!confirm(`Restore ${skuCode}?\n\nThis SKU will be imported again from ShipStation on the next sync.`)) {
    return;
  }
  
  fetch(API + '/api/sku/unarchive', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sku_code: skuCode })
  })
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('âœ… ' + skuCode + ' restored');
        viewArchivedSKUs(); // Refresh list
        loadAllocationQueue(); // Refresh allocation queue
      } else {
        alert('âŒ Failed to restore: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Error restoring SKU:', err);
      alert('âŒ Error: ' + err.message);
    });
}

// Permanently delete an archived SKU
function deleteArchivedSKU(skuCode) {
  if (!confirm(`âš ï¸ PERMANENTLY DELETE ${skuCode}?\n\nThis SKU will be blocked from all future imports and cannot be restored.\n\nAre you sure?`)) {
    return;
  }
  
  fetch(API + '/api/sku/archive-permanent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sku_code: skuCode })
  })
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('ğŸ—‘ï¸ ' + skuCode + ' permanently deleted');
        viewArchivedSKUs(); // Refresh list
      } else {
        alert('âŒ Failed to delete: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Error deleting SKU:', err);
      alert('âŒ Error: ' + err.message);
    });
}


function printBayLabel() {
    const aisle = document.getElementById('labelAisle').value;
    const bay = document.getElementById('labelBay').value;
    const height = document.getElementById('labelHeight').value;
    
    if (!aisle || !bay || !height) {
        alert('âŒ Please fill all fields');
        return;
    }
    
    const location = aisle + '-' + String(bay).padStart(2, '0') + '-' + height;
    
    // Check if bay exists
    fetch(API + '/api/bays/' + location)
        .then(r => {
            if (!r.ok) {
                throw new Error('Bay not found');
            }
            return r.json();
        })
        .then(data => {
            createPrintWindow(data, location);
        })
        .catch(err => {
            // Bay doesn't exist - offer to create blank label
            if (confirm('Bay ' + location + ' not found in system. Create a blank label anyway?')) {
                const blankData = {
                    bay: { location: location, status: 'empty' },
                    stock: []
                };
                createPrintWindow(blankData, location);
            }
        });
}

function printCustomLabel() {
    const location = document.getElementById('customLabel').value.trim().toUpperCase();
    
    if (!location) {
        alert('âŒ Please enter a location');
        return;
    }
    
    // Create simple label for custom locations (shelves, holds, etc.)
    const printWindow = window.open('', '_blank', 'width=800,height=600,menubar=no,toolbar=no');
    
    if (!printWindow) {
        alert('âŒ Please allow popups to print labels');
        return;
    }
    
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    
    const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Label - ' + location + '</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f5f5f5}.label{border:5px solid #2c2c2c;padding:60px 80px;background:white;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.15)}.location{font-size:120px;font-weight:900;line-height:1;color:#2c2c2c;letter-spacing:-4px}.company{font-size:24px;color:#c62828;font-weight:700;margin-top:30px;letter-spacing:2px}.date{font-size:14px;color:#999;margin-top:15px}.no-print{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:10px}.btn{background:#c62828;color:white;border:none;padding:15px 40px;font-size:18px;border-radius:8px;cursor:pointer}.btn:hover{background:#a02020}.btn-secondary{background:#6b7280}.btn-secondary:hover{background:#4b5563}@media print{body{background:white}.label{box-shadow:none}.no-print{display:none!important}}</style></head><body><div class="label"><div class="location">' + location + '</div><div class="company">ALTERNATIVE BREWING</div><div class="date">' + dateStr + '</div></div><div class="no-print"><button class="btn" onclick="window.print()">ğŸ–¨ï¸ Print</button><button class="btn btn-secondary" onclick="window.close()">âœ• Close</button></div></body></html>';
    
    printWindow.document.write(html);
    printWindow.document.close();
}


function importShelf(){
const file=document.getElementById('shelfFile').files[0];
if(!file){alert('Select file');return;}
const form=new FormData();
form.append('file',file);
document.getElementById('importStatus').innerHTML='<p>Importing...</p>';
fetch(API+'/api/import-shelf-stock',{method:'POST',body:form}).then(r=>r.json()).then(result=>{
document.getElementById('importStatus').innerHTML='<p style="background:#d1fae5;padding:15px;border-radius:8px">'+result.message+'</p>';
loadStats();
});
}

function importBundles() {
    const fileInput = document.getElementById('bundleFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('âš ï¸ Please select a file first');
        return;
    }
    
    // Show loading state
    const originalHTML = document.querySelector('button[onclick="importBundles()"]').innerHTML;
    document.querySelector('button[onclick="importBundles()"]').innerHTML = 'â³ Importing...';
    document.querySelector('button[onclick="importBundles()"]').disabled = true;
    
    const formData = new FormData();
    formData.append('file', file);
    
    console.log('Starting bundle import...');
    
    fetch(API + '/api/import-bundles', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Import result:', result);
        
        if (result.success) {
            alert('âœ… ' + result.message);
            fileInput.value = '';
            
            // Show detailed results if available
            if (result.errors && result.errors.length > 0) {
                console.warn('Import errors:', result.errors);
                alert('âš ï¸ Some issues occurred:\n\n' + result.errors.join('\n'));
            }
        } else {
            alert('âŒ Import failed: ' + result.message);
        }
        
        // Restore button
        document.querySelector('button[onclick="importBundles()"]').innerHTML = originalHTML;
        document.querySelector('button[onclick="importBundles()"]').disabled = false;
    })
    .catch(err => {
        console.error('Import error:', err);
        alert('âŒ Import failed: ' + err.message + '\n\nCheck console for details.');
        
        // Restore button
        document.querySelector('button[onclick="importBundles()"]').innerHTML = originalHTML;
        document.querySelector('button[onclick="importBundles()"]').disabled = false;
    });
}

function cleanupDuplicates(){
    if(!confirm('Remove duplicate entries?\n\nThis only removes SKUs that appear MULTIPLE TIMES in the SAME location.\n\nIt will NOT delete stock from different bays.'))return;
    fetch(API+'/api/cleanup-duplicates',{method:'POST'}).then(r=>r.json()).then(result=>{
        alert(result.message);
        loadStats();
    });
}
function viewHold(location){
fetch(API+'/api/holds/'+location).then(r=>r.json()).then(data=>{
let html='<h2>'+data.hold.location+'</h2>';
html+='<p><span class="location-badge hold">ON HOLD</span></p>';
html+='<p><strong>Original Bay:</strong> '+(data.hold.original_bay||'N/A')+'</p>';
html+='<h3>Stock:</h3>';
if(data.stock.length>0){
html+='<table><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Action</th></tr>';
data.stock.forEach(s=>{
html+='<tr><td>'+s.sku_code+'</td><td>'+(s.product_name||'N/A')+'</td><td>'+(s.quantity||'N/A')+'</td><td><button class="btn-danger btn-small" onclick="deleteHoldSKU(\''+location+'\',\''+s.sku_code+'\')">Delete</button></td></tr>';
});
html+='</table>';
}else{
html+='<p>No stock in this hold location</p>';
}
html+='<div style="background:#f5f5f5;padding:15px;margin:15px 0;border-radius:8px;position:relative"><h4>Add SKU to Hold</h4><input type="text" id="newHoldSKU" placeholder="Type SKU or Product Name..." style="margin:5px 0" oninput="searchSKUAutocompleteHold()" autocomplete="off"><div id="skuSuggestionsHold" style="display:none;background:white;border:2px solid #e0d8cc;border-radius:5px;max-height:200px;overflow-y:auto;position:absolute;width:calc(100% - 30px);z-index:100"></div><input type="text" id="newHoldProduct" placeholder="Product Name (optional)" style="margin:5px 0"><input type="number" id="newHoldQty" placeholder="Quantity (optional)" style="margin:5px 0"><button class="btn btn-small" onclick="addSKUToHold(\''+location+'\')">Add SKU</button></div>';
html+='<div style="margin-top:20px"><label>Reason/Notes:</label><textarea id="holdNotes" rows="3">'+(data.hold.reason||'')+'</textarea><button class="btn btn-small" style="margin-top:10px" onclick="saveHoldNotes(\''+location+'\')">Save Notes</button></div>';
html+='<div style="margin-top:15px"><button class="btn btn-small" onclick="returnHoldFromModal(\''+location+'\')">Return to Original Bay</button><button class="btn btn-small" onclick="moveHoldFromModal(\''+location+'\')">Move to New Bay</button></div>';
document.getElementById('bay-details').innerHTML=html;
document.getElementById('bay-modal').classList.add('active');
});
}

function searchSKUAutocompleteHold(){
const term=document.getElementById('newHoldSKU').value.trim();
const suggestionsDiv=document.getElementById('skuSuggestionsHold');
if(term.length<2){
suggestionsDiv.style.display='none';
return;
}
fetch(API+'/api/skus/search?q='+encodeURIComponent(term)).then(r=>r.json()).then(results=>{
if(results.length===0){
suggestionsDiv.style.display='none';
return;
}
let html='';
results.forEach(sku=>{
const productName=(sku.product_name||'').replace(/'/g,'&#39;');
html+='<div class="autocomplete-suggestion" onclick="selectHoldSKU(\''+sku.sku_code+'\',\''+productName+'\')">';
html+='<strong>'+sku.sku_code+'</strong>';
if(sku.product_name)html+='<br><small style="color:#666">'+sku.product_name+'</small>';
html+='</div>';
});
suggestionsDiv.innerHTML=html;
suggestionsDiv.style.display='block';
});
}

function selectHoldSKU(code,name){
document.getElementById('newHoldSKU').value=code;
document.getElementById('newHoldProduct').value=name;
document.getElementById('skuSuggestionsHold').style.display='none';
document.getElementById('newHoldQty').focus();
}

function addSKUToHold(location){
const sku=document.getElementById('newHoldSKU').value.trim();
const product=document.getElementById('newHoldProduct').value.trim();
const qty=document.getElementById('newHoldQty').value;
if(!sku){alert('Enter SKU code');return;}
fetch(API+'/api/holds/'+location+'/add-sku',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sku_code:sku,product_name:product,quantity:qty?parseInt(qty):null})}).then(()=>{
alert('SKU added to hold!');
viewHold(location);
loadStats();
});
}

function deleteHoldSKU(location,sku){
if(!confirm('Delete '+sku+' from this hold?'))return;
fetch(API+'/api/holds/'+location+'/sku/'+sku,{method:'DELETE'}).then(()=>{
alert('SKU deleted!');
viewHold(location);
loadStats();
});
}

function saveHoldNotes(location){
const notes=document.getElementById('holdNotes').value;
fetch(API+'/api/holds/'+location+'/notes',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({reason:notes})}).then(()=>{
alert('Notes saved!');
closeModal('bay-modal');
loadHolds();
});
}

function returnHoldFromModal(holdLocation) {
    console.log('Returning hold to bay:', holdLocation);
    
    if (!confirm('Return this hold to its original bay?\n\nThis will move all items back and release the hold.')) {
        return;
    }
    
    // Show loading state (check if modal still exists first)
    const modalContent = document.getElementById('bay-details');
    if (modalContent) {
        modalContent.innerHTML = `
            <h2>ğŸ”„ Returning to Bay...</h2>
            <p style="text-align:center;padding:40px;font-size:16px">
                Moving items back to original location<br>
                <span style="color:#666">Please wait...</span>
            </p>
        `;
    }
    
    fetch(API + '/api/holds/' + encodeURIComponent(holdLocation) + '/return', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(result => {
        if (result.success) {
            // Check if modal content still exists before updating
            const modalContent = document.getElementById('bay-details');
            
            if (modalContent && document.getElementById('bay-modal').classList.contains('active')) {
                // Modal is still open - show success message
                modalContent.innerHTML = `
                    <div style="text-align:center;padding:40px">
                        <h2 style="color:#059669">âœ… Hold Returned!</h2>
                        <p style="font-size:18px;margin:20px 0">
                            Items moved back to <strong>${escapeHtml(result.original_bay || 'bay')}</strong>
                        </p>
                        <button class="btn" onclick="closeModalAndRefresh('${escapeJs(result.original_bay)}')">View Bay</button>
                        <button class="btn btn-secondary" onclick="closeModalAndRefresh()">Close</button>
                    </div>
                `;
            } else {
                // Modal was closed - just show toast and refresh
                showToast('âœ… Hold returned to ' + (result.original_bay || 'bay'));
                loadStats();
                loadBaysData();
            }
        } else {
            alert('âŒ Failed to return hold: ' + (result.error || 'Unknown error'));
            const modal = document.getElementById('bay-modal');
            if (modal && modal.classList.contains('active')) {
                closeModal('bay-modal');
            }
        }
    })
    .catch(err => {
        console.error('Return error:', err);
        alert('âŒ Error returning hold: ' + err.message);
        const modal = document.getElementById('bay-modal');
        if (modal && modal.classList.contains('active')) {
            closeModal('bay-modal');
        }
    });
}

// Helper function to close modal and refresh
function closeModalAndRefresh(bayToView) {
    closeModal('bay-modal');
    loadStats();
    loadBaysData();
    
    if (bayToView) {
        setTimeout(() => {
            viewBay(bayToView);
        }, 500);
    }
}


function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.warn('Modal not found:', modalId);
        return;
    }
    
    modal.classList.remove('active');
    
    // Clear modal content on close (prevents stale data)
    const contentIds = {
        'bay-modal': 'bay-details',
        'quick-edit-modal': 'quick-edit-content',
        'create-pallet-modal': 'create-pallet-content',
        'add-sku-modal': 'add-sku-content',
        'pallet-details-modal': 'pallet-details-content',
        'bay-suggestions-modal': 'bay-suggestions-content',
        'archived-skus-modal': 'archived-skus-content'
    };
    
    const contentId = contentIds[modalId];
    if (contentId) {
        const content = document.getElementById(contentId);
        if (content) {
            // Don't clear immediately - let animation finish
            setTimeout(() => {
                if (!modal.classList.contains('active')) {
                    content.innerHTML = '';
                }
            }, 300);
        }
    }
    
    // Re-enable body scroll
    document.body.style.overflow = '';
}

function cleanupBundleDuplicates(){
if(!confirm('Remove duplicate bundle components?'))return;
fetch(API+'/api/cleanup-bundle-duplicates',{method:'POST'}).then(r=>r.json()).then(result=>{
alert(result.message);
loadBundles();
});
}
// Scroll to top button
window.onscroll = function() {
const btn = document.getElementById('scrollTopBtn');
if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
btn.style.display = 'block';
} else {
btn.style.display = 'none';
}
};

function scrollToTop() {
window.scrollTo({top: 0, behavior: 'smooth'});
}
function printPalletLabel(){
const loc=document.getElementById('palletLocation').value.trim().toUpperCase();
if(!loc){alert('Enter bay location');return;}

document.getElementById('labelPreview').innerHTML='<p>Loading pallet contents...</p>';

fetch(API+'/api/bays/'+loc).then(r=>r.json()).then(data=>{
if(!data.bay){
alert('Bay not found');
return;
}

let html='<div style="border:4px solid #2c2c2c;padding:25px;background:white;max-width:900px;margin:0 auto">';

// Header
html+='<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #c62828;padding-bottom:15px;margin-bottom:20px">';
html+='<div style="font-size:64px;font-weight:900;letter-spacing:-2px">'+loc+'</div>';
html+='<div style="text-align:right"><div style="font-size:14px;color:#c62828;font-weight:700">ALTERNATIVE BREWING</div><div style="font-size:12px;color:#666;margin-top:4px">'+new Date().toLocaleDateString()+'</div></div>';
html+='</div>';

if(data.stock.length>0){
html+='<div style="margin-bottom:12px;font-size:16px;font-weight:700;color:#2c2c2c">Contents: '+data.stock.length+' SKU'+(data.stock.length>1?'s':'')+'</div>';

// Two column layout for better space usage
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px 20px">';
data.stock.forEach(s=>{
html+='<div style="border-bottom:1px solid #e0e0e0;padding:8px 0;display:flex;justify-content:space-between;align-items:center">';
html+='<div style="flex:1"><div style="font-size:15px;font-weight:700;color:#2c2c2c">'+s.sku_code+'</div>';
html+='<div style="font-size:11px;color:#666;margin-top:2px;line-height:1.3">'+(s.product_name||'')+'</div></div>';
if(s.quantity)html+='<div style="font-size:22px;font-weight:900;color:#059669;margin-left:10px">Ã—'+s.quantity+'</div>';
html+='</div>';
});
html+='</div>';

// Summary
const totalQty=data.stock.reduce((sum,s)=>sum+(s.quantity||0),0);
if(totalQty>0){
html+='<div style="margin-top:20px;padding-top:15px;border-top:2px solid #e0e0e0;text-align:right;font-size:18px;font-weight:700">Total Units: <span style="color:#059669">'+totalQty+'</span></div>';
}
}else{
html+='<div style="text-align:center;padding:60px 20px;font-size:28px;color:#999;font-weight:700">EMPTY BAY</div>';
}

html+='</div>';
html+='<button class="btn" style="margin-top:15px" onclick="window.print()">Print Pallet Label</button>';

document.getElementById('labelPreview').innerHTML=html;
}).catch(err=>{
alert('Error loading pallet: '+err);
});
}
function exportInventory(){
document.getElementById('reportResults').innerHTML='<p>Generating export...</p>';
fetch(API+'/api/reports/inventory-export').then(r=>r.json()).then(data=>{
// Convert to CSV
let csv='Location,Location Type,SKU Code,Product Name,Quantity\n';
data.forEach(row=>{
csv+=`"${row.location}","${row.location_type}","${row.sku_code}","${row.product_name||''}","${row.quantity||''}"\n`;
});

// Download
const blob=new Blob([csv],{type:'text/csv'});
const url=window.URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download='warehouse-inventory-'+new Date().toISOString().split('T')[0]+'.csv';
a.click();

document.getElementById('reportResults').innerHTML='<div style="background:#d1fae5;padding:20px;border-radius:10px"><h3>âœ… Export Complete</h3><p>Downloaded '+data.length+' inventory records</p></div>';
});
}

function generateAisleReport(){
document.getElementById('reportResults').innerHTML='<p>Generating report...</p>';
fetch(API+'/api/reports/stock-by-aisle').then(r=>r.json()).then(data=>{
let html='<h3>Stock by Aisle</h3>';
html+='<p style="margin-bottom:15px;color:#666">Click any aisle to view all stock items</p>';
html+='<table><tr><th>Aisle</th><th>Total SKUs</th><th>Occupied Bays</th><th>Empty Bays</th><th>Utilization</th></tr>';
data.forEach(aisle=>{
const utilization=Math.round((aisle.occupied_bays/(aisle.occupied_bays+aisle.empty_bays))*100);
html+='<tr style="cursor:pointer" onclick="viewAisleDetail(\''+aisle.aisle+'\')"><td><strong>'+aisle.aisle+'</strong></td><td>'+aisle.total_skus+'</td><td>'+aisle.occupied_bays+'</td><td>'+aisle.empty_bays+'</td><td><strong>'+utilization+'%</strong></td></tr>';
});
html+='</table>';
document.getElementById('reportResults').innerHTML=html;
});
}

function viewAisleDetail(aisle){
document.getElementById('reportResults').innerHTML='<p>Loading '+aisle+' inventory...</p>';
fetch(API+'/api/reports/aisle-detail/'+aisle).then(r=>r.json()).then(data=>{
let html='<button class="btn btn-secondary" onclick="generateAisleReport()" style="margin-bottom:15px">â† Back to Summary</button>';
html+='<h3>Aisle '+aisle+' - Complete Inventory ('+data.length+' items)</h3>';
if(data.length===0){
html+='<p>No stock in this aisle</p>';
}else{
html+='<table><tr><th>Location</th><th>SKU</th><th>Product Name</th><th>Quantity</th></tr>';
data.forEach(item=>{
html+='<tr><td><strong>'+item.location+'</strong></td><td>'+item.sku_code+'</td><td>'+(item.product_name||'N/A')+'</td><td>'+(item.quantity||'N/A')+'</td></tr>';
});
html+='</table>';
}
document.getElementById('reportResults').innerHTML=html;
});
}

function generateCapacityReport(){
document.getElementById('reportResults').innerHTML='<p>Loading capacity data...</p>';
fetch(API+'/api/stats').then(r=>r.json()).then(stats=>{
const total=stats.palletBays.total_bays;
const empty=stats.emptyBays||0;
const occupied=stats.occupiedBays||0;
const holds=stats.activeHolds||0;
const usedPercent=Math.round((occupied/total)*100);
const availablePercent=Math.round((empty/total)*100);

let html='<h3>Warehouse Capacity Overview</h3>';
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0">';
html+='<div style="background:#d1fae5;padding:20px;border-radius:10px;text-align:center"><div style="font-size:48px;font-weight:900;color:#065f46">'+empty+'</div><div>Empty Bays</div><div style="font-size:24px;margin-top:5px">'+availablePercent+'%</div></div>';
html+='<div style="background:#dbeafe;padding:20px;border-radius:10px;text-align:center"><div style="font-size:48px;font-weight:900;color:#1e40af">'+occupied+'</div><div>Occupied Bays</div><div style="font-size:24px;margin-top:5px">'+usedPercent+'%</div></div>';
html+='<div style="background:#fef3c7;padding:20px;border-radius:10px;text-align:center"><div style="font-size:48px;font-weight:900;color:#92400e">'+holds+'</div><div>On Hold</div></div>';
html+='<div style="background:#f5f0e8;padding:20px;border-radius:10px;text-align:center"><div style="font-size:48px;font-weight:900;color:#2c2c2c">'+total+'</div><div>Total Bays</div></div>';
html+='</div>';
html+='<div style="background:#e5e7eb;border-radius:10px;overflow:hidden;height:40px;margin:20px 0"><div style="background:#10b981;height:100%;width:'+usedPercent+'%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600">'+usedPercent+'% Full</div></div>';
document.getElementById('reportResults').innerHTML=html;
});
}

function generateEmptyBaysReport(){
document.getElementById('reportResults').innerHTML='<p>Finding empty bays...</p>';
fetch(API+'/api/bays').then(r=>r.json()).then(bays=>{
const emptyBays=bays.filter(b=>b.display_status==='empty');
let html='<h3>Empty Bays ('+emptyBays.length+' available)</h3>';
html+='<p style="margin:10px 0">Click any bay to view details and add stock</p>';
const byAisle={};
emptyBays.forEach(b=>{
if(!byAisle[b.aisle])byAisle[b.aisle]=[];
byAisle[b.aisle].push(b);
});
Object.keys(byAisle).sort().forEach(aisle=>{
html+='<div style="margin:20px 0"><h4>Aisle '+aisle+' ('+byAisle[aisle].length+' empty)</h4>';
byAisle[aisle].forEach(bay=>{
html+='<div class="bay-cell empty" onclick="viewBay(\''+bay.location+'\')">'+bay.location+'</div>';
});
html+='</div>';
});
document.getElementById('reportResults').innerHTML=html;
});
}
function findBadLocations(){
document.getElementById('badLocationResults').innerHTML='<p>Searching...</p>';
fetch(API+'/api/admin/bad-locations').then(r=>r.json()).then(data=>{
if(data.length===0){
document.getElementById('badLocationResults').innerHTML='<p style="color:green">âœ“ No bad locations found!</p>';
return;
}
let html='<p style="color:red;font-weight:600">Found '+data.length+' items with invalid locations:</p>';
html+='<table style="font-size:12px"><tr><th>Current Location</th><th>SKU</th><th>Product</th><th>Action</th></tr>';
data.forEach(item=>{
html+='<tr><td>'+item.location+'</td><td>'+item.sku_code+'</td><td>'+(item.product_name||'N/A')+'</td><td><button class="btn-small btn-danger" onclick="deleteBadLocation(\''+item.location+'\',\''+item.sku_code+'\')">Delete</button></td></tr>';
});
html+='</table>';
document.getElementById('badLocationResults').innerHTML=html;
});
}

function deleteBadLocation(location, sku){
if(!confirm('Delete '+sku+' from invalid location '+location+'?'))return;
fetch(API+'/api/admin/delete-bad-location',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({location,sku_code:sku})
}).then(()=>{
alert('Deleted!');
findBadLocations();
loadStats();
});
}
function cleanupOrphanedHolds(){
if(!confirm('Clean up holds with no stock?'))return;
fetch(API+'/api/admin/cleanup-holds',{method:'POST'}).then(r=>r.json()).then(result=>{
alert('Cleaned '+result.cleaned+' orphaned holds');
loadStats();
loadHolds();
});
}
function startBulkAdd(){
if(bulkAddMode){
// Complete the bulk add
completeBulkAdd();
}else{
// Start selection mode
bulkAddMode = true;
selectedBays = [];
document.getElementById('bulkAddStatus').style.display='block';
document.getElementById('bulkAddStatus').innerHTML='<strong>Bulk Add Mode:</strong> Click bays to select them. Selected: <strong>0</strong>';
document.getElementById('clearBulkBtn').style.display='inline-block';
document.querySelectorAll('.bay-cell').forEach(cell => cell.classList.add('selecting'));
// Change button text
event.target.innerHTML='Complete Selection & Add SKU';
event.target.classList.add('btn-secondary');
}
}

function clearBulkSelection(){
bulkAddMode = false;
selectedBays = [];
document.getElementById('bulkAddStatus').style.display='none';
document.getElementById('clearBulkBtn').style.display='none';
document.querySelectorAll('.bay-cell').forEach(cell => {
cell.classList.remove('selecting', 'selected');
});
// Reset button
const btn = document.querySelector('button[onclick="startBulkAdd()"]');
if(btn){
btn.innerHTML='Bulk Add SKU to Multiple Bays';
btn.classList.remove('btn-secondary');
}
}

function completeBulkAdd(){
if(selectedBays.length === 0){
alert('No bays selected!');
clearBulkSelection();
return;
}

// Show modal with SKU input
const baysList = selectedBays.join(', ');
const modalHtml=`
<h2>Bulk Add SKU to ${selectedBays.length} Bays</h2>
<p style="background:#f5f0e8;padding:10px;border-radius:5px;margin:10px 0;font-size:13px"><strong>Selected bays:</strong> ${baysList}</p>
<div style="margin:15px 0">
<label>SKU Code:</label>
<input type="text" id="bulkSKU" placeholder="e.g., DESKY" style="width:100%;margin:5px 0">
<label>Product Name (optional):</label>
<input type="text" id="bulkProduct" placeholder="e.g., Desky Overflow Stock" style="width:100%;margin:5px 0">
<label>Quantity per bay (optional):</label>
<input type="number" id="bulkQty" placeholder="Leave blank if not tracking" style="width:100%;margin:5px 0">
</div>
<button class="btn" onclick="executeBulkAdd()">Add to All ${selectedBays.length} Bays</button>
<button class="btn btn-secondary" onclick="closeModal('bay-modal');clearBulkSelection()">Cancel</button>
`;

document.getElementById('bay-details').innerHTML=modalHtml;
document.getElementById('bay-modal').classList.add('active');
document.getElementById('bulkSKU').focus();
}

function executeBulkAdd(){
const sku = document.getElementById('bulkSKU').value.trim().toUpperCase();
const product = document.getElementById('bulkProduct').value.trim();
const qty = document.getElementById('bulkQty').value;

if(!sku){
alert('Enter SKU code');
return;
}

document.getElementById('bay-details').innerHTML='<h2>Adding SKU to bays...</h2><p>Please wait...</p>';

// Add to each bay sequentially
let completed = 0;
let errors = 0;

selectedBays.forEach((location, index) => {
fetch(API+'/api/bays/'+location+'/add-sku',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
sku_code: sku,
product_name: product || sku,
quantity: qty ? parseInt(qty) : null
})
}).then(r => {
completed++;
if(completed + errors === selectedBays.length){
finishBulkAdd(completed, errors, sku);
}
}).catch(err => {
errors++;
console.error('Error adding to', location, err);
if(completed + errors === selectedBays.length){
finishBulkAdd(completed, errors, sku);
}
});
});
}

function finishBulkAdd(success, errors, sku){
let html='<h2>âœ… Bulk Add Complete</h2>';
html+=`<p style="font-size:18px;margin:15px 0">Added <strong>${sku}</strong> to <strong>${success}</strong> bay(s)</p>`;
if(errors > 0){
html+=`<p style="color:#dc2626">Failed: ${errors} bay(s)</p>`;
}
html+='<button class="btn" onclick="closeModal(\'bay-modal\');clearBulkSelection();loadBaysData();loadStats()">Done</button>';
document.getElementById('bay-details').innerHTML=html;
}

function handleBayClick(location, event) {
    if (bulkAddMode) {
        // Toggle selection in bulk add mode
        const cell = event.target;
        if (selectedBays.includes(location)) {
            selectedBays = selectedBays.filter(b => b !== location);
            cell.classList.remove('selected');
        } else {
            selectedBays.push(location);
            cell.classList.add('selected');
        }
        document.getElementById('bulkAddStatus').innerHTML = 
            '<strong>Bulk Add Mode:</strong> Click bays to select them. Selected: <strong>' + selectedBays.length + '</strong>';
    } else {
        // Normal view mode
        const bayData = allBays.find(b => b.location === location);
        
        if (bayData && bayData.display_status === 'on_hold') {
            // Bay is on hold - show regular bay view (with hold management built-in)
            viewBay(location);
        } else {
            // Normal bay view
            viewBay(location);
        }
    }
}

function searchMap() {
    const query = document.getElementById('mapSearchInput').value.trim().toLowerCase();
    const resultsDiv = document.getElementById('mapSearchResults');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Search in all bays for SKUs or locations
    const matches = [];
    
    allBays.forEach(bay => {
        // Check if bay location matches
        if (bay.location.toLowerCase().includes(query)) {
            matches.push({
                type: 'location',
                bay: bay,
                reason: 'Bay location match'
            });
        }
    });
    
    // Search for SKUs in bays (requires API call for real-time data)
    fetch(API + '/api/search/' + encodeURIComponent(query))
        .then(r => r.json())
        .then(results => {
            if (results.length === 0 && matches.length === 0) {
                resultsDiv.innerHTML = '<p style="color:#666">No matches found for "' + query + '"</p>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '<strong>ğŸ” Search Results:</strong> ';
            
            // Show location matches
            if (matches.length > 0) {
                html += '<div style="margin-top:10px">';
                matches.slice(0, 5).forEach(match => {
                    html += '<button class="btn-small" onclick="highlightBay(\'' + match.bay.location + '\')" style="margin:3px">' + match.bay.location + '</button>';
                });
                html += '</div>';
            }
            
            // Show SKU matches
            if (results.length > 0) {
                html += '<div style="margin-top:10px"><strong>Found in:</strong> ';
                results.forEach(result => {
                    html += '<button class="btn-small" onclick="highlightBay(\'' + result.location + '\')" style="margin:3px">' + result.location + '</button>';
                });
                html += '</div>';
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        })
        .catch(err => {
            console.error('Search error:', err);
        });
}

function highlightBay(location) {
    // Extract aisle from location (e.g., "AA-05-4" -> "AA")
    const aisle = location.substring(0, 2);
    
    // Select the aisle
    selectAisle(aisle);
    
    // Scroll to bay grid
    setTimeout(() => {
        const bayCell = Array.from(document.querySelectorAll('.bay-cell')).find(cell => 
            cell.textContent.includes(location)
        );
        
        if (bayCell) {
            // Highlight the bay
            bayCell.style.animation = 'pulse 1s ease-in-out 3';
            bayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Flash effect
            const originalBg = bayCell.style.background;
            bayCell.style.background = '#fef3c7';
            setTimeout(() => {
                bayCell.style.background = originalBg;
            }, 2000);
        }
    }, 300);
}

function filterByStatus(status) {
    if (!status) {
        // Show all - reload normally
        if (selectedAisle) {
            selectAisle(selectedAisle);
        }
        return;
    }
    
    // Filter bays by status
    const filtered = allBays.filter(b => 
        b.display_status === status && 
        (!selectedAisle || b.aisle === selectedAisle)
    );
    
    if (filtered.length === 0) {
        document.getElementById('bay-grid').innerHTML = 
            '<p style="text-align:center;padding:40px;color:#666">No ' + status.replace('_', ' ') + ' bays found</p>';
        return;
    }
    
    // Display filtered bays
    const levels = [5, 4, 3, 2];
    let html = '<h3>' + (selectedAisle ? 'Aisle ' + selectedAisle + ' - ' : '') + status.replace('_', ' ').toUpperCase() + ' Bays</h3>';
    
    levels.forEach(level => {
        const levelBays = filtered.filter(b => b.level === level);
        if (levelBays.length > 0) {
            html += '<h4 style="margin-top:20px">Height ' + level + '</h4>';
            levelBays.forEach(bay => {
                html += '<div class="bay-cell ' + bay.display_status + '" onclick="handleBayClick(\'' + bay.location + '\',event)">' + bay.location + (bay.display_status === 'on_hold' ? '<br>ğŸ”’' : '') + '</div>';
            });
        }
    });
    
    document.getElementById('bay-grid').innerHTML = html;
}

function clearMapFilters() {
    document.getElementById('mapSearchInput').value = '';
    document.getElementById('bayNumberFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('mapSearchResults').style.display = 'none';
    
    // Reload current aisle or reset
    if (selectedAisle) {
        selectAisle(selectedAisle);
    } else {
        renderAisles();
        document.getElementById('bay-grid').innerHTML = '';
    }
}

// RECEIVING WORKFLOW FUNCTIONS
function uploadReceivingCSV(){
const fileInput = document.getElementById('receivingCSV');
const file = fileInput.files[0];
if(!file){
alert('Select a CSV file first');
return;
}

const reader = new FileReader();
reader.onload = function(e){
const content = e.target.result;
const lines = content.split('\n').filter(l => l.trim());

let startLine = 0;
const firstLine = lines[0].toLowerCase();
if(firstLine.includes('sku') || firstLine.includes('product') || firstLine.includes('quantity')){
startLine = 1;
}

const items = [];
for(let i = startLine; i < lines.length; i++){
const parts = lines[i].split(/,|\t/);
if(parts.length >= 2){
const sku = parts[0].trim();
const qty = parseInt(parts[1].trim());
if(sku && qty && qty > 0){
items.push({sku, qty});
}
}
}

if(items.length === 0){
alert('No valid SKUs found in CSV');
return;
}

processReceivingItems(items);
};
reader.readAsText(file);
}

function processReceiving(){
const input = document.getElementById('receivingInput').value.trim();
if(!input){
alert('Paste SKU list first');
return;
}

const lines = input.split('\n').filter(l => l.trim());
const items = [];

lines.forEach(line => {
const match = line.match(/([A-Za-z0-9\-_]+)\s*[xÃ—]?\s*(\d+)/i);
if(match){
items.push({
sku: match[1].trim(),
qty: parseInt(match[2])
});
}
});

if(items.length === 0){
alert('No valid SKUs found. Use format: SKU x Quantity');
return;
}

processReceivingItems(items);
}

function processReceivingItems(items){
document.getElementById('receivingResults').innerHTML='<p>Processing '+items.length+' items...</p>';

fetch(API+'/api/receiving/analyze', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({items})
}).then(r => r.json()).then(result => {
displayPutawayPlan(result);
});
}


function displayPutawayPlan(plan) {
    let html = '<div style="background:#d1fae5;padding:20px;border-radius:10px;margin-bottom:20px">';
    html += '<h3>âœ… Putaway Plan Generated</h3>';
    html += '<p><strong>' + plan.totalItems + ' items</strong> - Review locations below</p>';
    html += '</div>';

    if (plan.shelfItems && plan.shelfItems.length > 0) {
        html += '<div style="background:#f5f0e8;padding:20px;border-radius:10px;margin-bottom:20px">';
        html += '<h3>ğŸ“š Shelf Refills & Overflow (' + plan.shelfItems.length + ' items)</h3>';
        html += '<p style="font-size:13px;color:#666;margin-bottom:15px">ğŸ’¡ Enter how many units go to shelf. Remaining overflow will be palletized.</p>';

        plan.shelfItems.forEach((item, idx) => {
            html += '<div style="background:white;padding:15px;margin:10px 0;border-radius:8px;border:2px solid #e0d8cc">';
            html += '<div style="display:grid;grid-template-columns:2fr 1fr 2fr 2fr;gap:15px;align-items:center">';

            // SKU & Product
            html += '<div><strong style="font-size:16px">' + item.sku + '</strong><br><small style="color:#666">' + item.product_name + '</small></div>';

            // Total Qty
            html += '<div><strong style="font-size:20px;color:#059669">Ã—' + item.qty + '</strong><br><small>Total</small></div>';

            // Shelf allocation
            html += '<div>';
            html += '<label style="font-size:12px;color:#666">To Shelf:</label><br>';
            html += '<span class="location-badge shelf" style="display:block;margin-bottom:5px">' + item.existing_location + '</span>';
            html += '<input type="number" id="shelf_' + idx + '" value="' + item.qty + '" min="0" max="' + item.qty + '" style="width:100px;padding:8px;font-size:16px;font-weight:600" oninput="calculateOverflow(' + idx + ',' + item.qty + ')">';
            html += '</div>';

            // Overflow to pallet
            html += '<div>';
            html += '<label style="font-size:12px;color:#666">Overflow to Pallet:</label><br>';
            html += '<div id="overflow_' + idx + '" style="font-size:20px;font-weight:900;color:#dc2626;margin-top:5px">0</div>';
            html += '<div id="overflow_bay_' + idx + '" style="display:none;margin-top:10px;position:relative">';
            html += '<input type="text" id="pallet_bay_' + idx + '" placeholder="Type bay..." style="width:120px;padding:8px;font-size:14px;font-weight:600" oninput="suggestOverflowBays(' + idx + ')" autocomplete="off">';
            html += '<div id="bay_suggestions_' + idx + '" style="display:none;position:absolute;background:white;border:2px solid #e0d8cc;border-radius:5px;max-height:150px;overflow-y:auto;width:200px;z-index:100"></div>';
            html += '<div style="margin-top:5px">';
            html += '<button class="btn-small" onclick="confirmShelfAndOverflow(\'' + escapeJs(item.sku) + '\',\'' + escapeJs(item.product_name) + '\',\'' + escapeJs(item.existing_location) + '\',' + idx + ')">Confirm</button>';
            html += '<button class="btn-small btn-secondary" onclick="markAllToShelf(' + idx + ')">All to Shelf</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '</div></div>';
        });

        html += '</div>';
    }

    if (plan.palletItems && plan.palletItems.length > 0) {
        html += '<div style="background:#fee2e2;padding:20px;border-radius:10px;margin-bottom:20px">';
        html += '<h3>ğŸ“¦ Items Needing Pallet Bays (' + plan.palletItems.length + ' items)</h3>';
        html += '<p style="font-size:13px;margin-bottom:10px">ğŸ¯ These items have no shelf location - assign to pallet bays:</p>';

        plan.palletItems.forEach((item, idx) => {
            html += '<div style="background:white;padding:15px;margin:10px 0;border-radius:8px;border:2px solid #e0d8cc">';
            html += '<div style="display:grid;grid-template-columns:2fr 1fr 2fr 1fr;gap:15px;align-items:center">';
            html += '<div><strong style="font-size:16px">' + item.sku + '</strong><br><small style="color:#666">' + item.product_name + '</small></div>';
            html += '<div><strong style="font-size:20px;color:#059669">Ã—' + item.qty + '</strong></div>';
            html += '<div><label style="font-size:12px;color:#666">Suggested Bay:</label><br>';
            html += '<input type="text" id="bay_' + idx + '" value="' + item.suggested_bay + '" style="width:140px;padding:10px;font-size:16px;font-weight:600">';
            if (item.reason) html += '<br><small style="color:#059669">' + item.reason + '</small>';
            html += '</div>';
            html += '<div><button class="btn btn-small" onclick="confirmPalletReceiving(\'' + escapeJs(item.sku) + '\',\'' + escapeJs(item.product_name) + '\',' + item.qty + ',' + idx + ')">Confirm</button></div>';
            html += '</div></div>';
        });

        html += '</div>';
    }

    document.getElementById('receivingResults').innerHTML = html;

    // Initialize overflow calculations
    if (plan.shelfItems) {
        plan.shelfItems.forEach((item, idx) => {
            calculateOverflow(idx, item.qty);
        });
    }
}

function calculateOverflow(idx, totalQty){
const shelfQty = parseInt(document.getElementById('shelf_'+idx).value) || 0;
const overflow = totalQty - shelfQty;

document.getElementById('overflow_'+idx).innerHTML = overflow;

// Show/hide pallet bay input based on overflow
const overflowBayDiv = document.getElementById('overflow_bay_'+idx);
if(overflow > 0){
overflowBayDiv.style.display = 'block';
document.getElementById('overflow_'+idx).style.color = '#dc2626';
}else{
overflowBayDiv.style.display = 'none';
document.getElementById('overflow_'+idx).style.color = '#6b7280';
// Hide bay suggestions when overflow is 0
const suggestionsDiv = document.getElementById('bay_suggestions_'+idx);
if(suggestionsDiv) suggestionsDiv.style.display = 'none';
}
}
function confirmShelfAndOverflow(sku, productName, shelfLocation, idx){
const shelfQty = parseInt(document.getElementById('shelf_'+idx).value) || 0;
const overflowQty = parseInt(document.getElementById('overflow_'+idx).innerHTML);
const palletBay = document.getElementById('pallet_bay_'+idx).value.trim().toUpperCase();

if(overflowQty > 0 && !palletBay){
alert('Enter a pallet bay for the overflow stock');
return;
}

// Confirm shelf refill
if(shelfQty > 0){
alert('âœ… Add '+shelfQty+'x '+sku+' to shelf: '+shelfLocation);
// Could add API call here to update shelf quantity
}

// Confirm pallet overflow
if(overflowQty > 0 && palletBay){
fetch(API+'/api/bays/'+palletBay).then(r => {
if(!r.ok){
alert('Bay '+palletBay+' does not exist');
return;
}
return r.json();
}).then(data => {
if(!data) return;
fetch(API+'/api/bays/'+palletBay+'/add-sku', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({sku_code: sku, product_name: productName, quantity: overflowQty})
}).then(() => {
alert('âœ… Overflow: '+overflowQty+'x '+sku+' added to '+palletBay);
const elem = document.getElementById('shelf_'+idx).closest('div[style*="background:white"]');
if(elem) elem.style.opacity='0.3';
loadStats();
loadBaysData();
});
});
}else if(overflowQty === 0){
// All to shelf, mark as done
const elem = document.getElementById('shelf_'+idx).closest('div[style*="background:white"]');
if(elem) elem.style.opacity='0.3';
}
}
function suggestOverflowBays(idx){
const input = document.getElementById('pallet_bay_'+idx).value.toUpperCase().trim();
const suggestionsDiv = document.getElementById('bay_suggestions_'+idx);

if(input.length < 2){
suggestionsDiv.style.display = 'none';
return;
}

// Filter empty bays
const filtered = allBays.filter(b => 
b.location.includes(input) && b.display_status === 'empty'
).slice(0, 10);

if(filtered.length === 0){
suggestionsDiv.innerHTML = '<div style="padding:10px;color:#dc2626;font-size:12px">No empty bays match</div>';
suggestionsDiv.style.display = 'block';
return;
}

let html = '';
filtered.forEach(bay => {
html += '<div style="padding:8px;border-bottom:1px solid #e0d8cc;cursor:pointer;font-size:13px" onclick="selectOverflowBay('+idx+',\''+bay.location+'\')">'+bay.location+' <span style="color:#10b981;font-size:11px">â— Empty</span></div>';
});

suggestionsDiv.innerHTML = html;
suggestionsDiv.style.display = 'block';
}

function selectOverflowBay(idx, location){
document.getElementById('pallet_bay_'+idx).value = location;
document.getElementById('bay_suggestions_'+idx).style.display = 'none';
}

function markAllToShelf(idx){
const totalQty = parseInt(document.getElementById('shelf_'+idx).max);
document.getElementById('shelf_'+idx).value = totalQty;
calculateOverflow(idx, totalQty);

// Hide and fade out this item
const elem = document.getElementById('shelf_'+idx).closest('div[style*="background:white"]');
if(elem){
elem.style.opacity = '0.5';
elem.style.pointerEvents = 'none';
}

alert('âœ… All items marked for shelf - no pallet needed');
}
function deletePalletBay(){
const input = document.getElementById('deleteBayInput').value.trim().toUpperCase();
if(!input){
alert('Enter a bay location (e.g., AA-05-4 or AA-05 for all levels)');
return;
}

// Check if it's a specific bay or all levels
const isSpecific = input.includes('-') && input.split('-').length === 3;

let confirmMsg = '';
if(isSpecific){
confirmMsg = 'Delete bay '+input+'?';
}else{
confirmMsg = 'Delete ALL levels of '+input+' (levels 2, 3, 4, 5)?';
}

if(!confirm(confirmMsg + '\n\nâš ï¸ This cannot be undone!')){
return;
}

document.getElementById('deleteBayResults').innerHTML = '<p>Deleting...</p>';

fetch(API+'/api/admin/delete-bay', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({bay_location: input})
}).then(r => r.json()).then(result => {
if(result.success){
document.getElementById('deleteBayResults').innerHTML = '<p style="background:#d1fae5;padding:15px;border-radius:8px">âœ… Deleted '+result.deleted+' bay(s)</p>';
document.getElementById('deleteBayInput').value = '';
loadBaysData();
loadStats();
}else{
document.getElementById('deleteBayResults').innerHTML = '<p style="background:#fee2e2;padding:15px;border-radius:8px">âŒ '+result.error+'</p>';
}
});
}
// CYCLE COUNT FUNCTIONS
let currentCountData = null;

function searchSKUForCount(){
const term = document.getElementById('countSearchSKU').value.trim();
const suggestionsDiv = document.getElementById('skuCountSuggestions');

if(term.length < 2){
suggestionsDiv.innerHTML = '';
return;
}

fetch(API+'/api/skus/search?q='+encodeURIComponent(term)).then(r=>r.json()).then(results=>{
if(results.length === 0){
suggestionsDiv.innerHTML = '<div style="padding:10px;color:#666">No SKUs found</div>';
return;
}

let html = '';
results.forEach(sku => {
html += '<div style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer" onclick="selectSKUForCount(\''+sku.sku_code+'\',\''+sku.product_name+'\')">';
html += '<strong>'+sku.sku_code+'</strong>';
if(sku.product_name) html += '<br><small style="color:#666">'+sku.product_name+'</small>';
html += '</div>';
});

suggestionsDiv.innerHTML = html;
});
}

function selectSKUForCount(sku, name){
document.getElementById('countSearchSKU').value = sku;
document.getElementById('skuCountSuggestions').innerHTML = '';
currentCountData = {type: 'sku', sku: sku, name: name};
}

function startSKUCount(){
const sku = document.getElementById('countSearchSKU').value.trim().toUpperCase();
if(!sku){
alert('Enter a SKU to count');
return;
}

document.getElementById('countSheetArea').innerHTML = '<p>Loading count sheet...</p>';

fetch(API+'/api/cycle-count/sku/'+encodeURIComponent(sku)).then(r=>r.json()).then(data=>{
if(data.locations.length === 0){
document.getElementById('countSheetArea').innerHTML = '<div style="background:#fee2e2;padding:20px;border-radius:10px"><h3>âŒ SKU Not Found</h3><p>No locations found for '+sku+'</p></div>';
return;
}

displayCountSheet(data);
});
}

function startAisleCount(){
const aisle = document.getElementById('countAisleSelect').value;
if(!aisle){
alert('Select an aisle to count');
return;
}

document.getElementById('countSheetArea').innerHTML = '<p>Loading aisle count sheet...</p>';

fetch(API+'/api/cycle-count/aisle/'+aisle).then(r=>r.json()).then(data=>{
if(data.items.length === 0){
document.getElementById('countSheetArea').innerHTML = '<div style="background:#fee2e2;padding:20px;border-radius:10px"><h3>âŒ No Stock</h3><p>No stock found in aisle '+aisle+'</p></div>';
return;
}

displayAisleCountSheet(data);
});
}

function displayCountSheet(data){
let html = '<div style="background:#dbeafe;padding:20px;border-radius:10px;margin-bottom:20px">';
html += '<h3>ğŸ“‹ Count Sheet: '+data.sku+'</h3>';
html += '<p><strong>'+data.product_name+'</strong></p>';
html += '<p style="font-size:13px;color:#666;margin-top:5px">'+data.locations.length+' location(s) to count</p>';
html += '</div>';

html += '<div style="background:white;padding:20px;border-radius:10px">';
html += '<table style="width:100%"><tr><th>Location</th><th>Type</th><th>System Qty</th><th>Physical Count</th><th>Variance</th><th>Action</th></tr>';

data.locations.forEach((loc, idx) => {
html += '<tr id="count_row_'+idx+'">';
html += '<td><strong>'+loc.location+'</strong></td>';
html += '<td><span class="location-badge '+loc.location_type+'">'+loc.location_type+'</span></td>';
html += '<td><strong>'+(loc.quantity || 0)+'</strong></td>';
html += '<td><input type="number" id="physical_'+idx+'" min="0" style="width:80px;padding:8px" oninput="calculateVariance('+idx+','+(loc.quantity || 0)+')"></td>';
html += '<td><span id="variance_'+idx+'" style="font-weight:600">-</span></td>';
html += '<td><button class="btn-small" onclick="confirmCount(\''+data.sku+'\',\''+loc.location+'\','+idx+','+(loc.quantity || 0)+')">âœ“ Confirm</button></td>';
html += '</tr>';
});

html += '</table>';
html += '<div style="margin-top:20px;display:flex;gap:10px">';
html += '<button class="btn" onclick="exportCountSheet()">ğŸ“¥ Export to CSV</button>';
html += '<button class="btn btn-secondary" onclick="clearCountSheet()">Clear</button>';
html += '</div>';
html += '</div>';

document.getElementById('countSheetArea').innerHTML = html;
}

function displayAisleCountSheet(data){
let html = '<div style="background:#d1fae5;padding:20px;border-radius:10px;margin-bottom:20px">';
html += '<h3>ğŸ“‹ Aisle Count: '+data.aisle+'</h3>';
html += '<p style="font-size:13px;color:#666">'+data.items.length+' items to count</p>';
html += '</div>';

html += '<div style="background:white;padding:20px;border-radius:10px">';
html += '<table style="width:100%"><tr><th>SKU</th><th>Product</th><th>Location</th><th>System</th><th>Physical</th><th>Variance</th><th>Action</th></tr>';

data.items.forEach((item, idx) => {
html += '<tr id="count_row_'+idx+'">';
html += '<td><strong>'+item.sku_code+'</strong></td>';
html += '<td><small>'+item.product_name+'</small></td>';
html += '<td>'+item.location+'</td>';
html += '<td><strong>'+(item.quantity || 0)+'</strong></td>';
html += '<td><input type="number" id="physical_'+idx+'" min="0" style="width:80px;padding:8px" oninput="calculateVariance('+idx+','+(item.quantity || 0)+')"></td>';
html += '<td><span id="variance_'+idx+'" style="font-weight:600">-</span></td>';
html += '<td><button class="btn-small" onclick="confirmCount(\''+item.sku_code+'\',\''+item.location+'\','+idx+','+(item.quantity || 0)+')">âœ“</button></td>';
html += '</tr>';
});

html += '</table>';
html += '<div style="margin-top:20px">';
html += '<button class="btn" onclick="exportCountSheet()">ğŸ“¥ Export to CSV</button>';
html += '</div>';
html += '</div>';

document.getElementById('countSheetArea').innerHTML = html;
}

function calculateVariance(idx, systemQty){
const physical = parseInt(document.getElementById('physical_'+idx).value) || 0;
const variance = physical - systemQty;
const varianceSpan = document.getElementById('variance_'+idx);

if(variance === 0){
varianceSpan.innerHTML = '<span style="color:#059669">âœ“ Match</span>';
}else if(Math.abs(variance) / systemQty < 0.05){
varianceSpan.innerHTML = '<span style="color:#f59e0b">'+variance+'</span>';
}else{
varianceSpan.innerHTML = '<span style="color:#dc2626">'+variance+' âš ï¸</span>';
}
}

function confirmCount(sku, location, idx, systemQty){
const physical = parseInt(document.getElementById('physical_'+idx).value);
if(isNaN(physical)){
alert('Enter physical count');
return;
}

const variance = physical - systemQty;
const variancePercent = Math.abs(variance / systemQty * 100);

if(variancePercent > 10){
if(!confirm('Large variance detected: '+variance+' units ('+Math.round(variancePercent)+'%)\n\nAre you sure this count is correct?')){
return;
}
}

fetch(API+'/api/cycle-count/confirm', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
sku_code: sku,
location: location,
system_qty: systemQty,
physical_qty: physical,
variance: variance
})
}).then(r => r.json()).then(result => {
if(result.success){
const row = document.getElementById('count_row_'+idx);
row.style.background = '#d1fae5';
row.style.opacity = '0.6';
alert('âœ… Count confirmed for '+sku+' at '+location);
}
});
}

function exportCountSheet(){
alert('Export feature coming soon! For now, manually update Cin7 based on the counts.');
}

function clearCountSheet(){
document.getElementById('countSheetArea').innerHTML = '';
document.getElementById('countSearchSKU').value = '';
}
// ANALYTICS FUNCTIONS
function loadAnalytics(){
loadAnalyticsStats();
loadCapacityTrend();
loadAisleActivity();
loadSlowMovers();
}



function loadAnalytics() {
  // Load warehouse utilization
  fetch(API + '/api/stats')
    .then(r => r.json())
    .then(stats => {
      // Display utilization rate (guaranteed â‰¤100%)
      document.getElementById('utilizationRate').textContent = stats.utilization_percent + '%';
      
      // Show breakdown
      const breakdown = `${stats.occupied_bays} of ${stats.total_bays} bays occupied`;
      document.getElementById('utilizationRate').title = breakdown;
      
      console.log('âœ… Utilization:', stats.utilization_percent + '%', breakdown);
    })
    .catch(err => {
      console.error('Error loading stats:', err);
      document.getElementById('utilizationRate').textContent = '--';
    });
  
  // Load other analytics...
  loadCapacityTrend();
  loadSlowMovers();
}

function loadAnalyticsStats(){
fetch(API+'/api/analytics/stats').then(r=>r.json()).then(data=>{
document.getElementById('utilizationRate').innerHTML = data.utilizationRate+'%';
document.getElementById('totalMovements').innerHTML = data.totalMovements;
document.getElementById('uniqueSKUs').innerHTML = data.uniqueSKUs;
document.getElementById('slowMovers').innerHTML = data.slowMovers;
});
}
function loadCapacityTrend(){
fetch(API+'/api/analytics/capacity-trend')
.then(r => {
if(!r.ok) {
console.error('Capacity trend HTTP error:', r.status);
return r.text().then(text => {
console.error('Error response:', text);
throw new Error('HTTP error ' + r.status);
});
}
return r.json();
})
.then(data => {
console.log('Capacity trend data received:', data);
console.log('First data point:', JSON.stringify(data[0], null, 2));
console.log('All keys:', Object.keys(data[0]));

if(!Array.isArray(data)) {
console.error('Data is not an array:', typeof data, data);
document.getElementById('capacityTrendChart').innerHTML = '<p style="color:#dc2626">Invalid data format</p>';
return;
}

if(data.length === 0){
document.getElementById('capacityTrendChart').innerHTML = '<p style="color:#666">Not enough data yet. The system will automatically track daily capacity starting today!</p>';
return;
}

// Professional chart with Y-axis scale
let html = '<div style="display:flex;gap:10px;height:300px">';

// Y-axis labels (0-100%)
  html += '<p style="font-size:12px;color:#666;text-align:center;margin-top:15px">ğŸ“Š Daily warehouse capacity utilization - Last 10 days (Today: <strong>'+data[data.length-1].utilization_rate+'%</strong>)</p>';
for(let i = 100; i >= 0; i -= 10) {
html += '<div>'+i+'%</div>';
}
html += '</div>';

// Chart area with bars - FIXED HEIGHT CALCULATION
html += '<div style="flex:1;display:flex;align-items:flex-end;border-left:2px solid #e0d8cc;border-bottom:2px solid #e0d8cc;padding:20px 10px 20px 10px;position:relative;gap:'+Math.max(2, Math.floor(600/data.length))+'px;height:260px">';

// Background grid lines
html += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none;padding:20px 10px">';
for(let i = 0; i <= 10; i++) {
html += '<div style="border-top:1px solid #f0f0f0;width:100%"></div>';
}
html += '</div>';

const today = new Date().toISOString().split('T')[0];

// Data bars
data.forEach((point, idx) => {
const barHeight = point.utilization_rate || 0; // 0-100%
console.log('Point', idx, ':', point.week_start, '=', barHeight + '%');

// Parse date properly (YYYY-MM-DD format)
const dateParts = point.week_start.split('-');
const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
const dateStr = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
const isToday = point.week_start === today;

// Calculate actual pixel height based on 260px chart height
const pixelHeight = Math.max(2, (barHeight / 100) * 220); // 220px usable height (260 - 40 for padding)

html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;position:relative;z-index:1;min-width:20px">';
html += '<div style="font-size:11px;font-weight:600;color:#059669;margin-bottom:3px">'+barHeight+'%</div>';
html += '<div style="background:'+(isToday ? '#059669' : '#10b981')+';width:100%;height:'+pixelHeight+'px;border-radius:3px 3px 0 0;box-shadow:0 2px 4px rgba(0,0,0,0.1)"></div>';
html += '<div style="font-size:10px;color:#666;margin-top:8px;'+(data.length > 15 ? 'writing-mode:vertical-rl;transform:rotate(180deg);' : '')+'white-space:nowrap">'+(isToday ? 'â— ' : '')+dateStr+'</div>';
html += '</div>';
});

html += '</div>'; // Close chart area
html += '</div>'; // Close flex container

html += '<p style="font-size:12px;color:#666;text-align:center;margin-top:15px">ğŸ“Š Daily warehouse capacity utilization - Last 30 days (Today: <strong>'+data[data.length-1].utilization_rate+'%</strong>)</p>';

document.getElementById('capacityTrendChart').innerHTML = html;
})
.catch(err => {
console.error('Capacity trend error:', err);
document.getElementById('capacityTrendChart').innerHTML = '<p style="color:#dc2626">Error loading trend data: '+err.message+'</p>';
});
}
function loadAisleActivity(){
fetch(API+'/api/analytics/aisle-activity').then(r=>r.json()).then(data=>{
let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px">';
data.forEach(aisle => {
const barHeight = Math.max(5, (aisle.movements / data[0].movements) * 100);
html += '<div style="text-align:center">';
html += '<div style="font-size:24px;font-weight:900;color:#059669">'+aisle.movements+'</div>';
html += '<div style="background:#e5e7eb;height:100px;border-radius:5px;margin:10px 0;position:relative;display:flex;align-items:flex-end">';
html += '<div style="background:#10b981;width:100%;height:'+barHeight+'%;border-radius:5px"></div>';
html += '</div>';
html += '<div style="font-weight:600">Aisle '+aisle.aisle+'</div>';
html += '</div>';
});
html += '</div>';
document.getElementById('aisleActivityChart').innerHTML = html;
});
}

function loadSlowMovers(){
  document.getElementById('slowMoversTable').innerHTML = '<p>Loading...</p>';
  
  fetch(API+'/api/analytics/slow-movers')
    .then(r => r.json())
    .then(data => {
      if(data.length === 0){
        document.getElementById('slowMoversTable').innerHTML = 
          '<p style="color:#059669;text-align:center;padding:40px">âœ… No slow moving pallets found!</p>';
        return;
      }

      let html = '<table style="width:100%">';
      html += '<thead><tr>';
      html += '<th>Pallet Bay</th>';
      html += '<th>SKUs on Pallet</th>';
      html += '<th>Last Moved</th>';
      html += '<th>Days Idle</th>';
      html += '<th>Action</th>';
      html += '</tr></thead><tbody>';
      
      data.forEach(item => {
        const daysText = item.days_idle === 999 ? 'Never moved' : item.days_idle + ' days';
        const dateText = item.last_moved 
          ? new Date(item.last_moved).toLocaleDateString() 
          : 'Never';
        
        html += '<tr>';
        html += '<td><strong style="color:#c62828">'+escapeHtml(item.location)+'</strong></td>';
        html += '<td><span style="color:#666">'+item.sku_count+' SKU'+(item.sku_count > 1 ? 's' : '')+'</span></td>';
        html += '<td>'+dateText+'</td>';
        html += '<td><strong>'+daysText+'</strong></td>';
        html += '<td><button class="btn btn-small" onclick="viewBay(\''+escapeJs(item.location)+'\')">View Bay â†’</button></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      html += '<p style="font-size:13px;color:#666;margin-top:15px;text-align:center">ğŸ’¡ Tip: Consider relocating these pallets to less accessible areas to free up prime locations</p>';
      
      document.getElementById('slowMoversTable').innerHTML = html;
    })
    .catch(err => {
      console.error('Error loading slow movers:', err);
      document.getElementById('slowMoversTable').innerHTML = 
        '<p style="color:#dc2626">Error loading slow movers</p>';
    });
}


function suggestRelocation(sku, currentLocation){
alert('Relocation feature: Move '+sku+' from '+currentLocation+' to a more active area. Full relocation workflow coming soon!');
}


// ============================================
// SKU MANAGEMENT FUNCTIONS
// ============================================

function renameSKU(){
    const oldSKU = document.getElementById('oldSKU').value.trim().toUpperCase();
    const newSKU = document.getElementById('newSKU').value.trim().toUpperCase();
    const newProductName = document.getElementById('newProductName').value.trim();
    
    if(!oldSKU || !newSKU){
        alert('Enter both old and new SKU codes');
        return;
    }
    
    if(oldSKU === newSKU){
        alert('Old and new SKU are the same!');
        return;
    }
    
    if(!confirm(`Rename ${oldSKU} to ${newSKU} across entire warehouse?\n\nThis will update:\n- Pallet stock\n- Shelf stock\n- Hold locations\n- Bundles\n- Movement history`)){
        return;
    }
    
    document.getElementById('renameResult').innerHTML = '<p>Updating...</p>';
    
    fetch(API+'/api/admin/rename-sku', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_sku: oldSKU,
            new_sku: newSKU,
            new_product_name: newProductName || null
        })
    }).then(r => r.json()).then(result => {
        if(result.success){
            document.getElementById('renameResult').innerHTML = 
                `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                    <h4>âœ… SKU Renamed Successfully</h4>
                    <p><strong>${oldSKU}</strong> â†’ <strong>${newSKU}</strong></p>
                    <p>Updated ${result.changes} total records:</p>
                    <ul>
                        <li>Pallet: ${result.details.pallet}</li>
                        <li>Shelf: ${result.details.shelf}</li>
                        <li>Hold: ${result.details.hold}</li>
                        <li>Bundles: ${result.details.bundles}</li>
                    </ul>
                </div>`;
            
            // Clear inputs
            document.getElementById('oldSKU').value = '';
            document.getElementById('newSKU').value = '';
            document.getElementById('newProductName').value = '';
            
            loadStats();
        } else {
            document.getElementById('renameResult').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    }).catch(err => {
        document.getElementById('renameResult').innerHTML = 
            `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                <p>âŒ Error: ${err.message}</p>
            </div>`;
    });
}

function bulkUpdateSKUs(){
    const fileInput = document.getElementById('bulkSKUFile');
    const file = fileInput.files[0];
    
    if(!file){
        alert('Select a CSV file first');
        return;
    }
    
    if(!confirm(`Update multiple SKUs from ${file.name}?\n\nMake sure your CSV format is correct:\nOld SKU, New SKU, New Product Name`)){
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('bulkUpdateResult').innerHTML = '<p>Processing CSV...</p>';
    
    fetch(API+'/api/admin/bulk-update-skus', {
        method: 'POST',
        body: formData
    }).then(r => r.json()).then(result => {
        if(result.success){
            let html = `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                <h4>âœ… Bulk Update Complete</h4>
                <p>${result.message}</p>
                <p><strong>${result.successCount}</strong> SKUs updated successfully</p>`;
            
            if(result.errorCount > 0){
                html += `<p style="color:#dc2626"><strong>${result.errorCount}</strong> errors occurred</p>`;
                html += '<details><summary>Show errors</summary><ul>';
                result.errors.forEach(err => {
                    html += '<li style="font-size:12px">'+err+'</li>';
                });
                html += '</ul></details>';
            }
            
            html += '</div>';
            document.getElementById('bulkUpdateResult').innerHTML = html;
            
            // Clear file input
            fileInput.value = '';
            
            loadStats();
        } else {
            document.getElementById('bulkUpdateResult').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    }).catch(err => {
        document.getElementById('bulkUpdateResult').innerHTML = 
            `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                <p>âŒ Error: ${err.message}</p>
            </div>`;
    });
}

function addNewSKU(){
    const skuCode = document.getElementById('addNewSKUCode').value.trim().toUpperCase();
    const productName = document.getElementById('addNewSKUProduct').value.trim();
    const location = document.getElementById('addNewSKULocation').value.trim().toUpperCase();
    const locationType = document.getElementById('addNewSKUType').value;
    
    if(!skuCode || !productName || !location){
        alert('Fill in SKU code, product name, and location');
        return;
    }
    
    document.getElementById('addNewSKUResult').innerHTML = '<p>Adding...</p>';
    
    fetch(API+'/api/admin/add-new-sku', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            sku_code: skuCode,
            product_name: productName,
            location: location,
            location_type: locationType,
            quantity: null
        })
    }).then(r => r.json()).then(result => {
        if(result.success){
            document.getElementById('addNewSKUResult').innerHTML = 
                `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                    <p>âœ… ${result.message}</p>
                </div>`;
            
            // Clear inputs
            document.getElementById('addNewSKUCode').value = '';
            document.getElementById('addNewSKUProduct').value = '';
            document.getElementById('addNewSKULocation').value = '';
            
            loadStats();
        } else {
            document.getElementById('addNewSKUResult').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    });
}
// Deactivate SKU
function deactivateSKU() {
    const skuCode = document.getElementById('deactivateSKU').value.trim().toUpperCase();
    
    if (!skuCode) {
        alert('âš ï¸ Please enter a SKU code');
        return;
    }
    
    if (!confirm(`Deactivate ${skuCode}?\n\nThis will:\n- Hide it from searches\n- Prevent new stock additions\n- Keep existing stock intact\n\nYou can reactivate it later.`)) {
        return;
    }
    
    fetch(API + '/api/admin/deactivate-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: skuCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Deactivated ${skuCode}\n${result.records_affected} records updated`);
            document.getElementById('deactivateSKU').value = '';
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// Edit SKU
function editSKU() {
    const oldSKU = document.getElementById('editOldSKU').value.trim().toUpperCase();
    const newSKU = document.getElementById('editNewSKU').value.trim().toUpperCase();
    const newName = document.getElementById('editProductName').value.trim();
    
    if (!oldSKU) {
        alert('âš ï¸ Please enter the current SKU code');
        return;
    }
    
    if (!newSKU && !newName) {
        alert('âš ï¸ Please enter at least one change (new SKU code or product name)');
        return;
    }
    
    if (!confirm(`Update ${oldSKU}?\n\n${newSKU ? 'New SKU: ' + newSKU + '\n' : ''}${newName ? 'New Name: ' + newName : ''}`)) {
        return;
    }
    
    fetch(API + '/api/admin/edit-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            old_sku_code: oldSKU,
            new_sku_code: newSKU || null,
            new_product_name: newName || null
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Updated SKU\n${result.records_affected} records updated`);
            document.getElementById('editOldSKU').value = '';
            document.getElementById('editNewSKU').value = '';
            document.getElementById('editProductName').value = '';
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// Replace SKU everywhere
function replaceSKU() {
    const oldSKU = document.getElementById('replaceOldSKU').value.trim().toUpperCase();
    const newSKU = document.getElementById('replaceNewSKU').value.trim().toUpperCase();
    const newName = document.getElementById('replaceProductName').value.trim();
    
    if (!oldSKU || !newSKU) {
        alert('âš ï¸ Please enter both old and new SKU codes');
        return;
    }
    
    if (!confirm(`âš ï¸ WARNING: Replace ALL instances of ${oldSKU} with ${newSKU}?\n\nThis will update:\n- All stock locations\n- All inventory records\n- Cannot be undone!\n\nAre you sure?`)) {
        return;
    }
    
    fetch(API + '/api/admin/replace-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            old_sku_code: oldSKU,
            new_sku_code: newSKU,
            new_product_name: newName || null
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Replaced ${oldSKU} with ${newSKU}\n${result.records_affected} records updated`);
            document.getElementById('replaceOldSKU').value = '';
            document.getElementById('replaceNewSKU').value = '';
            document.getElementById('replaceProductName').value = '';
            loadStats();
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// View deactivated SKUs
function viewDeactivatedSKUs() {
    fetch(API + '/api/admin/deactivated-skus')
        .then(r => r.json())
        .then(skus => {
            displayDeactivatedSKUs(skus);
        })
        .catch(err => {
            alert('âŒ Error loading deactivated SKUs: ' + err.message);
        });
}

// Display deactivated SKUs
function displayDeactivatedSKUs(skus) {
    let html = '<h2>ğŸš« Deactivated SKUs</h2>';
    
    if (skus.length === 0) {
        html += '<p style="text-align:center;padding:40px;color:#666">No deactivated SKUs</p>';
    } else {
        html += `<p style="color:#666;margin:10px 0">${skus.length} deactivated SKU(s)</p>`;
        html += '<table style="width:100%;margin-top:20px">';
        html += '<tr><th>SKU</th><th>Product Name</th><th>Locations</th><th>Total Qty</th><th>Actions</th></tr>';
        
        skus.forEach(sku => {
            html += `<tr>
                <td><strong>${escapeHtml(sku.sku_code)}</strong></td>
                <td>${escapeHtml(sku.product_name || 'N/A')}</td>
                <td>${sku.location_count}</td>
                <td>${sku.total_quantity || 0}</td>
                <td>
                    <button class="btn btn-small" onclick="reactivateSKU('${escapeJs(sku.sku_code)}')" style="margin-right:5px">
                        âœ… Reactivate
                    </button>
                    <button class="btn btn-danger btn-small" onclick="permanentlyDeleteSKU('${escapeJs(sku.sku_code)}')">
                        ğŸ—‘ï¸ Delete
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</table>';
        
        html += `
        <div style="background:#fef3c7;padding:15px;margin-top:20px;border-radius:8px;border-left:4px solid #f59e0b">
            <strong>âš ï¸ Warning:</strong> Deleting a SKU permanently removes ALL records from the database. 
            This action cannot be undone. Stock will be removed from all locations.
        </div>`;
    }
    
    html += '<button class="btn btn-secondary" style="margin-top:20px" onclick="closeModal(\'deactivated-skus-modal\')">Close</button>';
    
    document.getElementById('deactivated-skus-content').innerHTML = html;
    document.getElementById('deactivated-skus-modal').classList.add('active');
}
// Permanently delete a deactivated SKU
function permanentlyDeleteSKU(skuCode) {
    if (!confirm(`âš ï¸ PERMANENTLY DELETE ${skuCode}?\n\nThis will:\n- Remove ALL stock records from all locations\n- Delete from pallet bays, shelves, and holds\n- CANNOT BE UNDONE\n\nAre you absolutely sure?`)) {
        return;
    }
    
    // Double confirmation for safety
    if (!confirm(`Final confirmation: Delete ${skuCode} forever?`)) {
        return;
    }
    
    fetch(API + '/api/admin/delete-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: skuCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Permanently deleted ${skuCode}\n${result.records_deleted} records removed`);
            viewDeactivatedSKUs(); // Refresh list
            loadStats(); // Update dashboard
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

// Reactivate SKU
function reactivateSKU(skuCode) {
    if (!confirm(`Reactivate ${skuCode}?\n\nThis will make it searchable and usable again.`)) {
        return;
    }
    
    fetch(API + '/api/admin/reactivate-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: skuCode })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Reactivated ${skuCode}`);
            viewDeactivatedSKUs(); // Refresh list
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

function findDuplicateSKUs(){
    document.getElementById('duplicatesResult').innerHTML = '<p>Searching for duplicates...</p>';
    
    fetch(API+'/api/admin/find-duplicate-skus').then(r => r.json()).then(result => {
        if(result.duplicates.length === 0){
            document.getElementById('duplicatesResult').innerHTML = 
                '<p style="color:#059669">âœ… No potential duplicates found!</p>';
            return;
        }
        
        let html = `<div style="background:#fef3c7;padding:15px;border-radius:8px;margin-top:10px">
            <h4>âš ï¸ Found ${result.duplicates.length} Potential Duplicate Groups</h4>
            <p style="font-size:13px;margin-bottom:10px">Review and merge if needed:</p>`;
        
        result.duplicates.forEach((group, idx) => {
            html += `<div style="background:white;padding:10px;margin:10px 0;border-radius:5px;border-left:4px solid #f59e0b">
                <strong>Group ${idx + 1}:</strong> ${group.skus.join(', ')}
                <br><small style="color:#666">${group.products.join(' | ')}</small>
                <br><button class="btn-small" onclick="promptMergeSKUs('${group.skus[0]}', '${group.skus.slice(1).join(',')}')">Merge These</button>
            </div>`;
        });
        
        html += '</div>';
        document.getElementById('duplicatesResult').innerHTML = html;
    });
}

function promptMergeSKUs(primary, duplicatesStr){
    const duplicates = duplicatesStr.split(',');
    
    if(!confirm(`Merge all into primary SKU: ${primary}?\n\nDuplicates: ${duplicates.join(', ')}\n\nThis will combine all quantities and update all references.`)){
        return;
    }
    
    fetch(API+'/api/admin/merge-skus', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            primary_sku: primary,
            duplicate_skus: duplicates
        })
    }).then(r => r.json()).then(result => {
        if(result.success){
            alert('âœ… ' + result.message);
            findDuplicateSKUs();
            loadStats();
        } else {
            alert('âŒ Error: ' + result.error);
        }
    });
}

let bundleComponentCount = 1;

function addBundleComponent(){
    const container = document.getElementById('bundleComponents');
    const newComp = document.createElement('div');
    newComp.style.cssText = 'display:grid;grid-template-columns:2fr 1fr auto;gap:10px;margin-bottom:5px';
    newComp.innerHTML = `
        <input type="text" id="bundleComp${bundleComponentCount}SKU" placeholder="Component SKU" style="padding:10px;text-transform:uppercase">
        <input type="number" id="bundleComp${bundleComponentCount}Qty" placeholder="Qty" min="1" style="padding:10px">
        <button class="btn-small btn-danger" onclick="this.parentElement.remove()">Remove</button>
    `;
    container.appendChild(newComp);
    bundleComponentCount++;
}

function createNewBundle(){
    const bundleCode = document.getElementById('newBundleCode').value.trim().toUpperCase();
    const bundleName = document.getElementById('newBundleName').value.trim();
    
    if(!bundleCode || !bundleName){
        alert('Enter bundle code and name');
        return;
    }
    
    // Collect all components
    const components = [];
    for(let i = 0; i < bundleComponentCount; i++){
        const skuInput = document.getElementById('bundleComp'+i+'SKU');
        const qtyInput = document.getElementById('bundleComp'+i+'Qty');
        
        if(skuInput && qtyInput){
            const sku = skuInput.value.trim().toUpperCase();
            const qty = parseInt(qtyInput.value);
            
            if(sku && qty > 0){
                components.push({ sku, quantity: qty });
            }
        }
    }
    
    if(components.length === 0){
        alert('Add at least one component');
        return;
    }
    
    document.getElementById('newBundleResult').innerHTML = '<p>Creating bundle...</p>';
    
    fetch(API+'/api/admin/add-bundle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            bundle_code: bundleCode,
            bundle_name: bundleName,
            components: components
        })
    }).then(r => r.json()).then(result => {
        if(result.success){
            document.getElementById('newBundleResult').innerHTML = 
                `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                    <p>âœ… ${result.message}</p>
                </div>`;
            
            // Clear inputs
            document.getElementById('newBundleCode').value = '';
            document.getElementById('newBundleName').value = '';
            document.getElementById('bundleComponents').innerHTML = `
                <div style="display:grid;grid-template-columns:2fr 1fr auto;gap:10px;margin-bottom:5px">
                    <input type="text" id="bundleComp0SKU" placeholder="Component SKU" style="padding:10px;text-transform:uppercase">
                    <input type="number" id="bundleComp0Qty" placeholder="Qty" min="1" style="padding:10px">
                    <button class="btn-small btn-secondary" onclick="addBundleComponent()">+ Add Component</button>
                </div>
            `;
            bundleComponentCount = 1;
            
            loadBundles();
        } else {
            document.getElementById('newBundleResult').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    });
}
function findStuckHolds(){
    document.getElementById('stuckHoldsResults').innerHTML = '<p>Scanning...</p>';
    
    fetch(API+'/api/admin/diagnose-holds-detailed').then(r=>r.json()).then(result => {
        const totalIssues = result.orphanedBays.length + result.emptyHolds.length + result.stockInWrongPlace.length;
        
        if(totalIssues === 0){
            document.getElementById('stuckHoldsResults').innerHTML = 
                '<p style="background:#d1fae5;padding:15px;border-radius:8px;color:#059669">âœ… No issues found! System is healthy.</p>';
            return;
        }
        
        let html = `<div style="background:#fef3c7;padding:15px;border-radius:8px">
            <h4>âš ï¸ Found ${totalIssues} Issues</h4>`;
        
        if(result.orphanedBays.length > 0){
            html += `<p><strong>Orphaned Bays (stuck on_hold):</strong> ${result.orphanedBays.length}</p>
                <ul style="font-size:12px;margin:5px 0">`;
            result.orphanedBays.forEach(b => {
                html += `<li>${b.bay} - ${b.has_stock ? 'Has stock ('+b.stock_count+' items)' : 'Empty'}</li>`;
            });
            html += '</ul>';
        }
        
        if(result.emptyHolds.length > 0){
            html += `<p><strong>Empty Holds:</strong> ${result.emptyHolds.length}</p>`;
        }
        
        if(result.stockInWrongPlace.length > 0){
            html += `<p><strong>Stock in Wrong Place:</strong> ${result.stockInWrongPlace.length}</p>`;
        }
        
        html += `<button class="btn btn-danger" onclick="fixStuckHolds()" style="margin-top:10px">Fix All ${totalIssues} Issues</button>
        </div>`;
        
        document.getElementById('stuckHoldsResults').innerHTML = html;
    });
}

// Auto-fix stuck holds
function fixStuckHolds(){
    if(!confirm('This will automatically repair all corrupted holds and bays.\n\nBackup recommended. Continue?')){
        return;
    }
    
    document.getElementById('stuckHoldsResults').innerHTML = '<p>Fixing...</p>';
    
fetch(API+'/api/admin/repair-holds', {
        method: 'POST'
    }).then(r=>r.json()).then(result => {
        if(result.success){
            document.getElementById('stuckHoldsResults').innerHTML = 
                `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                    <h4>âœ… ${result.message}</h4>
                    <p>Repaired ${result.fixed} corrupted entries</p>
                </div>`;
            
            loadStats();
            loadHolds();
            loadBaysData();
        } else {
            document.getElementById('stuckHoldsResults').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    });
}
function fixStuckHolds(){
    if(!confirm('This will repair all corrupted holds and bays.\n\nContinue?')){
        return;
    }
    
    document.getElementById('stuckHoldsResults').innerHTML = '<p>Repairing...</p>';
    
    fetch(API+'/api/admin/repair-orphaned-bays', {
        method: 'POST'
    }).then(r=>r.json()).then(result => {
        if(result.success){
            document.getElementById('stuckHoldsResults').innerHTML = 
                `<div style="background:#d1fae5;padding:15px;border-radius:8px">
                    <h4>âœ… ${result.message}</h4>
                </div>`;
            
            loadStats();
            loadHolds();
            loadBaysData();
        } else {
            document.getElementById('stuckHoldsResults').innerHTML = 
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${result.error}</p>
                </div>`;
        }
    });
}
// ============================================
// DATABASE BACKUP FUNCTIONS
// ============================================

function createBackup() {
    document.getElementById('backupStatus').innerHTML = '<p style="color:#0284c7">Creating backup...</p>';
    
    fetch(API + '/api/admin/backup-database', { method: 'POST' })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                document.getElementById('backupStatus').innerHTML = `
                    <div style="background:#d1fae5;padding:15px;border-radius:8px">
                        <h4>âœ… Backup Created Successfully!</h4>
                        <p><strong>Message:</strong> ${result.message}</p>
                    </div>`;
                if (document.getElementById('backupList').style.display !== 'none') {
                    loadBackupList();
                }
            } else {
                document.getElementById('backupStatus').innerHTML =
                    `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                        <p>âŒ Backup failed: ${result.error || 'Unknown error'}</p>
                    </div>`;
            }
        })
        .catch(err => {
            document.getElementById('backupStatus').innerHTML =
                `<div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${err.message}</p>
                </div>`;
        });
}

// Restore last active tab on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ WMS Loading...');
    
    // Get saved tab or default to dashboard
    let savedTab = 'dashboard';
    try {
        savedTab = localStorage.getItem('currentTab') || 'dashboard';
    } catch (e) {
        console.warn('Could not read from localStorage:', e);
    }
    
    // Verify the tab exists
    const tabExists = document.getElementById(savedTab);
    if (!tabExists) {
        console.warn('Saved tab not found:', savedTab, '- defaulting to dashboard');
        savedTab = 'dashboard';
    }
    
    // Switch to the tab
    setTimeout(() => {
        switchTab(savedTab);
        console.log('âœ… Loaded tab:', savedTab);
    }, 100);
    
    // Initialize dropdowns
    initializeDropdowns();
    
    // Start queue check
    checkShipStationStatus();
});

function initializeDropdowns() {
    const dropdowns = document.querySelectorAll('.dropdown');
    
    dropdowns.forEach(dropdown => {
        const toggle = dropdown.querySelector('.dropdown-toggle');
        
        if (!toggle) return;
        
        // Click handler
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Close other dropdowns
            dropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            
            // Toggle this dropdown
            dropdown.classList.toggle('open');
        });
        
        // Touch handler for mobile
        toggle.addEventListener('touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            dropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            
            dropdown.classList.toggle('open');
        }, { passive: false });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            dropdowns.forEach(d => d.classList.remove('open'));
        }
    });
    
    document.addEventListener('touchstart', function(e) {
        if (!e.target.closest('.dropdown')) {
            dropdowns.forEach(d => d.classList.remove('open'));
        }
    });
}

function loadBackupList(){
    const listDiv = document.getElementById('backupList');
    listDiv.style.display = 'block';
    listDiv.innerHTML = '<p>Loading backups...</p>';
    
    fetch(API+'/api/admin/list-backups').then(r => r.json()).then(result => {
        if(!result.backups || result.backups.length === 0){
            listDiv.innerHTML = '<p style="color:#666;text-align:center">No backups found yet. Create your first backup!</p>';
            return;
        }
        
        let html = '<h4 style="margin-bottom:15px">ğŸ“ Available Backups (' + result.backups.length + ')</h4>';
        html += '<div style="display:flex;flex-direction:column;gap:10px">';
        
        result.backups.forEach((backup, idx) => {
            const date = new Date(backup.created);
            const isToday = date.toDateString() === new Date().toDateString();
            const age = Math.floor((Date.now() - date) / (1000 * 60 * 60 * 24));
            
            html += `<div style="padding:12px;background:#f9f9f9;border-radius:5px;border-left:4px solid ${isToday ? '#10b981' : '#6b7280'}">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong>${backup.filename}</strong>
                        <br>
                        <span style="font-size:12px;color:#666">
                            ${date.toLocaleString()} â€¢ ${backup.size} â€¢ ${age === 0 ? 'Today' : age + ' days ago'}
                        </span>
                    </div>
                    <div style="display:flex;gap:5px">
                        <button class="btn-small" onclick="restoreBackup('${backup.filename}')" style="background:#0284c7">Restore</button>
                        <button class="btn-small btn-danger" onclick="deleteBackup('${backup.filename}')">Delete</button>
                    </div>
                </div>
            </div>`;
        });
        
        html += '</div>';
        listDiv.innerHTML = html;
    }).catch(err => {
        listDiv.innerHTML = `<p style="color:#dc2626">Error loading backups: ${err.message}</p>`;
    });
}

function restoreBackup(filename){
    if(!confirm(`âš ï¸ WARNING: Restore backup ${filename}?\n\nThis will REPLACE the current database with the backup.\nAll changes since the backup will be lost!\n\nContinue?`)){
        return;
    }
    
    if(!confirm('Are you ABSOLUTELY SURE? This cannot be undone!')){
        return;
    }
    
    fetch(API+'/api/admin/restore-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ filename: filename })
    }).then(r => r.json()).then(result => {
        if(result.success){
            alert('âœ… Backup restored successfully!\n\nThe page will now reload.');
            window.location.reload();
        } else {
            alert('âŒ Restore failed: ' + (result.error || 'Unknown error'));
        }
    }).catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}

function deleteBackup(filename){
    if(!confirm(`Delete backup ${filename}?\n\nThis backup will be permanently deleted.`)){
        return;
    }
    
    fetch(API+'/api/admin/delete-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ filename: filename })
    }).then(r => r.json()).then(result => {
        if(result.success){
            alert('âœ… Backup deleted');
            loadBackupList(); // Refresh the list
        } else {
            alert('âŒ Delete failed: ' + (result.error || 'Unknown error'));
        }
    }).catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}
function quickAdjustFromSearch(skuCode, location, locationType) {
    const modalHtml = `
        <h2>ğŸ“Š Adjust Quantity</h2>
        <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px">
            <strong>SKU:</strong> ${skuCode}<br>
            <strong>Location:</strong> ${location}
        </div>
        
        <div style="margin:20px 0">
            <label style="display:block;margin-bottom:10px;font-weight:600">New Quantity:</label>
            <input type="number" 
                   id="quickAdjustQty" 
                   min="0" 
                   placeholder="Enter new quantity" 
                   style="width:100%;padding:15px;font-size:18px;border:2px solid #e0d8cc;border-radius:8px"
                   autofocus>
        </div>
        
        <div style="margin:20px 0">
            <label style="display:block;margin-bottom:10px;font-weight:600">Reason (optional):</label>
            <input type="text" 
                   id="quickAdjustReason" 
                   placeholder="e.g., Stock take correction" 
                   style="width:100%;padding:12px;border:2px solid #e0d8cc;border-radius:8px">
        </div>
        
        <div style="display:flex;gap:10px">
            <button class="btn" onclick="confirmQuickAdjust('${skuCode}','${location}','${locationType}')">
                âœ“ Update Quantity
            </button>
            <button class="btn btn-secondary" onclick="closeModal('bay-modal')">
                Cancel
            </button>
        </div>
    `;
    
    document.getElementById('bay-details').innerHTML = modalHtml;
    document.getElementById('bay-modal').classList.add('active');
    
    setTimeout(() => {
        document.getElementById('quickAdjustQty').focus();
    }, 100);
}

function confirmQuickAdjust(skuCode, location, locationType) {
    const newQty = parseInt(document.getElementById('quickAdjustQty').value);
    const reason = document.getElementById('quickAdjustReason').value.trim();
    
    if(isNaN(newQty) || newQty < 0) {
        alert('Enter a valid quantity');
        return;
    }
    
    if(!confirm(`Update ${skuCode} at ${location} to ${newQty} units?`)) {
        return;
    }
    
    fetch(API + '/api/sku/adjust-quantity', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            sku_code: skuCode,
            location: location,
            location_type: locationType.replace('sku_', ''),
            new_quantity: newQty,
            reason: reason
        })
    }).then(r => r.json()).then(result => {
        if(result.success) {
            alert('âœ… Quantity updated successfully!');
            closeModal('bay-modal');
            loadStats();
            loadBaysData();
            
            // Refresh search results
            handleSearchInput();
        } else {
            alert('âŒ Error: ' + result.error);
        }
    });
}

function quickPrintLabel(location) {
    // Fetch bay contents
    fetch(API + '/api/bays/' + location).then(r => r.json()).then(data => {
        if(!data.skus || data.skus.length === 0) {
            alert('This bay is empty - nothing to print');
            return;
        }
        
        alert('Print label feature - coming soon!\n\nThis will print a label for ' + location + ' with ' + data.skus.length + ' items.');
    });
}
function loadProducts() {
    fetch(API + '/api/products')
        .then(r => r.json())
        .then(products => {
            displayProducts(products);
        })
        .catch(err => {
            console.error('Error loading products:', err);
        });
}


function displayProducts(products) {
    const container = document.getElementById('productsResults');
    if (!container) return;
    
    if (products.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px;background:#f9fafb;border-radius:10px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ“¦</div>
                <h3 style="color:#666">No Products Found</h3>
                <p style="color:#999;font-size:14px;margin-top:10px">Try a different search term</p>
            </div>`;
        return;
    }
    
    // Filter to show SHELF locations only (no pallet bays)
    const shelfProducts = products.filter(p => 
        p.location_type === 'shelf' || 
        !p.location.match(/^[A-Z]{2}-\d{2}-\d$/)
    );
    
    if (shelfProducts.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px;background:#f9fafb;border-radius:10px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ“š</div>
                <h3 style="color:#666">No Shelf Products</h3>
                <p style="color:#999;font-size:14px;margin-top:10px">Products found are in pallet bays only</p>
            </div>`;
        return;
    }
    
    let html = '<div style="display:grid;gap:15px">';
    
    shelfProducts.forEach(product => {
        const isArchived = product.archived === 1;
        const cardStyle = isArchived ? 
            'background:#f5f5f5;padding:20px;border-radius:10px;border:2px solid #d1d5db;opacity:0.7' : 
            'background:white;padding:20px;border-radius:10px;border:2px solid #e5e7eb;cursor:pointer;transition:all 0.2s';
        
        const hoverStyle = isArchived ? '' : 'onmouseover="this.style.borderColor=\'#c62828\'" onmouseout="this.style.borderColor=\'#e5e7eb\'"';
        
        html += `
            <div style="${cardStyle}" ${hoverStyle} ${!isArchived ? 'onclick="viewProductDetail(\'' + escapeJs(product.sku_code) + '\')"' : ''}>
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div style="flex:1">
                        <div style="font-size:18px;font-weight:700;color:#c62828;margin-bottom:5px">
                            ${escapeHtml(product.sku_code)}
                            ${isArchived ? '<span style="background:#6b7280;color:white;padding:3px 8px;border-radius:5px;font-size:11px;margin-left:10px">ğŸ—„ï¸ ARCHIVED</span>' : ''}
                        </div>
                        <div style="color:#666;margin:5px 0;font-size:14px">
                            ${escapeHtml(product.product_name || 'N/A')}
                        </div>
                        <div style="margin-top:10px">
                            <span class="location-badge shelf" style="font-size:13px">
                                ğŸ“š ${escapeHtml(product.location)}
                            </span>
                            ${product.quantity ? '<span style="font-size:13px;color:#059669;margin-left:10px;font-weight:600">Qty: Ã—' + product.quantity + '</span>' : ''}
                        </div>
                    </div>
                    
                    ${!isArchived ? '<div style="color:#059669;font-size:24px;margin-left:20px">â†’</div>' : ''}
                </div>
            </div>`;
    });
    
    html += '</div>';
    
    // Show count info
    if (products.length !== shelfProducts.length) {
        html = `<div style="background:#fffbeb;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #f59e0b">
            <strong>â„¹ï¸ Showing shelf products only:</strong> ${shelfProducts.length} of ${products.length} total products
        </div>` + html;
    }
    
    container.innerHTML = html;
}

function viewProductDetail(sku) {
    console.log('Loading product:', sku);
    
    // Search in allProducts array
    const productLocations = allProducts.filter(p => p.sku_code === sku);
    
    if (productLocations.length === 0) {
        alert('âŒ Product not found: ' + sku);
        return;
    }
    
    displayProductDetailModal(productLocations, sku);
}

function displayProductDetailModal(locations, sku) {
    const product = locations[0];
    const isArchived = product.archived === 1;
    
    // Separate shelf and pallet locations
    const shelfLocs = locations.filter(l => 
        l.location_type === 'shelf' || 
        !l.location.match(/^[A-Z]{2}-\d{2}-\d$/)
    );
    
    const palletLocs = locations.filter(l => 
        l.location_type === 'pallet' && 
        l.location.match(/^[A-Z]{2}-\d{2}-\d$/)
    );
    
    let html = `
        <h2>ğŸ“¦ ${escapeHtml(sku)}</h2>
        ${isArchived ? '<div style="background:#fee2e2;padding:10px;border-radius:5px;margin:10px 0;color:#dc2626"><strong>ğŸ—„ï¸ This product is archived</strong></div>' : ''}
        <p style="font-size:16px;color:#666;margin:10px 0 20px 0">
            ${escapeHtml(product.product_name || 'No description')}
        </p>`;
    
    // Shelf Home Location
    if (shelfLocs.length > 0) {
        html += `
            <div style="background:#d1fae5;padding:15px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 10px 0;font-size:16px;color:#065f46">ğŸ“š Shelf Home Location</h3>`;
        
        shelfLocs.forEach(loc => {
            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:white;border-radius:5px;margin:5px 0">
                    <div>
                        <strong style="font-size:18px;color:#c62828">${escapeHtml(loc.location)}</strong>
                        ${loc.quantity ? '<span style="margin-left:10px;color:#059669;font-weight:600">Ã—' + loc.quantity + '</span>' : ''}
                    </div>
                </div>`;
        });
        
        html += '</div>';
    }
    
    // Pallet Locations (Overflow)
    if (palletLocs.length > 0) {
        const totalPalletQty = palletLocs.reduce((sum, l) => sum + (l.quantity || 0), 0);
        
        html += `
            <div style="background:#fee2e2;padding:15px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 10px 0;font-size:16px;color:#991b1b">
                    ğŸ“¦ Pallet Overflow (${palletLocs.length} location${palletLocs.length > 1 ? 's' : ''})
                    ${totalPalletQty > 0 ? '<span style="margin-left:10px">Total: Ã—' + totalPalletQty + '</span>' : ''}
                </h3>`;
        
        palletLocs.forEach(loc => {
            html += `
                <div style="padding:8px;background:white;border-radius:5px;margin:5px 0;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong style="color:#c62828">${escapeHtml(loc.location)}</strong>
                        ${loc.quantity ? '<span style="margin-left:10px;color:#059669;font-weight:600">Ã—' + loc.quantity + '</span>' : ''}
                    </div>
                    <button class="btn-small" onclick="closeModal('bay-modal');setTimeout(function(){viewBay('${escapeJs(loc.location)}')},300)" 
                            style="background:#6366f1;padding:6px 12px">
                        ğŸ‘ï¸ View Bay
                    </button>
                </div>`;
        });
        
        html += '</div>';
    }
    
    // Actions
    html += '<div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">';
    
    if (!isArchived) {
        html += `<button class="btn" onclick="archiveSKU('${escapeJs(sku)}');closeModal('bay-modal');setTimeout(loadAllProducts,500)" style="background:#6b7280">
            ğŸ—„ï¸ Archive Product
        </button>`;
    } else {
        html += `<button class="btn" onclick="unarchiveSKU('${escapeJs(sku)}');closeModal('bay-modal');setTimeout(loadAllProducts,500)" style="background:#059669">
            â™»ï¸ Unarchive Product
        </button>`;
    }
    
    html += `<button class="btn btn-secondary" onclick="closeModal('bay-modal')">Close</button>`;
    html += '</div>';
    
    document.getElementById('bay-details').innerHTML = html;
    document.getElementById('bay-modal').classList.add('active');
}


// Load all products when tab opens
function loadAllProducts() {
    fetch(API + '/api/products/all')
        .then(r => r.json())
        .then(products => {
            allProducts = products; // Store globally
            displayProducts(products);
        })
        .catch(err => {
            console.error('Error loading products:', err);
            document.getElementById('productsResults').innerHTML = 
                '<p style="color:#dc2626;padding:20px">Error loading products</p>';
        });
}

// Update switchTab to load products
const originalSwitchTab2 = switchTab;
switchTab = function(tabName) {
    originalSwitchTab2(tabName);
    if (tabName === 'products') {
        loadAllProducts();
    }
};

// Auto-backup reminder on page load
function checkLastBackup(){
    fetch(API+'/api/admin/list-backups').then(r => r.json()).then(result => {
        if(result.backups && result.backups.length > 0){
            const lastBackup = new Date(result.backups[0].created);
            const daysSince = Math.floor((Date.now() - lastBackup) / (1000 * 60 * 60 * 24));
            
            if(daysSince >= 7){
                const reminder = document.createElement('div');
                reminder.style.cssText = 'position:fixed;top:20px;right:20px;background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:10000;max-width:300px';
                reminder.innerHTML = `
                    <strong>âš ï¸ Backup Reminder</strong><br>
                    <p style="font-size:13px;margin:5px 0">Last backup was ${daysSince} days ago</p>
                    <button class="btn-small" onclick="switchTab('admin');createBackup();this.parentElement.remove()" style="margin-top:5px">Backup Now</button>
                    <button class="btn-small btn-secondary" onclick="this.parentElement.remove()" style="margin-top:5px">Dismiss</button>
                `;
                document.body.appendChild(reminder);
            }
        }
    }).catch(err => {
        console.error('Backup check failed:', err);
    });
}

function escapeJs(text) {
    if (!text) return '';
    
    return String(text)
        .replace(/\\/g, '\\\\')   // Backslash
        .replace(/'/g, "\\'")      // Single quote
        .replace(/"/g, '&quot;')   // Double quote â†’ HTML entity
        .replace(/`/g, '\\`')      // Backtick
        .replace(/\n/g, '\\n')     // Newline
        .replace(/\r/g, '\\r')     // Carriage return
        .replace(/\t/g, '\\t');    // Tab
}

// Helper function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Helper function to escape for JavaScript strings in onclick
function escapeJs(text) {
  if (!text) return '';
  return String(text)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/"/g, '\\"')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r');
}

// Helper function for data attributes
function escapeForAttribute(text) {
  if (!text) return '';
  return String(text).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

// Helper function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Helper function to escape quotes for use in onclick attributes
function escapeForAttribute(text) {
  if (!text) return '';
  return String(text).replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// Helper function to escape for JavaScript strings
function escapeJs(text) {
  if (!text) return '';
  return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}
// Check for backup reminder 2 seconds after page load
setTimeout(checkLastBackup, 2000);


function switchTab(tab) {
    // Safety check - does this view exist?
    const viewElement = document.getElementById(tab);
    if (!viewElement) {
        console.error('âŒ Tab view not found:', tab);
        return;
    }
    
    // Remove active class from all tabs and views
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.dropdown-toggle').forEach(d => d.classList.remove('active'));
    
    // Close all mobile dropdowns
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
    
    // Find and activate the correct tab button
    const tabButton = document.querySelector('.tab[onclick*="' + tab + '"]');
    if (tabButton) {
        tabButton.classList.add('active');
    }
    
   // Highlight active dropdown based on tab
const dropdownMap = {
    'products': 'warehouse-toggle',
    'bundles': 'warehouse-toggle',
    'allocate': 'warehouse-toggle',
    'receiving': 'warehouse-toggle',
    'cyclecount': 'warehouse-toggle',
    'reports': 'admin-toggle',
    'analytics': 'admin-toggle',
    'labels': 'admin-toggle',
    'admin': 'admin-toggle'
};
    
    if (dropdownMap[tab]) {
        const dropdownToggle = document.getElementById(dropdownMap[tab]);
        if (dropdownToggle) {
            dropdownToggle.classList.add('active');
        }
    }
    
    // Activate the view
    viewElement.classList.add('active');
    
    // Save current tab to localStorage
    try {
        localStorage.setItem('currentTab', tab);
    } catch (e) {
        console.warn('Could not save tab to localStorage:', e);
    }
    
    // Load tab-specific content
    loadTabContent(tab);
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function loadTabContent(tab) {
    // Load data for specific tabs
    switch(tab) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'products':
            loadAllProducts();
            break;
        case 'bundles':
            loadBundles();
            break;
        case 'map':
            loadBaysData();
            break;
        case 'analytics':
            loadAnalytics();
            break;
        case 'build-pallet':
            loadStagingPallets();
            break;
        case 'allocate':
            loadAllocationQueue();
            break;
        case 'reports':
            document.getElementById('reportResults').innerHTML = 
                '<p style="text-align:center;color:#666;padding:40px">Select a report above to view data</p>';
            break;
        case 'receiving':
            document.getElementById('receivingResults').innerHTML = '';
            break;
    }
    
    // Auto-focus search input on search tab
    if (tab === 'search') {
        setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
        }, 100);
    }
}

// ============================================
// INLINE QUANTITY EDITING FUNCTIONS
// ============================================

function showQtyEditor(idx, currentQty, sku, location){
    document.getElementById('qty_display_'+idx).style.display='none';
    const editorDiv = document.getElementById('qty_editor_'+idx);
    editorDiv.style.display='block';
    
    const input = document.getElementById('qty_input_'+idx);
    input.focus();
    input.select();
    }

function cancelQtyEdit(idx, originalQty){
    document.getElementById('qty_display_'+idx).style.display='flex';
    document.getElementById('qty_editor_'+idx).style.display='none';
    document.getElementById('qty_input_'+idx).value = originalQty || 0;
    console.log('Cancelled edit');
}

function saveInlineQty(idx, skuCode, location){
    const newQty = parseInt(document.getElementById('qty_input_'+idx).value);
    
    if(isNaN(newQty) || newQty < 0){
        alert('âš ï¸ Enter a valid quantity (0 or higher)');
        return;
    }
    
    if(newQty === 0){
        if(!confirm('âš ï¸ Set quantity to 0?\n\nThis will remove '+skuCode+' from this bay.')){
            return;
        }
    }
    
    
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'â³';
    saveBtn.disabled = true;
    
    fetch(API+'/api/bays/'+location+'/update-qty', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            sku_code: skuCode,
            quantity: newQty
        })
    }).then(r => r.json()).then(result => {
        if(result.success){
            
            if(result.deleted){
                alert('âœ… '+skuCode+' removed from bay (quantity 0)');
                viewBay(location);
            }else{
                document.getElementById('qty_display_'+idx).innerHTML = newQty;
                document.getElementById('qty_display_'+idx).style.display='flex';
                document.getElementById('qty_editor_'+idx).style.display='none';
                
                const display = document.getElementById('qty_display_'+idx);
                display.style.color = '#059669';
                display.style.fontSize = '22px';
                setTimeout(() => { 
                    display.style.color = '#059669';
                    display.style.fontSize = '18px';
                }, 500);
                
                showToast('âœ… Quantity updated to '+newQty);
            }
            
            loadStats();
            loadBaysData();
            
        }else{
            console.error('âŒ Update failed:', result.error);
            alert('âŒ Failed to update quantity: '+(result.error||'Unknown error'));
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }).catch(err => {
        console.error('âŒ Update error:', err);
        alert('âŒ Error: '+err.message);
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// ============================================
// PRINT LABEL FROM BAY VIEW
// ============================================

function printBayLabelFromModal(location) {
    console.log('Generating label for', location);
    
    fetch(API + '/api/bays/' + location)
        .then(r => r.json())
        .then(data => {
            if (!data.bay) {
                alert('âŒ Bay not found');
                return;
            }
            
            // Create isolated print window
            createPrintWindow(data, location);
        })
        .catch(err => {
            console.error('Error loading bay for label:', err);
            alert('âŒ Error loading bay: ' + err.message);
        });
}

function createPrintWindow(data, location) {
    const printWindow = window.open('', '_blank', 'width=1000,height=800,menubar=no,toolbar=no,location=no,status=no');
    
    if (!printWindow) {
        alert('âŒ Please allow popups to print labels');
        return;
    }
    
    const stock = data.stock || [];
    const totalQty = stock.reduce((sum, s) => sum + (s.quantity || 0), 0);
    
    let stockHTML = '';
    if (stock.length > 0) {
        stockHTML = '<div style="font-size:18px;font-weight:700;color:#2c2c2c;margin-bottom:15px">ğŸ“¦ Contents: ' + stock.length + ' SKU' + (stock.length > 1 ? 's' : '') + '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px 25px;">';
        
        stock.forEach(s => {
            stockHTML += '<div style="border:2px solid #e0e0e0;padding:12px;border-radius:6px;background:#fafafa;display:flex;justify-content:space-between;align-items:center;">';
            stockHTML += '<div style="flex:1;"><div style="font-size:16px;font-weight:700;color:#2c2c2c;margin-bottom:4px;">' + s.sku_code + '</div>';
            stockHTML += '<div style="font-size:11px;color:#666;line-height:1.4;">' + (s.product_name || 'No description') + '</div></div>';
            
            if (s.quantity) {
                stockHTML += '<div style="margin-left:12px;text-align:right;"><div style="font-size:28px;font-weight:900;color:#059669;line-height:1;">Ã—' + s.quantity + '</div>';
                stockHTML += '<div style="font-size:9px;color:#999;margin-top:2px;">units</div></div>';
            }
            
            stockHTML += '</div>';
        });
        
        stockHTML += '</div>';
        
        if (totalQty > 0) {
            stockHTML += '<div style="margin-top:25px;padding-top:20px;border-top:3px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;">';
            stockHTML += '<div style="font-size:14px;color:#666;">Total Units in Bay</div>';
            stockHTML += '<div style="font-size:32px;font-weight:900;color:#059669;">' + totalQty + '</div></div>';
        }
    } else {
        stockHTML = '<div style="text-align:center;padding:80px 20px;background:#f9f9f9;border-radius:10px;">';
        stockHTML += '<div style="font-size:48px;color:#ccc;margin-bottom:15px;">ğŸ”­</div>';
        stockHTML += '<div style="font-size:32px;color:#999;font-weight:700;">EMPTY BAY</div>';
        stockHTML += '<div style="font-size:14px;color:#999;margin-top:10px;">Ready for stock allocation</div></div>';
    }
    
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', {weekday:'short', year:'numeric', month:'short', day:'numeric'});
    const timeStr = today.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
    
    const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Bay Label - ' + location + '</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;padding:20px;background:#f5f5f5}.label-container{border:5px solid #2c2c2c;padding:30px;background:white;max-width:900px;margin:20px auto;box-shadow:0 8px 24px rgba(0,0,0,0.15)}.no-print{text-align:center;margin:30px 0;padding:20px;background:#f5f5f5;border-radius:10px}.btn{background:#c62828;color:white;border:none;padding:15px 40px;font-size:18px;border-radius:8px;cursor:pointer;margin:5px}.btn:hover{background:#a02020}.btn-secondary{background:#6b7280}.btn-secondary:hover{background:#4b5563}@media print{body{background:white;padding:0}.label-container{box-shadow:none;margin:0;max-width:100%}.no-print{display:none!important}}</style></head><body><div class="label-container"><div style="display:flex;justify-content:space-between;align-items:center;border-bottom:4px solid #c62828;padding-bottom:20px;margin-bottom:25px;"><div><div style="font-size:72px;font-weight:900;letter-spacing:-3px;line-height:1;">' + location + '</div><div style="font-size:14px;color:#666;margin-top:8px;text-transform:uppercase;letter-spacing:1px;">Pallet Bay Location</div></div><div style="text-align:right;"><div style="font-size:16px;color:#c62828;font-weight:700;letter-spacing:1px;">ALTERNATIVE BREWING</div><div style="font-size:13px;color:#666;margin-top:6px;">' + dateStr + '</div><div style="font-size:12px;color:#999;margin-top:2px;">' + timeStr + '</div></div></div>' + stockHTML + '<div style="margin-top:30px;padding-top:20px;border-top:2px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#999;"><div>Warehouse Management System v2.0</div><div>Label Generated: ' + today.toLocaleString() + '</div></div></div><div class="no-print"><button class="btn" onclick="window.print()">ğŸ–¨ï¸ Print Label</button><button class="btn btn-secondary" onclick="window.close()">âœ• Close</button></div></body></html>';
    
    printWindow.document.write(html);
    printWindow.document.close();
}



// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(message, duration = 2000){
    const existing = document.getElementById('toast-notification');
    if(existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.id = 'toast-notification';
    toast.style.cssText = 'position:fixed;bottom:30px;right:30px;background:#059669;color:white;padding:15px 25px;border-radius:8px;font-size:15px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:10000;animation:slideIn 0.3s ease';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ============================================
// FIX PRODUCTS TAB
// ============================================

function loadProducts(){
    fetch(API+'/api/products').then(r=>r.json()).then(products=>{
        allProducts = products;
        displayProducts(products);
    }).catch(err => {
        console.error('Error loading products:', err);
        document.getElementById('productsResults').innerHTML = '<p style="color:#dc2626">Error loading products. Make sure the /api/products endpoint exists.</p>';
    });
}

// ============================================
// QUICK LOOKUP AUTOCOMPLETE
// ============================================

let searchTimeout = null;

function handleSearchInput() {
    const searchInput = document.getElementById('searchInput');
    const term = searchInput.value.trim();
    const suggestionsDiv = document.getElementById('searchSuggestions');
    
    // Clear previous timeout
    if(searchTimeout) clearTimeout(searchTimeout);
    
    // Hide suggestions if search is too short
    if(term.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    // Debounce: wait 300ms after user stops typing
    searchTimeout = setTimeout(() => {
        fetchSearchSuggestions(term, suggestionsDiv);
    }, 300);
}

function fetchSearchSuggestions(term, suggestionsDiv) {
    // Search for SKUs, products, and locations
    fetch(API + '/api/skus/search?q=' + encodeURIComponent(term))
        .then(r => r.json())
        .then(results => {
            if(results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            displaySearchSuggestions(results, suggestionsDiv, term);
        })
        .catch(err => {
            console.error('Autocomplete error:', err);
            suggestionsDiv.style.display = 'none';
        });
}

function displaySearchSuggestions(results, suggestionsDiv, searchTerm) {
    let html = '';
    
    // Group results by type
    const skuResults = results.slice(0, 10); // Top 10 results
    
    html += '<div style="padding:10px;background:#f5f0e8;font-weight:600;border-bottom:2px solid #e0d8cc">Search Results</div>';
    
    skuResults.forEach(result => {
        html += '<div class="autocomplete-suggestion" onclick="selectSearchSuggestion(\'' + result.sku_code + '\')" style="padding:12px;border-bottom:1px solid #e0d8cc;cursor:pointer">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center">';
        html += '<div>';
        html += '<strong style="font-size:15px">' + highlightMatch(result.sku_code, searchTerm) + '</strong>';
        if(result.product_name) {
            html += '<br><small style="color:#666">' + highlightMatch(result.product_name, searchTerm) + '</small>';
        }
        html += '</div>';
        html += '<div style="font-size:12px;color:#059669">â†’</div>';
        html += '</div>';
        html += '</div>';
    });
    
    // Add "Press Enter to search all" hint
    html += '<div style="padding:12px;background:#f9f9f9;text-align:center;font-size:12px;color:#666;border-top:2px solid #e0d8cc">';
    html += 'ğŸ’¡ Press <strong>Enter</strong> to search all locations';
    html += '</div>';
    
    suggestionsDiv.innerHTML = html;
    suggestionsDiv.style.display = 'block';
}

function highlightMatch(text, searchTerm) {
    if(!text) return '';
    const regex = new RegExp('(' + searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
    return text.replace(regex, '<mark style="background:#fef3c7;padding:2px 4px;border-radius:3px">$1</mark>');
}

function selectSearchSuggestion(sku) {
    document.getElementById('searchInput').value = sku;
    document.getElementById('searchSuggestions').style.display = 'none';
    performSearch();
}

function performSearch() {
  const query = document.getElementById('searchInput').value.trim();
  
  if (!query || query.length < 2) {
    document.getElementById('searchResults').innerHTML = 
      '<p style="color:#666;padding:20px">Enter at least 2 characters to search</p>';
    return;
  }
  
  document.getElementById('searchResults').innerHTML = 
    '<p style="padding:20px">ğŸ” Searching...</p>';
  
  fetch(API + '/api/search?q=' + encodeURIComponent(query))
    .then(r => {
      if (!r.ok) {
        throw new Error('Server returned ' + r.status);
      }
      return r.json();
    })
    .then(results => {
      console.log('Search results:', results); // DEBUG
      displaySearchResults(results);
    })
    .catch(err => {
      console.error('Search error:', err);
      document.getElementById('searchResults').innerHTML = 
        '<p style="color:#dc2626;padding:20px">âŒ Search failed: ' + err.message + '</p>';
    });
}
// Quick archive from admin panel
function archiveSKUQuick() {
    const skuCode = document.getElementById('archiveSKUCode').value.trim().toUpperCase();
    const reason = document.getElementById('archiveReason').value.trim();
    
    if (!skuCode) {
        alert('âš ï¸ Please enter a SKU code');
        return;
    }
    
    fetch(API + '/api/admin/archive-sku', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: skuCode, reason: reason })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert(`âœ… Archived ${skuCode}\nThis SKU will be blocked from future imports`);
            document.getElementById('archiveSKUCode').value = '';
            document.getElementById('archiveReason').value = '';
        } else {
            alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
    });
}
// ============================================
// SHIPSTATION INTEGRATION FUNCTIONS
// ============================================

function testShipStation() {
    document.getElementById('shipstationStatus').innerHTML = '<p style="color:#0284c7">Testing connection...</p>';
    
    fetch(API + '/api/shipstation/test')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                document.getElementById('shipstationStatus').innerHTML = `
                    <div style="background:#d1fae5;padding:15px;border-radius:8px">
                        <h4>âœ… Connection Successful!</h4>
                        <p><strong>Stores found:</strong> ${result.stores}</p>
                        <ul style="margin:10px 0 0 20px;font-size:13px">
                            ${result.storeList.map(s => '<li>' + s.storeName + ' (ID: ' + s.storeId + ')</li>').join('')}
                        </ul>
                    </div>`;
            } else {
                document.getElementById('shipstationStatus').innerHTML = `
                    <div style="background:#fee2e2;padding:15px;border-radius:8px">
                        <p>âŒ Connection failed: ${result.error}</p>
                    </div>`;
            }
        })
        .catch(err => {
            document.getElementById('shipstationStatus').innerHTML = `
                <div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${err.message}</p>
                </div>`;
        });
}

function syncFromShipStation() {
    if (!confirm('Import all products from ShipStation?\n\nThis will:\nâ€¢ Add new products with locations\nâ€¢ Update existing product names\nâ€¢ Queue products without locations for allocation')) {
        return;
    }
    
    document.getElementById('shipstationStatus').innerHTML = '<p style="color:#0284c7;font-size:16px">â³ Syncing products... this may take 1-2 minutes...</p>';
    
    fetch(API + '/api/shipstation/sync-products', { method: 'POST' })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                let html = `
                    <div style="background:#d1fae5;padding:15px;border-radius:8px">
                        <h4>âœ… Sync Complete!</h4>
                        <p style="font-size:15px;margin:10px 0"><strong>${result.message}</strong></p>
                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:15px">
                            <div style="background:white;padding:15px;border-radius:8px;text-align:center">
                                <div style="font-size:32px;font-weight:900;color:#059669">${result.imported}</div>
                                <div style="font-size:12px;color:#666">New Imported</div>
                            </div>
                            <div style="background:white;padding:15px;border-radius:8px;text-align:center">
                                <div style="font-size:32px;font-weight:900;color:#0284c7">${result.updated}</div>
                                <div style="font-size:12px;color:#666">Updated</div>
                            </div>
                            <div style="background:white;padding:15px;border-radius:8px;text-align:center">
                                <div style="font-size:32px;font-weight:900;color:#f59e0b">${result.toAllocate || 0}</div>
                                <div style="font-size:12px;color:#666">To Allocate</div>
                            </div>
                            <div style="background:white;padding:15px;border-radius:8px;text-align:center">
                                <div style="font-size:32px;font-weight:900;color:#6b7280">${result.skipped}</div>
                                <div style="font-size:12px;color:#666">Skipped</div>
                            </div>
                            <div style="background:white;padding:15px;border-radius:8px;text-align:center">
                                <div style="font-size:32px;font-weight:900;color:#6b7280">${result.total}</div>
                                <div style="font-size:12px;color:#666">Total</div>
                            </div>
                        </div>`;
                
                if (result.toAllocate > 0) {
                    html += `<div style="background:#fef3c7;padding:15px;margin-top:15px;border-radius:8px;border-left:4px solid #f59e0b">
                        <strong>ğŸ“¦ ${result.toAllocate} products need locations!</strong><br>
                        <a href="#" onclick="switchTab('allocate'); return false;" style="color:#0284c7;font-weight:600">Go to Allocation Queue â†’</a>
                    </div>`;
                }
                
                if (result.errors && result.errors.length > 0) {
                    html += `<details style="margin-top:15px;background:#fee2e2;padding:10px;border-radius:5px">
                        <summary style="cursor:pointer;font-weight:600">âš ï¸ ${result.errors.length} Errors</summary>
                        <ul style="margin:10px 0 0 20px;font-size:12px">
                            ${result.errors.slice(0, 10).map(e => '<li>'+e+'</li>').join('')}
                        </ul>
                    </details>`;
                }
                
                html += `</div>`;
                document.getElementById('shipstationStatus').innerHTML = html;
                
                // Refresh stats
                loadStats();
                
                // Update allocation badge
                if (result.toAllocate > 0) {
                    updateTabBadge('allocate', result.toAllocate);
                }
            } else {
                document.getElementById('shipstationStatus').innerHTML = `
                    <div style="background:#fee2e2;padding:15px;border-radius:8px">
                        <p>âŒ Sync failed: ${result.error}</p>
                    </div>`;
            }
        })
        .catch(err => {
            document.getElementById('shipstationStatus').innerHTML = `
                <div style="background:#fee2e2;padding:15px;border-radius:8px">
                    <p>âŒ Error: ${err.message}</p>
                </div>`;
        });
}
// ============================================
// ALLOCATION QUEUE FUNCTIONS
// ============================================

let allocationData = [];

function loadAllocationQueue() {
  fetch(API + '/api/allocation/pending')
    .then(r => r.json())
    .then(items => {
      displayAllocationQueue(items);
    })
    .catch(err => {
      console.error('Error loading allocation queue:', err);
      document.getElementById('allocationQueue').innerHTML = 
        '<p style="color:#dc2626;text-align:center;padding:20px">Error loading allocation queue</p>';
    });
}

// Archive item from allocation queue
function archiveAllocationItem(skuCode) {
  if (!confirm(`Archive ${skuCode}?\n\nThis will block it from future ShipStation imports.`)) {
    return;
  }
  
  fetch(API + '/api/sku/archive', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sku_code: skuCode })
  })
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('âœ… ' + skuCode + ' archived');
        loadAllocationQueue();
      } else {
        alert('âŒ Failed to archive: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Error archiving SKU:', err);
      alert('âŒ Error: ' + err.message);
    });
}

function displayAllocationQueue(items) {
  const container = document.getElementById('allocationQueue');
  
  if (items.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px;background:white;border-radius:10px">
        <h3 style="color:#059669">âœ… All products allocated!</h3>
        <p style="color:#666">No products awaiting warehouse location assignment.</p>
      </div>`;
    return;
  }
  
  // Update stats
  document.getElementById('allocationStats').innerHTML = `
    <div style="background:#dbeafe;padding:20px;border-radius:8px;text-align:center">
      <div style="font-size:32px;font-weight:900;color:#1e40af">${items.length}</div>
      <div style="font-size:14px;color:#666">Pending Allocation</div>
    </div>
  `;
  
  let html = '';
  
  items.forEach(item => {
    html += `
      <div class="allocation-item" style="border:2px solid #e0d8cc;border-radius:10px;padding:20px;margin:15px 0;background:white">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">
          <div style="flex:1">
            <strong style="font-size:18px;color:#2c5f2d">${escapeHtml(item.sku_code)}</strong><br>
            <span style="color:#666;font-size:14px">${escapeHtml(item.product_name || 'No product name')}</span><br>
            <small style="color:#999">Added: ${new Date(item.created_at).toLocaleString()}</small>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="display:block;font-size:13px;color:#666;margin-bottom:5px">Location</label>
            <input type="text" 
              id="location-${item.sku_code.replace(/[^a-zA-Z0-9]/g, '_')}" 
              placeholder="e.g. AA-12-2 or SHELF-A05"
              style="width:100%;padding:10px;border:2px solid #e0d8cc;border-radius:5px">
          </div>
          
          <div>
            <label style="display:block;font-size:13px;color:#666;margin-bottom:5px">Quantity (optional)</label>
            <input type="number" 
              id="qty-${item.sku_code.replace(/[^a-zA-Z0-9]/g, '_')}" 
              placeholder="Leave blank for pallet"
              style="width:100%;padding:10px;border:2px solid #e0d8cc;border-radius:5px">
          </div>
        </div>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" onclick="allocateItem('${escapeJs(item.sku_code)}')" style="background:#059669">
            âœ… Allocate
          </button>
          <button class="btn btn-secondary" onclick="archiveAllocationItem('${escapeJs(item.sku_code)}')">
            ğŸ—„ï¸ Archive
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function archiveSKUFromAllocation(sku, index) {
    if (!confirm(`Archive ${sku}?\n\nThis will:\nâ€¢ Mark it as archived\nâ€¢ Remove it from allocation queue\nâ€¢ Prevent it from syncing from ShipStation in the future`)) {
        return;
    }
    
    const itemDiv = document.getElementById('alloc_' + index);
    itemDiv.style.opacity = '0.5';
    
    // First archive the SKU
    fetch(API + '/api/sku/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: sku })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            // Then remove from allocation queue
            return fetch(API + '/api/allocation/skip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sku_code: sku })
            });
        } else {
            throw new Error(result.error || 'Archive failed');
        }
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            // Success animation
            itemDiv.style.transition = 'all 0.3s ease';
            itemDiv.style.background = '#d1d5db';
            itemDiv.style.transform = 'translateX(-100%)';
            itemDiv.style.opacity = '0';
            
            setTimeout(() => {
                loadAllocationQueue();
                showToast('ğŸ—„ï¸ ' + sku + ' archived - will not sync again');
            }, 300);
        } else {
            throw new Error(result.error || 'Skip failed');
        }
    })
    .catch(err => {
        alert('âŒ Error archiving: ' + err.message);
        itemDiv.style.opacity = '1';
    });
}

function updateAllocationStats(items) {
    const total = items.length;
    const today = items.filter(i => {
        const created = new Date(i.created_at);
        const now = new Date();
        return created.toDateString() === now.toDateString();
    }).length;
    
    const html = `
        <div style="background:white;padding:20px;border-radius:8px;border:2px solid #e5e7eb;text-align:center">
            <div style="font-size:36px;font-weight:900;color:#c62828">${total}</div>
            <div style="font-size:13px;color:#666;margin-top:5px">Total Pending</div>
        </div>
        <div style="background:white;padding:20px;border-radius:8px;border:2px solid #e5e7eb;text-align:center">
            <div style="font-size:36px;font-weight:900;color:#f59e0b">${today}</div>
            <div style="font-size:13px;color:#666;margin-top:5px">Imported Today</div>
        </div>
        <div style="background:white;padding:20px;border-radius:8px;border:2px solid #e5e7eb;text-align:center">
            <div style="font-size:36px;font-weight:900;color:#059669">0</div>
            <div style="font-size:13px;color:#666;margin-top:5px">Allocated Today</div>
        </div>`;
    
    document.getElementById('allocationStats').innerHTML = html;
    
    // Update tab badge
    updateTabBadge('allocate', total);
}

function allocateItem(skuCode) {
  const cleanSku = skuCode.replace(/[^a-zA-Z0-9]/g, '_');
  const locationInput = document.getElementById('location-' + cleanSku);
  const qtyInput = document.getElementById('qty-' + cleanSku);
  
  if (!locationInput) {
    alert('âŒ Error: Input fields not found');
    return;
  }
  
  const location = locationInput.value.trim().toUpperCase();
  const quantity = qtyInput ? parseInt(qtyInput.value) || null : null;
  
  if (!location) {
    alert('âš ï¸ Please enter a location');
    locationInput.focus();
    return;
  }
  
  // Determine location type
  let locationType = 'shelf';
  if (location.match(/^[A-Z]{2}-\d{2}-\d$/)) {
    locationType = 'pallet';
  }
  
  fetch(API + '/api/allocation/assign', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sku_code: skuCode,
      location: location,
      location_type: locationType,
      quantity: quantity
    })
  })
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('âœ… ' + skuCode + ' allocated to ' + location);
        loadAllocationQueue();
      } else {
        alert('âŒ Failed to allocate: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Error allocating:', err);
      alert('âŒ Error: ' + err.message);
    });
}
function skipItem(sku, index) {
    if (!confirm('Skip ' + sku + '?\n\nThis will remove it from the allocation queue.')) {
        return;
    }
    
    const itemDiv = document.getElementById('alloc_' + index);
    itemDiv.style.opacity = '0.5';
    
    fetch(API + '/api/allocation/skip', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku_code: sku })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            itemDiv.style.transition = 'all 0.3s ease';
            itemDiv.style.transform = 'translateX(-100%)';
            itemDiv.style.opacity = '0';
            
            setTimeout(() => {
                loadAllocationQueue();
                showToast('â­ï¸ Skipped ' + sku);
            }, 300);
        } else {
            alert('âŒ Failed to skip: ' + result.error);
            itemDiv.style.opacity = '1';
        }
    });
}

function skipAllVisible() {
    const count = allocationData.length;
    
    if (!confirm(`Skip all ${count} visible items?\n\nThis will remove them from the allocation queue.`)) {
        return;
    }
    
    let completed = 0;
    
    allocationData.forEach(item => {
        fetch(API + '/api/allocation/skip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sku_code: item.sku_code })
        })
        .then(() => {
            completed++;
            if (completed === count) {
                loadAllocationQueue();
                showToast('âœ… Skipped ' + count + ' items');
            }
        });
    });
}
function displaySearchResults(data) {
    const container = document.getElementById('searchResults');
    
    // Handle both formats: object with properties OR flat array
    let shelf_locations = [];
    let pallet_locations = [];
    
    if (Array.isArray(data)) {
        // Server returned flat array - split it
        shelf_locations = data.filter(r => r.location_type === 'shelf');
        pallet_locations = data.filter(r => r.location_type === 'pallet');
    } else if (data && typeof data === 'object') {
        // Server returned object with properties
        shelf_locations = data.shelf_locations || [];
        pallet_locations = data.pallet_locations || [];
    } else {
        // Invalid data
        container.innerHTML = `
            <div style="text-align:center;padding:60px;color:#dc2626">
                <h3>âŒ Error</h3>
                <p>Invalid search results format</p>
            </div>`;
        return;
    }
    
    if (shelf_locations.length === 0 && pallet_locations.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px;color:#666">
                <h3>No results found</h3>
                <p>Try searching by SKU code or product name</p>
            </div>`;
        return;
    }
    
    let html = '<div style="margin-top:20px">';
    
    // ===== SHELF LOCATIONS FIRST (INFO ONLY - NOT CLICKABLE) =====
    if (shelf_locations.length > 0) {
        html += `
            <div style="background:#d1fae5;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #059669">
                <h3 style="margin:0 0 10px 0">ğŸ“š Shelf Home Locations</h3>
                <p style="font-size:13px;color:#666;margin-bottom:10px">Primary picking location (reference only)</p>`;
        
        shelf_locations.forEach(item => {
            html += `
                <div style="background:white;padding:12px;border-radius:5px;margin:5px 0;cursor:default">
                    <strong>${escapeHtml(item.sku_code)}</strong> â€” ${escapeHtml(item.product_name || 'N/A')}<br>
                    <span style="color:#059669;font-weight:600">ğŸ“ ${escapeHtml(item.location)}</span>
                    ${item.quantity ? ` â€¢ <span style="color:#666">Qty: ${item.quantity}</span>` : ''}
                </div>`;
        });
        
        html += `</div>`;
    }
    
    // ===== PALLET LOCATIONS AFTER (CLICKABLE) =====
    if (pallet_locations.length > 0) {
        html += `
            <div style="background:#dbeafe;padding:15px;border-radius:8px;border-left:4px solid #2563eb">
                <h3 style="margin:0 0 10px 0">ğŸ“¦ Pallet Bay Locations</h3>
                <p style="font-size:13px;color:#666;margin-bottom:10px">Click to view/edit bay contents</p>`;
        
        // Sort pallet locations by bay ID
        const sortedPallets = pallet_locations.sort((a, b) => {
            return a.location.localeCompare(b.location);
        });
        
        sortedPallets.forEach(item => {
            html += `
                <div class="result-item" onclick="viewBay('${escapeJs(item.location)}')" 
                     style="cursor:pointer;transition:all 0.2s">
                    <div style="display:flex;justify-content:space-between;align-items:start">
                        <div style="flex:1">
                            <strong>${escapeHtml(item.sku_code)}</strong> â€” ${escapeHtml(item.product_name || 'N/A')}<br>
                            <span style="color:#2563eb;font-weight:600">ğŸ“¦ ${escapeHtml(item.location)}</span>
                            ${item.quantity ? ` â€¢ <span style="color:#666">Qty: ${item.quantity}</span>` : ''}
                        </div>
                        <button class="btn btn-small" onclick="event.stopPropagation();viewBay('${escapeJs(item.location)}')">
                            View Bay â†’
                        </button>
                    </div>
                </div>`;
        });
        
        html += `</div>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}
function suggestBayForItem(index, sku) {
    fetch(API + '/api/allocation/suggest-bay')
        .then(r => r.json())
        .then(bays => {
            if (bays.length === 0) {
                alert('âš ï¸ No empty bays available');
                return;
            }
            
            // Use the first suggested bay (best option)
            const bestBay = bays[0];
            document.getElementById('location_' + index).value = bestBay.location;
            
            // Auto-select pallet type
            document.getElementById('type_pallet_' + index).checked = true;
            
            // Visual feedback
            const input = document.getElementById('location_' + index);
            input.style.background = '#d1fae5';
            setTimeout(() => {
                input.style.background = 'white';
            }, 1000);
            
            showToast('ğŸ’¡ Suggested: ' + bestBay.location + ' (Aisle ' + bestBay.aisle + ', Level ' + bestBay.level + ')');
        })
        .catch(err => {
            alert('âŒ Error getting suggestions: ' + err.message);
        });
}

function showLocationSuggestions(index) {
    const input = document.getElementById('location_' + index);
    const term = input.value.trim();
    const suggestionsDiv = document.getElementById('suggestions_' + index);
    
    if (term.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    // Search both pallet bays and existing shelf locations
    fetch(API + '/api/skus/search?q=' + encodeURIComponent(term))
        .then(r => r.json())
        .then(results => {
            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Get unique locations
            const locations = [...new Set(results.map(r => r.location || r.sku_code))].slice(0, 8);
            
            let html = '<div style="background:white;border:2px solid #e5e7eb;border-radius:5px;max-height:200px;overflow-y:auto;position:absolute;width:100%;z-index:100;margin-top:5px;box-shadow:0 4px 12px rgba(0,0,0,0.1)">';
            
            locations.forEach(loc => {
                html += `<div class="autocomplete-suggestion" onclick="selectLocationSuggestion(${index}, '${loc}')" style="padding:10px;border-bottom:1px solid #e5e7eb;cursor:pointer">${loc}</div>`;
            });
            
            html += '</div>';
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        });
}

function selectLocationSuggestion(index, location) {
    document.getElementById('location_' + index).value = location;
    document.getElementById('suggestions_' + index).style.display = 'none';
    
    // Auto-detect location type
    if (location.match(/^[A-Z]{2}-\d{2}-\d$/)) {
        document.getElementById('type_pallet_' + index).checked = true;
    } else {
        document.getElementById('type_shelf_' + index).checked = true;
    }
}

function filterAllocationQueue() {
    const searchTerm = document.getElementById('allocateSearch').value.toLowerCase();
    
    if (!searchTerm) {
        displayAllocationQueue(allocationData);
        return;
    }
    
    const filtered = allocationData.filter(item => 
        item.sku_code.toLowerCase().includes(searchTerm) ||
        (item.product_name && item.product_name.toLowerCase().includes(searchTerm))
    );
    
    displayAllocationQueue(filtered);
}

function updateTabBadge(tabName, count) {
    // Find the allocate button in the Warehouse dropdown
    const allocateBtn = document.querySelector('button[onclick*="allocate"]');
    
    if (!allocateBtn) return;
    
    if (count > 0) {
        // Add badge
        const badgeHTML = `ğŸ“ Allocate <span style="background:#dc2626;color:white;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:5px;font-weight:700">${count}</span>`;
        allocateBtn.innerHTML = badgeHTML;
    } else {
        // Remove badge
        allocateBtn.innerHTML = 'ğŸ“ Allocate';
    }
}

// Auto-load allocation queue when tab is opened
const originalSwitchTab = switchTab;
switchTab = function(tabName) {
    originalSwitchTab(tabName);
    if (tabName === 'allocate') {
        loadAllocationQueue();
    }
};
// ============================================
// QUICK EDIT FROM SEARCH RESULTS
// ============================================

function quickEditFromSearch(location) {
    
    fetch(API + '/api/bays/' + location)
        .then(r => r.json())
        .then(data => {
            displayQuickEdit(data, location);
        })
        .catch(err => {
            console.error('Error loading bay for quick edit:', err);
            alert('âŒ Error loading bay: ' + err.message);
        });
}

function displayQuickEdit(data, location) {
    const bay = data.bay;
    const stock = data.stock || [];
    
    let html = `
        <h2>âš¡ Quick Edit: ${location}</h2>
        <p style="background:#e0f2fe;padding:12px;border-radius:6px;margin-bottom:20px;font-size:14px">
            <strong>ğŸ’¡ Tip:</strong> Adjust quantities below and click Save. Set to 0 to remove an item.
        </p>`;
    
    if (stock.length === 0) {
        html += `
            <div style="text-align:center;padding:40px;background:#f5f5f5;border-radius:8px">
                <p style="font-size:48px;margin-bottom:10px">ğŸ“­</p>
                <p style="color:#666;font-size:16px">No stock in this bay</p>
                <button class="btn" onclick="closeModal('quick-edit-modal');viewBay('${location}')" 
                        style="margin-top:20px">
                    â• Add Stock
                </button>
            </div>`;
    } else {
        html += `
        <div style="background:#f9fafb;border-radius:8px;padding:20px;margin-bottom:20px">
            <table style="width:100%">
                <thead>
                    <tr style="border-bottom:2px solid #e5e7eb">
                        <th style="text-align:left;padding:10px;font-size:13px;color:#666">SKU</th>
                        <th style="text-align:left;padding:10px;font-size:13px;color:#666">Product</th>
                        <th style="text-align:center;padding:10px;font-size:13px;color:#666">Quantity</th>
                        <th style="text-align:center;padding:10px;font-size:13px;color:#666">Actions</th>
                    </tr>
                </thead>
                <tbody id="quick-edit-items">`;
        
        stock.forEach((item, idx) => {
            html += `
                <tr style="border-bottom:1px solid #e5e7eb" id="qe_row_${idx}">
                    <td style="padding:12px;font-weight:700;color:#c62828;font-size:15px">${item.sku_code}</td>
                    <td style="padding:12px;font-size:13px;color:#333">${item.product_name || 'N/A'}</td>
                    <td style="padding:12px;text-align:center">
                        <input type="number" 
                               id="qe_qty_${idx}" 
                               value="${item.quantity || 0}" 
                               min="0"
                               data-original="${item.quantity || 0}"
                               style="width:80px;padding:8px;font-size:16px;font-weight:700;text-align:center;border:2px solid #e5e7eb;border-radius:5px">
                    </td>
                    <td style="padding:12px;text-align:center">
                        <button class="btn-small btn-danger" 
                                onclick="quickDeleteSKU('${location}', '${item.sku_code}', ${idx})"
                                style="padding:8px 12px">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </td>
                </tr>`;
        });
        
        html += `
                </tbody>
            </table>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:20px;border-top:2px solid #e5e7eb">
            <button class="btn btn-secondary" onclick="closeModal('quick-edit-modal')" style="padding:12px 24px">
                âœ• Cancel
            </button>
            <button class="btn" onclick="saveQuickEdits('${location}', ${stock.length})" 
                    style="background:#059669;padding:12px 24px;font-size:16px">
                âœ… Save All Changes
            </button>
        </div>`;
    }
    
    document.getElementById('quick-edit-content').innerHTML = html;
    document.getElementById('quick-edit-modal').classList.add('active');
}

function saveQuickEdits(location, itemCount) {
    let changes = [];
    let hasChanges = false;
    
    // Collect all changes
    for (let i = 0; i < itemCount; i++) {
        const input = document.getElementById('qe_qty_' + i);
        if (!input) continue;
        
        const newQty = parseInt(input.value);
        const originalQty = parseInt(input.dataset.original);
        
        if (newQty !== originalQty) {
            hasChanges = true;
            const row = document.getElementById('qe_row_' + i);
            const sku = row.querySelector('td:first-child').textContent.trim();
            changes.push({ sku, quantity: newQty });
        }
    }
    
    if (!hasChanges) {
        showToast('â„¹ï¸ No changes to save');
        closeModal('quick-edit-modal');
        return;
    }
    
    // Show saving state
    const saveBtn = event.target;
    saveBtn.disabled = true;
    saveBtn.innerHTML = 'â³ Saving...';
    
    // Save each change
    let completed = 0;
    let errors = 0;
    
    changes.forEach(change => {
        fetch(API + '/api/bays/' + location + '/update-qty', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sku_code: change.sku,
                quantity: change.quantity
            })
        })
        .then(r => r.json())
        .then(result => {
            if (!result.success) {
                console.error('Update failed:', change.sku, result.error);
                errors++;
            }
            
            completed++;
            
            if (completed === changes.length) {
                if (errors === 0) {
                    showToast('âœ… Saved ' + changes.length + ' changes');
                    closeModal('quick-edit-modal');
                    
                    // Refresh search results if we're on search tab
                    if (document.getElementById('search').classList.contains('active')) {
                        searchSKUs();
                    }
                    
                    loadStats();
                } else {
                    alert('âš ï¸ Some updates failed. Check console for details.');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'âœ… Save All Changes';
                }
            }
        })
        .catch(err => {
            console.error('Error saving:', err);
            errors++;
            completed++;
            
            if (completed === changes.length) {
                alert('âŒ Save failed: ' + err.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'âœ… Save All Changes';
            }
        });
    });
}

function quickDeleteSKU(location, sku, rowIndex) {
    if (!confirm(`Remove ${sku} from ${location}?`)) {
        return;
    }
    
    const row = document.getElementById('qe_row_' + rowIndex);
    row.style.opacity = '0.5';
    
    fetch(API + '/api/bays/' + location + '/sku/' + sku, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            row.style.transition = 'all 0.3s ease';
            row.style.transform = 'translateX(-100%)';
            row.style.opacity = '0';
            
            setTimeout(() => {
                row.remove();
                showToast('âœ… Removed ' + sku);
                
                // Check if table is now empty
                const tbody = document.getElementById('quick-edit-items');
                if (tbody.children.length === 0) {
                    closeModal('quick-edit-modal');
                    showToast('â„¹ï¸ Bay is now empty');
                }
            }, 300);
        } else {
            alert('âŒ Failed to remove: ' + result.error);
            row.style.opacity = '1';
        }
    })
    .catch(err => {
        alert('âŒ Error: ' + err.message);
        row.style.opacity = '1';
    });
}
// Handle keyboard navigation in search suggestions
document.addEventListener('keydown', function(e) {
    const suggestionsDiv = document.getElementById('searchSuggestions');
    if(!suggestionsDiv || suggestionsDiv.style.display === 'none') return;
    
    const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
    if(suggestions.length === 0) return;
    
    let currentIndex = -1;
    suggestions.forEach((s, i) => {
        if(s.classList.contains('active')) currentIndex = i;
    });
    
    if(e.key === 'ArrowDown') {
        e.preventDefault();
        suggestions.forEach(s => s.classList.remove('active'));
        const nextIndex = (currentIndex + 1) % suggestions.length;
        suggestions[nextIndex].classList.add('active');
        suggestions[nextIndex].style.background = '#f5f0e8';
    } else if(e.key === 'ArrowUp') {
        e.preventDefault();
        suggestions.forEach(s => s.classList.remove('active'));
        const prevIndex = currentIndex <= 0 ? suggestions.length - 1 : currentIndex - 1;
        suggestions[prevIndex].classList.add('active');
        suggestions[prevIndex].style.background = '#f5f0e8';
    } else if(e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        suggestions[currentIndex].click();
    } else if(e.key === 'Escape') {
        suggestionsDiv.style.display = 'none';
    }
});

</script>
<div id="create-pallet-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('create-pallet-modal')">Ã—</button>
        <div id="create-pallet-content">
            <h2>Create New Pallet</h2>
            <div class="form-group">
                <label>Pallet Code:</label>
                <input type="text" id="new-pallet-code" class="form-input" 
                       placeholder="STG-YYYYMMDD-###" 
                       style="font-family:monospace;font-size:18px;font-weight:600">
                <small style="color:#666;font-size:12px">Format: STG-YYYYMMDD-### (auto-generated)</small>
            </div>
            <div style="margin-top:20px;display:flex;gap:10px">
                <button class="btn" onclick="saveNewPallet()">Create Pallet</button>
                <button class="btn btn-secondary" onclick="closeModal('create-pallet-modal')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- ARCHIVED SKUs MODAL -->
<div id="archived-skus-modal" class="modal">
  <div class="modal-content" style="max-width:900px">
    <button class="modal-close" onclick="closeModal('archived-skus-modal')">Ã—</button>
    <div id="archived-skus-content">
      <h2>ğŸ—„ï¸ Archived SKUs</h2>
      <p>Loading...</p>
    </div>
  </div>
</div>


<div id="add-sku-modal" class="modal">
    <div class="modal-content" style="max-width:600px">
        <span class="close" onclick="closeModal('add-sku-modal')">&times;</span>
        <div id="add-sku-content"></div>
    </div>
</div>

<div id="pallet-details-modal" class="modal">
    <div class="modal-content" style="max-width:800px">
        <span class="close" onclick="closeModal('pallet-details-modal')">&times;</span>
        <div id="pallet-details-content"></div>
    </div>
</div>

<div id="bay-suggestions-modal" class="modal">
    <div class="modal-content" style="max-width:600px">
        <span class="close" onclick="closeModal('bay-suggestions-modal')">&times;</span>
        <div id="bay-suggestions-content"></div>
    </div>
</div>

</body>
</html>
